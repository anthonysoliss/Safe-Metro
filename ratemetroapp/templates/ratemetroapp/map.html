{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rate Metro</title>
<script>
  (function(){var t=localStorage.getItem('ratemetro-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})();
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0d0d18;
    --surface: rgba(20, 20, 35, 0.88);
    --surface-light: rgba(28, 28, 48, 0.82);
    --accent: #f5c518;
    --accent-glow: rgba(245, 197, 24, 0.3);
    --danger: #ff3b30;
    --text-primary: #f0f0f5;
    --text-secondary: rgba(255, 255, 255, 0.55);
    --text-muted: rgba(255, 255, 255, 0.3);
    --border: rgba(255, 255, 255, 0.07);
    --chat-bg: rgba(14, 14, 26, 0.92);
  }

  [data-theme="light"] {
    --bg-dark: #f2f2f7;
    --surface: rgba(255, 255, 255, 0.95);
    --surface-light: rgba(240, 240, 245, 0.9);
    --accent: #d4a017;
    --accent-glow: rgba(212, 160, 23, 0.2);
    --danger: #ff3b30;
    --text-primary: #1c1c1e;
    --text-secondary: rgba(0, 0, 0, 0.55);
    --text-muted: rgba(0, 0, 0, 0.35);
    --border: rgba(0, 0, 0, 0.1);
    --chat-bg: rgba(255, 255, 255, 0.95);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    -webkit-font-smoothing: antialiased;
  }

  #map {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 1;
  }
  .leaflet-container { background: #121218; }
  [data-theme="light"] .leaflet-container { background: #e8e8ed; }

  .leaflet-tile-pane { filter: brightness(0.65) contrast(1.1) saturate(1.4); }
  [data-theme="light"] .leaflet-tile-pane { filter: none; }
  .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }

  /* ── Hamburger Nav ── */
  .hamburger-nav {
    position: fixed;
    top: 16px; left: 16px;
    z-index: 1002;
    width: 44px; height: 44px;
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
    animation: slideDown 0.5s ease both;
  }
  .hamburger-nav:hover { background: var(--surface-light); border-color: var(--accent); }
  .hamburger-nav.open { border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
  .hamburger-bar {
    width: 18px; height: 2px;
    background: var(--text-secondary);
    border-radius: 2px;
    transition: all 0.25s ease;
  }
  .hamburger-nav.open .hamburger-bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  .hamburger-nav.open .hamburger-bar:nth-child(2) { opacity: 0; transform: scaleX(0); }
  .hamburger-nav.open .hamburger-bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

  /* ── Nav Drawer ── */

  /* ── Station Pill ── */
  .station-pill {
    position: fixed;
    top: 16px; left: 68px;
    z-index: 1001;
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    height: 44px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    animation: slideDown 0.5s ease both;
    user-select: none;
  }
  .station-pill:hover { background: var(--surface-light); }
  .station-pill.active { border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
  .station-pill .dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--accent-glow);
    animation: pulse-dot 2s ease infinite;
  }
  .station-pill span {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.8px;
    text-transform: uppercase;
  }
  .station-pill .chevron { transition: transform 0.3s ease; stroke: var(--text-muted); }
  .station-pill.active .chevron { transform: rotate(180deg); }

  /* ── Station Panel ── */
  .station-panel {
    position: fixed;
    top: 70px; left: 68px;
    z-index: 6000;
    width: 320px;
    max-height: calc(100vh - 260px);
    background: var(--surface);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-10px) scale(0.97);
    pointer-events: none;
    transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: opacity, transform;
    box-shadow: 0 16px 48px rgba(0,0,0,0.5);
  }
  .station-panel.open {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  .panel-header { padding: 16px 16px 0; position: relative; }
  .panel-search {
    width: 100%;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px 10px 36px;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .panel-search:focus { border-color: rgba(245,197,24,0.4); }
  .panel-search::placeholder { color: var(--text-muted); }
  .search-icon {
    position: absolute;
    top: 26px; left: 28px;
    width: 16px; height: 16px;
    stroke: var(--text-muted);
    fill: none;
    stroke-width: 2;
    pointer-events: none;
  }

  /* ── Line Filter Chips ── */
  .line-filters {
    display: flex;
    gap: 6px;
    padding: 12px 16px;
    overflow-x: auto;
    scrollbar-width: none;
    flex-shrink: 0;
  }
  .line-filters::-webkit-scrollbar { display: none; }

  .line-chip {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1.5px solid transparent;
    background: rgba(255,255,255,0.05);
    color: var(--text-secondary);
    user-select: none;
    text-transform: uppercase;
  }
  .line-chip .chip-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .line-chip:hover { background: rgba(255,255,255,0.1); }
  .line-chip.active {
    background: rgba(255,255,255,0.1);
    color: var(--text-primary);
  }
  .line-chip.all-chip.active {
    border-color: var(--accent);
    background: rgba(245,197,24,0.12);
    color: var(--accent);
  }

  /* ── Station List ── */
  .station-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    touch-action: pan-y;
    padding: 0 8px 12px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  .station-list::-webkit-scrollbar { width: 4px; }
  .station-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

  .station-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .station-item:hover { background: rgba(255,255,255,0.06); }
  .station-item:active { background: rgba(255,255,255,0.1); transform: scale(0.99); }

  .station-color-bar {
    width: 4px;
    height: 32px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .station-info { flex: 1; min-width: 0; }
  .station-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .station-line-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    margin-top: 2px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  .station-line-badge {
    display: inline-flex;
    align-items: center;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .station-arrow {
    width: 16px; height: 16px;
    stroke: var(--text-muted);
    fill: none;
    stroke-width: 2;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .station-item:hover .station-arrow { opacity: 1; }

  .station-count {
    padding: 8px 16px;
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .no-results {
    padding: 32px 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
  }

  /* ── Coordinates ── */
  .coords-display {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%) translateY(-6px);
    z-index: 1000;
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease, transform 0.25s ease;
  }
  .coords-display.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(0);
  }
  .coords-display .coord-icon { 
    width: 14px; 
    height: 14px; 
    fill: none; 
    stroke: var(--accent); 
    stroke-width: 2; 
    flex-shrink: 0; 
  }
  .coords-display .coord-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    line-height: 1.2;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
  }
  .coords-display .coord-text strong { color: var(--text-primary); font-weight: 500; }

  /* ── Profile ── */
  .profile-btn {
    position: fixed;
    top: 16px; right: 16px;
    z-index: 1000;
    width: 44px; height: 44px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    animation: slideDown 0.5s ease 0.2s both;
    overflow: hidden;
  }
  .profile-btn:hover { background: var(--surface-light); border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
  .profile-btn svg { width: 20px; height: 20px; fill: none; stroke: var(--text-secondary); stroke-width: 1.8; }
  .profile-btn:hover svg { stroke: var(--accent); }
  .profile-btn.active { background: var(--surface-light); border-color: var(--accent); }
  .profile-btn.has-avatar svg { display: none; }
  .profile-btn .profile-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }
  
  .profile-dropdown {
    position: fixed;
    top: 68px; right: 16px;
    z-index: 999;
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
  }
  .profile-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  .profile-dropdown-item {
    padding: 12px 16px;
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .profile-dropdown-item:first-child {
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }
  .profile-dropdown-item:last-child {
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  .profile-dropdown-item:hover {
    background: var(--surface-light);
  }
  .profile-dropdown-item svg {
    width: 18px;
    height: 18px;
    fill: none;
    stroke: var(--text-secondary);
    stroke-width: 2;
  }
  .profile-dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* ── Compass ── */
  .compass {
    position: fixed;
    bottom: 140px; right: 16px;
    z-index: 1000;
    width: 52px; height: 52px;
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.25s ease;
    animation: slideUp 0.5s ease 0.3s both;
  }
  .compass:hover { border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
  .compass-needle { width: 28px; height: 28px; transition: transform 0.5s ease; }
  .compass-needle svg { width: 100%; height: 100%; }
  .compass-south { fill: rgba(255,255,255,0.5); }
  .compass-center { stroke: rgba(255,255,255,0.3); }

  /* ── Locate ── */
  .locate-btn {
    position: fixed;
    bottom: 200px; right: 16px;
    z-index: 1000;
    width: 52px; height: 52px;
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.25s ease;
    animation: slideUp 0.5s ease 0.25s both;
  }
  .locate-btn:hover { border-color: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
  .locate-btn svg { width: 20px; height: 20px; fill: none; stroke: var(--text-secondary); stroke-width: 2; }
  .locate-btn:hover svg { stroke: var(--accent); }
  .locate-btn.active svg { stroke: var(--accent); }
  .locate-btn.loading svg { animation: spin 1s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* ── Chat Bar ── */
  .chat-bar-container {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 5002;
    padding: 0 12px 20px;
    animation: slideUp 0.5s ease 0.35s both;
  }
  .chat-bar {
    position: relative;
    display: flex; align-items: center; gap: 10px;
    background: var(--chat-bg);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border);
    border-radius: 28px;
    padding: 6px 8px 6px 6px;
    transition: all 0.25s ease;
    max-width: 600px;
    margin: 0 auto;
  }
  .chat-bar-ring {
    position: absolute;
    inset: -2px;
    pointer-events: none;
    z-index: 1;
    overflow: visible;
  }
  .chat-bar-ring rect {
    fill: none;
    stroke: url(#goldGrad);
    stroke-width: 2.5;
    stroke-linecap: round;
    animation: drawRing 1.4s ease-in-out 0.9s forwards, fadeRing 0.4s ease-out 2.3s forwards;
  }
  @keyframes drawRing {
    to { stroke-dashoffset: 0; }
  }
  @keyframes fadeRing {
    to { opacity: 0; }
  }
  .chat-bar:focus-within {
    border-color: rgba(245,197,24,0.35);
    box-shadow: 0 0 30px rgba(245,197,24,0.08), 0 8px 32px rgba(0,0,0,0.4);
  }

  .info-btn {
    width: 40px; height: 40px; min-width: 40px;
    background: rgba(212,160,23,0.12);
    border: 1px solid rgba(212,160,23,0.35);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .info-btn:hover { background: rgba(212,160,23,0.22); border-color: var(--accent); box-shadow: 0 0 14px rgba(212,160,23,0.25); }
  .info-btn svg { width: 18px; height: 18px; fill: none; stroke: var(--accent); stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }
  .info-btn:hover svg { filter: drop-shadow(0 0 3px rgba(212,160,23,0.6)); }

  .chat-input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 400;
    padding: 10px 4px;
    caret-color: var(--accent);
    transition: opacity 0.4s ease;
  }
  .chat-input::placeholder { 
    color: var(--text-muted);
    transition: opacity 0.4s ease;
  }
  .chat-input.fading {
    opacity: 0.4;
  }

  .send-btn {
    width: 40px; height: 40px; min-width: 40px;
    background: var(--accent); border: none; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s ease; opacity: 0.4;
  }
  .send-btn.active { opacity: 1; }
  .send-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent-glow); }
  .send-btn svg { width: 16px; height: 16px; fill: none; stroke: var(--bg-dark); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  /* ── Chat Backdrop ── */
  .chat-backdrop {
    position: fixed;
    inset: 0;
    z-index: 5000;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .chat-backdrop.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* ── Chat Overlay (messages) ── */
  .chat-overlay {
    position: fixed;
    top: 76px; bottom: 148px; left: 12px; right: 12px;
    z-index: 5001;
    max-width: 600px; margin: 0 auto;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
    padding: 4px 0;
    scrollbar-width: none;
    pointer-events: none;
    opacity: 0; transform: translateY(10px);
    transition: all 0.3s ease;
  }
  .chat-overlay::-webkit-scrollbar { display: none; }
  .chat-overlay.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .chat-msg {
    padding: 12px 16px; border-radius: 18px;
    font-size: 14px; line-height: 1.5; max-width: 85%;
    animation: msgIn 0.3s ease both;
  }
  .chat-msg.user {
    background: var(--accent); color: var(--bg-dark);
    align-self: flex-end; border-bottom-right-radius: 6px; font-weight: 500;
  }
  .chat-msg.ai {
    background: transparent;
    color: #fff;
    align-self: flex-start; border-bottom-left-radius: 6px;
    padding-left: 0; padding-right: 0;
  }
  .chat-msg.ai .ai-label {
    font-size: 11px; font-weight: 700; color: var(--accent);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
    opacity: 0.9;
  }
  .typing-indicator { display: flex; gap: 4px; padding: 4px 0; }
  .typing-indicator span {
    width: 6px; height: 6px; background: var(--text-muted);
    border-radius: 50%; animation: typingBounce 1.2s ease infinite;
  }
  .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

  /* ── Map Markers ── */
  .metro-marker { display: flex; align-items: center; justify-content: center; }
  .metro-marker-inner {
    width: 12px; height: 12px;
    border: 2.5px solid #fff;
    border-radius: 50%;
    transition: all 0.2s ease;
    box-shadow: 0 1px 4px rgba(0,0,0,0.6);
  }
  .metro-marker:hover .metro-marker-inner { transform: scale(1.4); border-color: rgba(255,255,255,0.5); }

  .user-marker {
    width: 18px; height: 18px;
    background: #4A90FF; border: 3px solid #fff; border-radius: 50%;
    box-shadow: 0 0 16px rgba(74,144,255,0.5), 0 0 40px rgba(74,144,255,0.2);
    animation: userPulse 2s ease infinite;
  }
  .user-marker-ring {
    position: absolute; top: -10px; left: -10px;
    width: 38px; height: 38px;
    border: 2px solid rgba(74,144,255,0.3);
    border-radius: 50%;
    animation: ringPulse 2s ease infinite;
  }

  /* Leaflet popup */
  .leaflet-popup { max-width: calc(100vw - 40px) !important; }
  .leaflet-popup-content-wrapper {
    background: rgba(22, 22, 34, 0.95) !important;
    border: 1px solid rgba(255,255,255,0.06) !important;
    border-radius: 12px !important;
    backdrop-filter: blur(24px) saturate(1.4) !important;
    box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.03) !important;
    max-width: min(260px, calc(100vw - 48px)) !important;
  }
  [data-theme="light"] .leaflet-popup-content-wrapper {
    background: rgba(255,255,255,0.96) !important;
    border-color: rgba(0,0,0,0.08) !important;
    box-shadow: 0 6px 24px rgba(0,0,0,0.12) !important;
  }
  .leaflet-popup-content {
    color: var(--text-primary) !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    margin: 10px 12px !important;
    line-height: 1.4 !important;
    max-width: 100% !important;
    overflow: hidden !important;
    word-wrap: break-word !important;
  }
  .leaflet-popup-content .popup-station-img { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: block; }
  .leaflet-popup-content .popup-title { font-weight: 700; font-size: 13px; color: var(--accent); margin-bottom: 4px; line-height: 1.3; }
  .leaflet-popup-content .popup-badges { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 6px; }
  .leaflet-popup-content .popup-badge {
    padding: 1px 6px; border-radius: 4px;
    font-size: 9px; font-weight: 700; color: #fff; letter-spacing: 0.3px;
  }
  .popup-rating { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); }
  .popup-rating-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
  .popup-rating-stars { display: flex; gap: 1px; align-items: center; }
  .popup-rating-stars .star { color: var(--text-muted); font-size: 12px; line-height: 1; }
  .popup-rating-stars .star.filled { color: var(--accent); }
  .popup-rating-value { font-size: 11px; color: var(--text-secondary); font-weight: 600; }
  .popup-rating-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; line-height: 1.3; }
  .popup-rating-item:last-child { margin-bottom: 0; }
  .popup-rating-item .rating-stars-inline { display: inline-flex; gap: 1px; align-items: center; }
  .popup-rating-item .rating-stars-inline .star { font-size: 10px; line-height: 1; }
  .popup-rating-btn { margin-top: 6px; padding: 5px 10px; background: var(--accent); color: var(--bg-dark); border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s; }
  .popup-rating-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--accent-glow); }
  .popup-rated-badge { margin-top: 6px; padding: 5px 10px; background: rgba(255,255,255,0.06); color: var(--text-muted); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; font-weight: 600; width: 100%; text-align: center; }
  .popup-arrivals { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); }
  .popup-arrivals-title { font-size: 10px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .popup-arrival-row { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; line-height: 1.4; }
  .popup-arrival-row:last-child { margin-bottom: 0; }
  .popup-line-badge { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 3px; font-size: 9px; font-weight: 700; flex-shrink: 0; }
  .popup-arrival-dest { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .popup-arrival-time { font-weight: 600; white-space: nowrap; color: var(--accent); }
  .popup-arrivals-loading { font-size: 10px; color: var(--text-muted); font-style: italic; }
  .leaflet-popup-close-button { color: var(--text-muted) !important; font-size: 16px !important; padding: 4px 6px !important; width: 20px !important; height: 20px !important; line-height: 1 !important; }

  @media (max-width: 480px) {
    .leaflet-popup-content-wrapper { max-width: min(260px, calc(100vw - 32px)) !important; border-radius: 10px !important; }
    .leaflet-popup-content { font-size: 12px !important; margin: 10px 12px !important; }
    .leaflet-popup-content .popup-title { font-size: 13px; }
    .leaflet-popup-content .popup-badge { font-size: 9px; padding: 1px 5px; }
    .popup-rating-stars .star { font-size: 12px; }
    .popup-rating-value { font-size: 11px; }
    .popup-rating-item { font-size: 10px; gap: 3px; }
    .popup-rating-item .rating-stars-inline .star { font-size: 10px; }
    .popup-rating-btn { font-size: 11px; padding: 6px 10px; margin-top: 5px; }
  }
  
  /* Rating Modal */
  /* Sign In Prompt Modal */
  .signin-prompt-modal {
    position: fixed; inset: 0; z-index: 3000;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .signin-prompt-modal.active { opacity: 1; pointer-events: auto; }
  .signin-prompt-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    max-width: 420px;
    width: 90%;
    position: relative;
    transform: scale(0.95);
    transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  .signin-prompt-modal.active .signin-prompt-content { transform: scale(1); }
  .signin-prompt-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
    border-radius: 8px;
  }
  .signin-prompt-close:hover {
    color: var(--text-primary);
    background: var(--surface-light);
  }
  .signin-prompt-close svg { fill: none; stroke: var(--text-muted); stroke-width: 2; }
  .signin-prompt-close:hover svg { stroke: var(--text-primary); }
  .signin-prompt-header {
    text-align: center;
    margin-bottom: 24px;
  }
  .signin-prompt-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .signin-prompt-header p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .signin-prompt-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }
  .signin-prompt-btn {
    flex: 1;
    padding: 14px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .signin-prompt-btn.primary {
    background: var(--accent);
    color: var(--bg-dark);
    border-color: var(--accent);
  }
  .signin-prompt-btn.primary:hover {
    background: #f5d030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 197, 24, 0.3);
  }
  .signin-prompt-btn.secondary {
    background: var(--surface-light);
    color: var(--text-primary);
    border-color: var(--border);
  }
  .signin-prompt-btn.secondary:hover {
    border-color: var(--accent);
    background: rgba(245, 197, 24, 0.1);
  }
  .signin-prompt-continue {
    width: 100%;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    padding: 8px;
    text-decoration: underline;
    transition: color 0.2s;
  }
  .signin-prompt-continue:hover {
    color: var(--text-secondary);
  }

  /* Confirmation Modal */
  .confirm-modal {
    position: fixed; inset: 0; z-index: 4000;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .confirm-modal.active { opacity: 1; pointer-events: auto; }
  .confirm-modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    position: relative;
    transform: scale(0.95);
    transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  .confirm-modal.active .confirm-modal-content { transform: scale(1); }
  .confirm-modal-header {
    margin-bottom: 24px;
  }
  .confirm-modal-header h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .confirm-modal-header p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .confirm-modal-actions {
    display: flex;
    gap: 12px;
  }
  .confirm-modal-btn {
    flex: 1;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .confirm-modal-btn.cancel {
    background: var(--surface-light);
    color: var(--text-primary);
    border-color: var(--border);
  }
  .confirm-modal-btn.cancel:hover {
    border-color: var(--text-muted);
    background: rgba(255, 255, 255, 0.1);
  }
  .confirm-modal-btn.confirm {
    background: var(--accent);
    color: var(--bg-dark);
    border-color: var(--accent);
  }
  .confirm-modal-btn.confirm:hover {
    background: #f5d030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 197, 24, 0.3);
  }
  .confirm-modal-btn.danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }
  .confirm-modal-btn.danger:hover {
    background: #ff5252;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
  }

  .rating-modal {
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .rating-modal.active { opacity: 1; pointer-events: auto; }
  .rating-modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    max-width: 320px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    transform: scale(0.95);
    transition: transform 0.3s ease;
  }
  .rating-modal.active .rating-modal-content { transform: scale(1); }
  .rating-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .rating-modal-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
  .rating-modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; padding: 0; transition: background 0.2s, color 0.2s; }
  .rating-modal-close svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2.5; stroke-linecap: round; pointer-events: none; }
  .rating-modal-close:hover { color: var(--text-primary); background: rgba(255,255,255,0.08); }
  .rating-category { margin-bottom: 14px; }
  .rating-category-label { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
  .rating-stars-input { display: flex; gap: 4px; justify-content: flex-start; }
  .rating-star-btn { background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; padding: 1px; }
  .rating-star-btn:hover, .rating-star-btn.active { color: var(--accent); transform: scale(1.1); }
  .rating-thumbs { display: flex; gap: 8px; }
  .rating-thumb-btn { background: var(--surface-light); border: 1px solid var(--border); border-radius: 8px; padding: 6px 14px; font-size: 14px; cursor: pointer; transition: all 0.2s; flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; color: white; }
  .rating-thumb-btn:hover { border-color: var(--accent); transform: scale(1.02); }
  .rating-thumb-btn.active.thumb-up { border-color: var(--accent); background: rgba(245, 197, 24, 0.2); }
  .rating-thumb-btn.active.thumb-down { border-color: var(--danger); background: rgba(255, 59, 48, 0.2); }
  .rating-overall-display { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
  .rating-overall-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
  .rating-overall-stars { display: flex; gap: 3px; justify-content: center; }
  .rating-overall-stars .star { font-size: 16px; color: var(--text-muted); }
  .rating-overall-stars .star.filled { color: var(--accent); }
  .rating-description-input { width: 100%; padding: 8px; background: var(--surface-light); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; font-family: inherit; resize: vertical; min-height: 50px; box-sizing: border-box; }
  .rating-description-input:focus { outline: none; border-color: var(--accent); }
  .rating-photo-upload { display: flex; flex-direction: column; gap: 0; }
  .photo-drop-zone { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 18px 12px; border: 2px dashed var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; background: var(--surface-light); }
  .photo-drop-zone:hover { border-color: var(--accent); background: var(--bg-hover); }
  .photo-drop-zone .drop-icon { font-size: 24px; line-height: 1; }
  .photo-drop-zone .drop-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .photo-drop-zone .drop-hint { font-size: 10px; color: var(--text-muted); }
  .photo-preview-wrap { display: none; position: relative; border-radius: 10px; overflow: hidden; }
  .photo-preview-wrap.has-media { display: block; }
  .photo-preview-wrap img, .photo-preview-wrap video { width: 100%; max-height: 200px; object-fit: cover; display: block; border-radius: 10px; }
  .photo-preview-overlay { position: absolute; bottom: 0; left: 0; right: 0; display: flex; gap: 8px; justify-content: center; padding: 10px 12px; background: linear-gradient(transparent, rgba(0,0,0,0.6)); }
  .photo-preview-overlay button { padding: 5px 14px; border: none; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
  .photo-change-btn { background: rgba(255,255,255,0.9); color: #111; }
  .photo-remove-btn { background: rgba(220,50,50,0.85); color: white; }
  .photo-change-btn:hover { background: white; }
  .photo-remove-btn:hover { background: rgba(220,50,50,1); }
  .rating-submit { width: 100%; padding: 9px; background: var(--accent); color: var(--bg-dark); border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.2s; }
  .rating-submit:hover { transform: translateY(-2px); box-shadow: 0 4px 16px var(--accent-glow); }
  .rating-submit:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Rating Modal — bottom sheet on mobile */
  @media (max-width: 768px) {
    .rating-modal {
      align-items: flex-end;
      padding: 0;
    }
    .rating-modal-content {
      max-width: 100%;
      width: 100%;
      max-height: 92dvh;
      border-radius: 20px 20px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
    }
    .rating-modal.active .rating-modal-content {
      transform: translateY(0);
    }
    /* Drag handle */
    .rating-modal-content::before {
      content: '';
      display: block;
      width: 36px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 10px auto 4px;
      flex-shrink: 0;
    }
    .rating-modal-header {
      padding: 4px 16px 12px;
      flex-shrink: 0;
    }
    /* Scrollable form body */
    .rating-form {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
      flex: 1;
      padding: 0 16px 12px;
    }
    /* Sticky submit always visible */
    .rating-submit {
      position: sticky;
      bottom: 0;
      margin: 0;
      border-radius: 0;
      padding: 14px 16px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      font-size: 14px;
      flex-shrink: 0;
    }
    .rating-modal-title { font-size: 15px; }
    .rating-category { margin-bottom: 14px; }
    .rating-category-label { font-size: 12px; }
    .rating-star-btn { font-size: 24px; }
    .rating-thumb-btn { padding: 8px 10px; font-size: 13px; }
    .rating-overall-stars .star { font-size: 20px; }
    .rating-description-input { font-size: 14px; min-height: 60px; }
  }

  
  .station-rating-display { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
  .station-rating-stars { display: flex; gap: 1px; }
  .station-rating-stars .star { color: var(--text-muted); font-size: 11px; }
  .station-rating-stars .star.filled { color: var(--accent); }
  .station-rating-count { font-size: 10px; color: var(--text-muted); }
  .station-times { margin-top: 6px; display: flex; flex-direction: column; gap: 4px; }
  .station-time-row { display: flex; align-items: center; gap: 6px; }
  .station-time-dir { font-size: 10px; color: var(--text-muted); min-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .station-time-pills { display: flex; gap: 4px; }
  .station-time-pill { font-size: 10px; font-variant-numeric: tabular-nums; background: rgba(255,255,255,0.07); border-radius: 4px; padding: 2px 6px; color: var(--text-secondary); white-space: nowrap; }
  .station-time-pill.soon { color: var(--accent); font-weight: 600; background: rgba(212,160,23,0.12); }
  [data-theme="light"] .station-time-pill { background: rgba(0,0,0,0.06); }
  [data-theme="light"] .station-time-pill.soon { background: rgba(212,160,23,0.15); }
  .leaflet-popup-tip { background: rgba(22, 22, 34, 0.95) !important; border: 1px solid rgba(255,255,255,0.06) !important; box-shadow: none !important; }
  [data-theme="light"] .leaflet-popup-tip { background: rgba(255,255,255,0.96) !important; border-color: rgba(0,0,0,0.08) !important; }
  [data-theme="light"] .metro-marker-inner { border-color: #fff !important; }

  /* Station name tooltip on hover */
  .station-tooltip {
    background: rgba(18, 18, 28, 0.92) !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    border-radius: 6px !important;
    color: #fff !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    padding: 4px 9px !important;
    box-shadow: 0 4px 14px rgba(0,0,0,0.45) !important;
    white-space: nowrap !important;
    pointer-events: none !important;
  }
  .station-tooltip::before { display: none !important; }
  [data-theme="light"] .station-tooltip {
    background: rgba(255,255,255,0.96) !important;
    border-color: rgba(0,0,0,0.10) !important;
    color: #111 !important;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15) !important;
  }

  /* ── Toast notification ── */
  .map-toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    background: rgba(18, 18, 28, 0.96);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.55);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #f0f0f5;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: transform 0.38s cubic-bezier(0.16,1,0.3,1), opacity 0.38s ease;
  }
  .map-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
  .map-toast.success .map-toast-icon { color: #30d158; }
  .map-toast.error   .map-toast-icon { color: #ff3b30; }
  .map-toast.info    .map-toast-icon { color: #f5c518; }
  .map-toast-icon { font-size: 16px; flex-shrink: 0; }
  [data-theme="light"] .map-toast {
    background: rgba(255,255,255,0.97);
    border-color: rgba(0,0,0,0.09);
    color: #1c1c1e;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  }

  /* Panel backdrop */
  .panel-backdrop {
    position: fixed; inset: 0; z-index: 5999;
    background: rgba(0,0,0,0.4);
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .panel-backdrop.visible { opacity: 1; pointer-events: auto; }

  /* ── Animations ── */
  @keyframes slideDown { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes userPulse {
    0%, 100% { box-shadow: 0 0 16px rgba(74,144,255,0.5), 0 0 40px rgba(74,144,255,0.2); }
    50% { box-shadow: 0 0 24px rgba(74,144,255,0.7), 0 0 60px rgba(74,144,255,0.3); }
  }
  @keyframes ringPulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.2); opacity: 0; } }
  @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
  @keyframes msgIn { from { opacity: 0; transform: translateY(8px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }

  .station-panel-handle { display: none; width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 10px auto 2px; flex-shrink: 0; }

  @media (max-width: 480px) {
    .coords-display { top: 66px; }
    .station-pill { top: 12px; left: 64px; }
    .profile-btn { top: 12px; right: 12px; }
    .hamburger-nav { top: 12px; left: 12px; }
    .station-panel-handle { display: block; }
    .station-panel {
      top: auto; bottom: 0; left: 0; right: 0; width: 100%;
      max-height: 72vh; border-radius: 20px 20px 0 0;
      backdrop-filter: none; -webkit-backdrop-filter: none;
      opacity: 1; transform: translateY(100%);
      transition: transform 0.42s cubic-bezier(0.32, 0.72, 0, 1);
      box-shadow: 0 -4px 40px rgba(0,0,0,0.45);
    }
    .station-panel.open { transform: translateY(0); opacity: 1; }
  }

  /* ── Light Mode Overrides ── */
  [data-theme="light"] .hamburger-nav { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .hamburger-bar { background: var(--text-secondary); }
[data-theme="light"] .coords-display { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .station-pill { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .profile-btn { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .profile-btn svg { stroke: var(--text-secondary); }
  [data-theme="light"] .profile-dropdown { background: var(--surface); border-color: var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
  [data-theme="light"] .profile-dropdown-item:hover { background: rgba(0,0,0,0.04); }
  [data-theme="light"] .profile-dropdown-item svg { stroke: var(--text-secondary); }
  [data-theme="light"] .profile-dropdown-divider { background: var(--border); }
  [data-theme="light"] .locate-btn { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .locate-btn svg { stroke: var(--text-secondary); }
  [data-theme="light"] .sidebar-btn { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .sidebar-btn svg { stroke: var(--text-secondary); }
  [data-theme="light"] .sidebar { background: rgba(255,255,255,0.96); border-color: var(--border); }
  [data-theme="light"] .sidebar-header { border-color: var(--border); }
  [data-theme="light"] .sidebar-close svg { stroke: var(--text-muted); }
  [data-theme="light"] .line-filter-btn { background: rgba(0,0,0,0.04); border-color: var(--border); color: var(--text-secondary); }
  [data-theme="light"] .line-filter-btn:hover { background: rgba(0,0,0,0.08); }
  [data-theme="light"] .station-item { border-color: var(--border); }
  [data-theme="light"] .station-item:hover { background: rgba(0,0,0,0.03); }
  [data-theme="light"] .station-panel { background: var(--surface); border-color: var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
  [data-theme="light"] .station-panel-close svg { stroke: var(--text-muted); }
  [data-theme="light"] .tab-btn { color: var(--text-muted); }
  [data-theme="light"] .tab-btn.active { color: var(--text-primary); border-color: var(--accent); }
  [data-theme="light"] .info-btn { background: rgba(212,160,23,0.1); border-color: rgba(212,160,23,0.4); }
  [data-theme="light"] .info-btn svg { stroke: #b8860b; }
  [data-theme="light"] .chat-input-wrap { background: rgba(0,0,0,0.04); border-color: var(--border); }
  [data-theme="light"] .chat-input { color: var(--text-primary); }
  [data-theme="light"] .chat-msg.ai { background: transparent; color: #fff; }
  [data-theme="light"] .modal-overlay .modal-content { background: var(--surface); border-color: var(--border); box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
  [data-theme="light"] .sign-in-prompt-content { background: var(--surface); box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
  [data-theme="light"] .confirm-modal-content { background: var(--surface); box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
  [data-theme="light"] .rating-form select,
  [data-theme="light"] .rating-form textarea,
  [data-theme="light"] .rating-form input[type="file"] { background: rgba(0,0,0,0.04); border-color: var(--border); color: var(--text-primary); }
  [data-theme="light"] .rating-submit { color: #fff; }
  [data-theme="light"] .popup-rating-btn { color: #fff; }
  [data-theme="light"] .signin-prompt-btn.primary { color: #fff; }
  [data-theme="light"] .confirm-modal-btn.confirm { color: #fff; }
  [data-theme="light"] .chat-msg.user { color: #fff; }
  [data-theme="light"] .rating-item-avatar { color: #fff; }

  /* Compass */
  [data-theme="light"] .compass { background: rgba(255,255,255,0.92); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .compass-south { fill: rgba(0,0,0,0.3); }
  [data-theme="light"] .compass-center { stroke: rgba(0,0,0,0.2); }

  /* Send button icon */
  [data-theme="light"] .send-btn svg { stroke: #fff; }

  /* Line chips */
  [data-theme="light"] .line-chip { background: rgba(0,0,0,0.04); }
  [data-theme="light"] .line-chip:hover { background: rgba(0,0,0,0.08); }
  [data-theme="light"] .line-chip.active { background: rgba(0,0,0,0.08); }
  [data-theme="light"] .line-chip.all-chip.active { background: rgba(212,160,23,0.12); }

  /* Chat bar */
  [data-theme="light"] .chat-bar { background: var(--chat-bg); border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  [data-theme="light"] .chat-bar:focus-within { box-shadow: 0 0 30px rgba(212,160,23,0.12), 0 8px 32px rgba(0,0,0,0.1); }
/* Panel search */
  [data-theme="light"] .panel-search { color: var(--text-primary); }
  [data-theme="light"] .panel-search::placeholder { color: var(--text-muted); }
  [data-theme="light"] .search-icon { stroke: var(--text-muted); }
  [data-theme="light"] .station-count { color: var(--text-muted); }
  [data-theme="light"] .station-arrow { stroke: var(--text-muted); }

  /* Rating modals */
  [data-theme="light"] .rating-modal-content { background: var(--surface); box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
  [data-theme="light"] .rating-modal-close { color: var(--text-muted); }
  [data-theme="light"] .rating-modal-close:hover { color: var(--text-primary); }


  /* Sign-in prompt close icon — base style now handles both modes; these are kept for specificity */
  [data-theme="light"] .signin-prompt-close svg { stroke: var(--text-muted); }
  [data-theme="light"] .signin-prompt-close:hover svg { stroke: var(--text-primary); }
  [data-theme="light"] .signin-prompt-content { background: var(--surface); }

  /* Station list scrollbar */
  [data-theme="light"] .station-list { scrollbar-color: rgba(0,0,0,0.1) transparent; }
  [data-theme="light"] .station-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }

  /* Panel search input */
  [data-theme="light"] .panel-search { background: rgba(0,0,0,0.04); }

  /* Rating thumb buttons */
  [data-theme="light"] .rating-thumb-btn { color: var(--text-primary); }

  /* Station item active state */
  [data-theme="light"] .station-item:active { background: rgba(0,0,0,0.06); }

  /* Confirm modal cancel hover */
  [data-theme="light"] .confirm-modal-btn.cancel:hover { background: rgba(0,0,0,0.05); }

  /* Metro marker hover */
  [data-theme="light"] .metro-marker:hover .metro-marker-inner { border-color: rgba(0,0,0,0.5); }

  /* ── Chat History Panel ── */
  .chat-history-backdrop {
    position: fixed; inset: 0; z-index: 5999;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .chat-history-backdrop.visible { opacity: 1; pointer-events: auto; }
  .chat-history-panel {
    position: fixed; top: 0; left: 0; bottom: 0; width: 300px;
    z-index: 6000; background: var(--surface);
    backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 8px 0 40px rgba(0,0,0,0.5);
  }
  .chat-history-panel.open { transform: translateX(0); }
  .chat-history-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 12px 10px 16px; flex-shrink: 0;
    font-size: 15px; font-weight: 600; color: var(--text-primary);
  }
  .chat-history-close {
    background: none; border: none; color: var(--text-muted); cursor: pointer;
    padding: 4px; border-radius: 6px; display: flex; align-items: center; transition: color 0.15s;
  }
  .chat-history-close:hover { color: var(--text-primary); }
  .chat-history-new-btn {
    display: flex; align-items: center; gap: 8px; margin: 12px 12px 8px;
    padding: 10px 14px; background: var(--accent); color: var(--bg-dark);
    border: none; border-radius: 10px; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; flex-shrink: 0;
  }
  .chat-history-new-btn:hover { opacity: 0.88; transform: translateY(-1px); }
  .chat-history-list { flex: 1; overflow-y: auto; padding: 4px 8px; }
  .chat-history-list::-webkit-scrollbar { width: 3px; }
  .chat-history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .chat-history-section-label {
    font-size: 11px; font-weight: 500; color: var(--text-muted); padding: 10px 8px 4px;
  }
  .chat-history-item {
    padding: 11px 12px; border-radius: 10px; cursor: pointer;
    transition: background 0.15s; margin-bottom: 2px; border: 1px solid transparent;
  }
  .chat-history-item:hover { background: var(--surface-light); border-color: var(--border); }
  .chat-history-item.active { background: var(--surface-light); border-color: var(--accent); }
  .chat-history-item-title {
    font-size: 13px; font-weight: 500; color: var(--text-primary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px;
  }
  .chat-history-item-preview {
    font-size: 11px; color: var(--text-muted);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .chat-history-empty { text-align: center; color: var(--text-muted); font-size: 13px; padding: 32px 16px; }
  .chat-history-footer { border-top: 1px solid var(--border); padding: 6px 8px; flex-shrink: 0; }
  .chat-history-footer-item {
    display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px;
    font-size: 13px; color: var(--text-secondary); text-decoration: none; transition: background 0.15s, color 0.15s;
  }
  .chat-history-footer-item:hover { background: var(--surface-light); color: var(--text-primary); }
  .chat-history-footer-item svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 1.8; flex-shrink: 0; }
  .chat-history-footer-divider { height: 1px; background: var(--border); margin: 4px 2px; }
  .chat-history-user-info {
    display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px;
    cursor: pointer; transition: background 0.15s; text-decoration: none; color: var(--text-primary);
  }
  .chat-history-user-info:hover { background: var(--surface-light); }
  .chat-history-user-avatar {
    width: 30px; height: 30px; border-radius: 50%; background: var(--surface-light);
    border: 1px solid var(--border); flex-shrink: 0; overflow: hidden; position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .chat-history-user-avatar img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
  .chat-history-user-avatar svg { width: 15px; height: 15px; fill: none; stroke: var(--text-secondary); stroke-width: 1.8; }
  .chat-history-user-name { font-size: 13px; font-weight: 500; }
  [data-theme="light"] .chat-history-panel { background: rgba(255,255,255,0.96); box-shadow: 8px 0 40px rgba(0,0,0,0.15); }
  @media (max-width: 480px) { .chat-history-panel { width: 85vw; } }

  /* ── Nav Profile Footer ── */
  .nav-profile-footer { border-top: 1px solid var(--border); padding: 6px 8px; flex-shrink: 0; }
  .nav-profile {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px; border-radius: 10px; cursor: pointer;
    transition: background 0.15s;
  }
  .nav-profile:hover { background: var(--surface-light); }
  .nav-profile-name { font-size: 13px; font-weight: 500; color: var(--text-primary); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .nav-profile-chevron { width: 14px; height: 14px; fill: none; stroke: var(--text-muted); stroke-width: 2.2; flex-shrink: 0; transition: transform 0.2s ease; }
  .nav-profile.open .nav-profile-chevron { transform: rotate(180deg); }
  .nav-profile-menu {
    overflow: hidden; max-height: 0;
    transition: max-height 0.25s ease, padding 0.25s ease;
  }
  .nav-profile-menu.open { max-height: 280px; padding-bottom: 4px; }
  .nav-profile-menu-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px; border-radius: 8px; font-size: 13px;
    color: var(--text-secondary); cursor: pointer;
    transition: background 0.15s, color 0.15s;
  }
  .nav-profile-menu-item:hover { background: var(--surface-light); color: var(--text-primary); }
  .nav-profile-menu-item svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 1.8; flex-shrink: 0; }
  .nav-profile-menu-item.danger { color: #ff453a; }
  .nav-profile-menu-item.danger:hover { background: rgba(255,69,58,0.12); color: #ff453a; }
  .nav-profile-menu-divider { height: 1px; background: var(--border); margin: 4px 2px; }
</style>
</head>
<body>

<div id="map"></div>

<!-- Hamburger Nav -->
<div class="hamburger-nav" id="hamburgerNav">
  <div class="hamburger-bar"></div>
  <div class="hamburger-bar"></div>
  <div class="hamburger-bar"></div>
</div>

<!-- Station Pill -->
<div class="station-pill" id="stationPill">
  <div class="dot"></div>
  <span>Stations</span>
  <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
</div>

<!-- Profile -->
<div class="profile-btn" id="profileBtn">
  <img class="profile-avatar-img" id="profileAvatarImg" style="display:none;" alt="Profile">
  <svg viewBox="0 0 24 24" id="profileBtnIcon"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
</div>

<!-- Station Panel -->
<div class="panel-backdrop" id="panelBackdrop"></div>
<div class="station-panel" id="stationPanel">
  <div class="station-panel-handle"></div>
  <div class="panel-header">
    <svg class="search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    <input class="panel-search" id="stationSearch" type="text" placeholder="Search stations..." autocomplete="off" />
  </div>
  <div class="line-filters" id="lineFilters"></div>
  <div class="station-count" id="stationCount"></div>
  <div class="station-list" id="stationList"></div>
</div>

<!-- Coordinates -->
<div class="coords-display" id="coordsDisplay">
  <svg class="coord-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
  <div class="coord-text" id="coordsText"></div>
</div>
<div class="profile-dropdown" id="profileDropdown">
  <!-- Authenticated user menu -->
  <div class="profile-dropdown-auth" id="profileDropdownAuth" style="display: none;">
    <div class="profile-dropdown-item" data-action="profile">
      <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>My Profile</span>
    </div>
    <div class="profile-dropdown-item" data-action="ratings">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      <span>My Ratings</span>
    </div>
    <div class="profile-dropdown-divider"></div>
    <div class="profile-dropdown-item" data-action="settings">
      <svg viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>Settings</span>
    </div>
    <div class="profile-dropdown-item" data-action="signout">
      <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      <span>Sign Out</span>
    </div>
  </div>
  
  <!-- Non-authenticated user menu -->
  <div class="profile-dropdown-guest" id="profileDropdownGuest">
    <div class="profile-dropdown-item" data-action="signin">
      <svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      <span>Sign In</span>
    </div>
  </div>
</div>

<!-- Locate -->
<div class="locate-btn" id="locateBtn">
  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
</div>

<!-- Compass -->
<div class="compass" id="compass">
  <div class="compass-needle" id="compassNeedle">
    <svg viewBox="0 0 40 40">
      <polygon points="20,4 24,22 20,19 16,22" fill="#ff3b30" opacity="0.9"/>
      <polygon class="compass-south" points="20,36 16,22 20,25 24,22"/>
      <circle class="compass-center" cx="20" cy="20" r="3" fill="none" stroke-width="1"/>
    </svg>
  </div>
</div>

<!-- Rating Modal -->
<div class="rating-modal" id="ratingModal">
  <div class="rating-modal-content">
    <div class="rating-modal-header">
      <div class="rating-modal-title" id="ratingModalTitle">Rate Station</div>
      <button class="rating-modal-close" id="ratingModalClose">
        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    
    <div class="rating-form">
      <div class="rating-category">
        <div class="rating-category-label">🛡️ Safety — Did you feel safe?</div>
        <div class="rating-stars-input" data-category="safety">
          <button class="rating-star-btn" data-rating="1">★</button>
          <button class="rating-star-btn" data-rating="2">★</button>
          <button class="rating-star-btn" data-rating="3">★</button>
          <button class="rating-star-btn" data-rating="4">★</button>
          <button class="rating-star-btn" data-rating="5">★</button>
        </div>
      </div>

      <div class="rating-category">
        <div class="rating-category-label">🧹 Cleanliness — Was it clean?</div>
        <div class="rating-stars-input" data-category="cleanliness">
          <button class="rating-star-btn" data-rating="1">★</button>
          <button class="rating-star-btn" data-rating="2">★</button>
          <button class="rating-star-btn" data-rating="3">★</button>
          <button class="rating-star-btn" data-rating="4">★</button>
          <button class="rating-star-btn" data-rating="5">★</button>
        </div>
      </div>

      <div class="rating-category">
        <div class="rating-category-label">👮 Staff Present — Did you see staff?</div>
        <div class="rating-thumbs" data-category="staff">
          <button class="rating-thumb-btn thumb-up" data-value="yes">👍 Yes</button>
          <button class="rating-thumb-btn thumb-down" data-value="no">👎 No</button>
        </div>
      </div>

      <div class="rating-overall-display">
        <div class="rating-overall-label">Overall Rating</div>
        <div class="rating-overall-stars" id="overallRatingDisplay">
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
          <span class="star">★</span>
        </div>
        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; text-align: center;">Calculated from Safety & Cleanliness</div>
      </div>

      <div class="rating-category">
        <div class="rating-category-label">📝 Description (Optional)</div>
        <textarea id="ratingDescription" class="rating-description-input" placeholder="Share your experience at this station..." rows="3"></textarea>
      </div>

      <div class="rating-category">
        <div class="rating-category-label">📷 Photo / Video (Optional)</div>
        <div class="rating-photo-upload">
          <input type="file" id="ratingPhotoInput" accept="image/*,video/*" style="display: none;">
          <div class="photo-drop-zone" id="ratingPhotoBtn">
            <span class="drop-icon">📷</span>
            <span class="drop-label">Tap to add a photo or video</span>
            <span class="drop-hint">Max 10 MB photo · Max 5 min / 150 MB video</span>
          </div>
          <div class="photo-preview-wrap" id="ratingPhotoPreview">
            <img id="ratingPhotoImg" src="" alt="Rating photo" style="display:none;">
            <video id="ratingVideoEl" controls playsinline style="display:none;"></video>
            <div class="photo-preview-overlay">
              <button type="button" class="photo-change-btn" onclick="document.getElementById('ratingPhotoInput').click()">Change</button>
              <button type="button" class="photo-remove-btn" onclick="removeRatingPhoto()">Remove</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="rating-submit" id="ratingSubmit" disabled>Submit Rating</button>
  </div>
</div>

<!-- Sign In Prompt Modal -->
<div class="signin-prompt-modal" id="signinPromptModal">
  <div class="signin-prompt-content">
    <button class="signin-prompt-close" id="signinPromptClose" onclick="closeSignInPrompt()">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <div class="signin-prompt-header">
      <h2>Welcome to Rate Metro</h2>
      <p>Sign in to save your ratings and access your profile</p>
    </div>
    <div class="signin-prompt-actions">
      <button class="signin-prompt-btn primary" onclick="goToSignIn()">
        Sign In
      </button>
      <button class="signin-prompt-btn secondary" onclick="goToSignUp()">
        Sign Up
      </button>
    </div>
    <button class="signin-prompt-continue" onclick="closeSignInPrompt()">
      Continue without signing in
    </button>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-modal-content">
    <div class="confirm-modal-header">
      <h3 id="confirmModalTitle">Confirm Action</h3>
      <p id="confirmModalMessage">Are you sure you want to proceed?</p>
    </div>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirmModalCancel" onclick="closeConfirmModal()">
        Cancel
      </button>
      <button class="confirm-modal-btn confirm" id="confirmModalConfirm" onclick="executeConfirmAction()">
        Confirm
      </button>
    </div>
  </div>
</div>

<!-- Chat History Panel -->
<div class="chat-history-backdrop" id="chatHistoryBackdrop"></div>
<div class="chat-history-panel" id="chatHistoryPanel">
  <div class="chat-history-header">
    <span>Chat History</span>
    <button class="chat-history-close" id="chatHistoryClose">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <button class="chat-history-new-btn" id="chatHistoryNew">
    <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New Chat
  </button>
  <div class="chat-history-list" id="chatHistoryList"></div>

  <!-- Nav Profile Footer -->
  <div class="nav-profile-footer">
    <div class="nav-profile-menu" id="navProfileMenu">
      <!-- Authenticated -->
      <div id="navProfileMenuAuth" style="display:none;">
        <div class="nav-profile-menu-item" data-nav-action="profile">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span>My Profile</span>
        </div>
        <div class="nav-profile-menu-item" data-nav-action="ratings">
          <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <span>My Ratings</span>
        </div>
        <div class="nav-profile-menu-divider"></div>
        <div class="nav-profile-menu-item" data-nav-action="feedback">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span>Send Feedback</span>
        </div>
        <div class="nav-profile-menu-item" data-nav-action="settings">
          <svg viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          <span>Settings</span>
        </div>
        <div class="nav-profile-menu-item danger" data-nav-action="signout">
          <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          <span>Sign Out</span>
        </div>
      </div>
      <!-- Guest -->
      <div id="navProfileMenuGuest" style="display:none;">
        <div class="nav-profile-menu-item" data-nav-action="signin">
          <svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
          <span>Sign In</span>
        </div>
      </div>
    </div>
    <div class="nav-profile" id="navProfile">
      <div class="chat-history-user-avatar">
        <img id="navProfileAvatarImg" style="display:none;" alt="avatar">
        <svg id="navProfileAvatarIcon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <span class="nav-profile-name" id="navProfileName">Guest</span>
      <svg class="nav-profile-chevron" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>
    </div>
  </div>
</div>

<!-- Chat backdrop -->
<div class="chat-backdrop" id="chatBackdrop"></div>
<!-- Chat messages (shown when chat open) -->
<div class="chat-overlay" id="chatOverlay"></div>
<!-- Always-visible bottom bar -->
<div class="chat-bar-container">
  <div class="chat-bar">
    <svg class="chat-bar-ring" id="chatBarRing">
      <defs>
        <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#f5c518"/>
          <stop offset="50%" stop-color="#d4a017"/>
          <stop offset="100%" stop-color="#f5c518"/>
        </linearGradient>
      </defs>
      <rect id="chatBarRingRect" rx="28" ry="28"/>
    </svg>
    <div class="info-btn" id="infoBtn" title="Ask Metro Safe AI">
      <svg viewBox="0 0 24 24" fill="none" style="display:block;">
        <path d="M11 2L12.5 7.2L18 9L12.5 10.8L11 16L9.5 10.8L4 9L9.5 7.2L11 2Z"/>
        <path d="M18 13.5L18.8 15.8L21 16.5L18.8 17.2L18 19.5L17.2 17.2L15 16.5L17.2 15.8L18 13.5Z"/>
      </svg>
    </div>
    <input class="chat-input" id="chatInput" type="text" placeholder="Ask about station safety..." autocomplete="off" />
    <button class="send-btn" id="sendBtn">
      <svg viewBox="0 0 24 24">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

{% csrf_token %}
<!-- Toast notification -->
<div class="map-toast" id="mapToast">
  <span class="map-toast-icon" id="mapToastIcon"></span>
  <span id="mapToastMsg"></span>
</div>

<script>
// Django URLs injected for JavaScript
const DJANGO_URLS = {
  map: '{% url "ratemetroapp:map" %}',
  profile: '{% url "ratemetroapp:profile" %}',
  myRatings: '{% url "ratemetroapp:my_ratings" %}',
  settings: '{% url "ratemetroapp:settings" %}',
  signIn: '{% url "ratemetroapp:sign_in" %}',
  updateLocation: '{% url "ratemetroapp:update_location" %}',
  checkAuth: '{% url "ratemetroapp:check_auth" %}',
  submitRating: '{% url "ratemetroapp:submit_rating" %}',
  stationRatings: '{% url "ratemetroapp:station_ratings" %}',
  stationArrivals: '{% url "ratemetroapp:station_arrivals" %}',
  logout: '{% url "ratemetroapp:api_logout" %}',
  deleteAccount: '{% url "ratemetroapp:api_delete_account" %}',
  feedback: '{% url "ratemetroapp:feedback" %}',
};

// Authentication state
let isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
let currentUsername = '{{ username|default:"" }}';
let currentAvatarUrl = '{{ avatar_url|default:"" }}';

// Check authentication status
async function checkAuthentication() {
  try {
    const response = await fetch(DJANGO_URLS.checkAuth);
    const data = await response.json();
    isAuthenticated = data.is_authenticated;
    currentUsername = data.username || '';
    // Update profile button visibility when auth status changes
    updateProfileButtonVisibility();
    return isAuthenticated;
  } catch (error) {
    console.error('Auth check failed:', error);
    return false;
  }
}

// Confirmation Modal Functions
let confirmCallback = null;

function showConfirmModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel', isDanger = false) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const titleEl = document.getElementById('confirmModalTitle');
    const messageEl = document.getElementById('confirmModalMessage');
    const confirmBtn = document.getElementById('confirmModalConfirm');
    const cancelBtn = document.getElementById('confirmModalCancel');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    confirmBtn.textContent = confirmText;
    cancelBtn.textContent = cancelText;
    
    // Set button style
    confirmBtn.classList.remove('danger');
    if (isDanger) {
      confirmBtn.classList.add('danger');
    }
    
    // Store resolve function
    confirmCallback = resolve;
    
    // Show modal
    modal.classList.add('active');
  });
}

function closeConfirmModal() {
  const modal = document.getElementById('confirmModal');
  modal.classList.remove('active');
  if (confirmCallback) {
    confirmCallback(false);
    confirmCallback = null;
  }
}

function executeConfirmAction() {
  const modal = document.getElementById('confirmModal');
  modal.classList.remove('active');
  if (confirmCallback) {
    confirmCallback(true);
    confirmCallback = null;
  }
}

// Prompt user to sign in
async function promptSignIn(action = 'save your data') {
  const confirmed = await showConfirmModal(
    'Sign In Required',
    `You need to sign in to ${action}. Would you like to sign in now?`,
    'Sign In',
    'Cancel'
  );
  
  if (confirmed) {
    window.location.href = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname);
    return true;
  }
  return false;
}

// Handle sign out
async function handleSignOut() {
  const confirmed = await showConfirmModal(
    'Sign Out',
    'Are you sure you want to sign out?',
    'Sign Out',
    'Cancel'
  );
  
  if (!confirmed) {
    return;
  }
  
  try {
    const response = await fetch(DJANGO_URLS.logout, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      const theme = localStorage.getItem('ratemetro-theme');
      const themePref = localStorage.getItem('ratemetro-theme-pref');
      const ratingsData = localStorage.getItem('metroStationRatings');
      localStorage.clear();
      if (theme) localStorage.setItem('ratemetro-theme', theme);
      if (themePref) localStorage.setItem('ratemetro-theme-pref', themePref);
      if (ratingsData) localStorage.setItem('metroStationRatings', ratingsData);
      sessionStorage.clear();

      // Redirect to sign-in page
      window.location.href = DJANGO_URLS.signIn;
    } else {
      showConfirmModal('Error', 'Failed to sign out. Please try again.', 'OK', '', false);
    }
  } catch (error) {
    console.error('Sign out error:', error);
    const theme = localStorage.getItem('ratemetro-theme');
    const themePref = localStorage.getItem('ratemetro-theme-pref');
    const ratingsData = localStorage.getItem('metroStationRatings');
    localStorage.clear();
    if (theme) localStorage.setItem('ratemetro-theme', theme);
    if (themePref) localStorage.setItem('ratemetro-theme-pref', themePref);
    if (ratingsData) localStorage.setItem('metroStationRatings', ratingsData);
    sessionStorage.clear();
    window.location.href = DJANGO_URLS.signIn;
  }
}

// Sign In Prompt Modal Functions
function showSignInPrompt() {
  const modal = document.getElementById('signinPromptModal');
  if (modal) {
    modal.classList.add('active');
  }
}

function closeSignInPrompt() {
  const modal = document.getElementById('signinPromptModal');
  if (modal) {
    modal.classList.remove('active');
    // Remember that user dismissed the prompt (don't show again this session)
    sessionStorage.setItem('signinPromptDismissed', 'true');
  }
}

function goToSignIn() {
  window.location.href = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname);
}

function goToSignUp() {
  // Redirect to sign-in page and switch to signup tab
  const url = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname) + '&tab=signup';
  window.location.href = url;
}

// Get CSRF token from meta tag or cookie
function getCSRFToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  if (token) return token.value;
  return getCookie('csrftoken');
}

// ── Toast ──
let _mapToastTimer = null;
function showMapToast(msg, type = 'success', duration = 3000) {
  const toast   = document.getElementById('mapToast');
  const msgEl   = document.getElementById('mapToastMsg');
  const iconEl  = document.getElementById('mapToastIcon');
  if (!toast) return;
  const icons = { success: '✓', error: '✕', info: '★' };
  iconEl.textContent = icons[type] || '✓';
  msgEl.textContent  = msg;
  toast.className    = `map-toast ${type}`;
  // Force reflow so transition fires even if already visible
  void toast.offsetWidth;
  toast.classList.add('show');
  clearTimeout(_mapToastTimer);
  _mapToastTimer = setTimeout(() => toast.classList.remove('show'), duration);
}

// ── Metro Lines ──
const metroLines = {
  A: { name: 'A Line (Blue)',      color: '#0072bc', text: '#fff' },
  B: { name: 'B Line (Red)',       color: '#e3242b', text: '#fff' },
  C: { name: 'C Line (Green)',     color: '#58a738', text: '#fff' },
  D: { name: 'D Line (Purple)',    color: '#a05da5', text: '#fff' },
  E: { name: 'E Line (Expo)',      color: '#fdb913', text: '#000' },
  G: { name: 'G Line (Orange)',    color: '#f58220', text: '#fff' },
  K: { name: 'K Line (Crenshaw)', color: '#e96bb0', text: '#fff' },
};

// ── Stations ──
const metroStations = [
  // ── A Line (Blue) — Downtown Long Beach ↔ Pomona North ──
  { name: "Downtown Long Beach",          lines: ["A"],            lat: 33.7684, lng: -118.1896 },
  { name: "5th Street",                   lines: ["A"],            lat: 33.7751, lng: -118.1886 },
  { name: "Anaheim Street",               lines: ["A"],            lat: 33.7819, lng: -118.1950 },
  { name: "Pacific Coast Hwy",            lines: ["A"],            lat: 33.7902, lng: -118.1868 },
  { name: "Willow Street",                lines: ["A"],            lat: 33.8082, lng: -118.1893 },
  { name: "Wardlow",                      lines: ["A"],            lat: 33.8388, lng: -118.2087 },
  { name: "Del Amo",                      lines: ["A"],            lat: 33.8489, lng: -118.2119 },
  { name: "Artesia",                      lines: ["A"],            lat: 33.8758, lng: -118.2282 },
  { name: "Compton",                      lines: ["A"],            lat: 33.8972, lng: -118.2231 },
  { name: "Willowbrook/Rosa Parks",       lines: ["A","C"],        lat: 33.9286, lng: -118.2380 },
  { name: "103rd St/Watts Towers",        lines: ["A"],            lat: 33.9429, lng: -118.2690 },
  { name: "Firestone",                    lines: ["A"],            lat: 33.9677, lng: -118.2685 },
  { name: "Florence",                     lines: ["A"],            lat: 33.9764, lng: -118.2680 },
  { name: "Slauson",                      lines: ["A"],            lat: 33.9893, lng: -118.2671 },
  { name: "Vernon",                       lines: ["A"],            lat: 34.0041, lng: -118.2654 },
  { name: "Washington",                   lines: ["A"],            lat: 34.0181, lng: -118.2580 },
  { name: "San Pedro Street",             lines: ["A"],            lat: 34.0290, lng: -118.2540 },
  { name: "Grand/LATTC",                  lines: ["A"],            lat: 34.0335, lng: -118.2689 },
  { name: "Pico",                         lines: ["A","E"],        lat: 34.0408, lng: -118.2660 },
  { name: "7th St/Metro Center",          lines: ["A","B","D","E"], lat: 34.0486, lng: -118.2588 },
  // Regional Connector (shared A + E)
  { name: "Grand Ave Arts/Bunker Hill",   lines: ["A","E"],        lat: 34.0527, lng: -118.2493 },
  { name: "Historic Broadway",            lines: ["A","E"],        lat: 34.0517, lng: -118.2451 },
  { name: "Little Tokyo/Arts District",   lines: ["A","E"],        lat: 34.0495, lng: -118.2407 },
  { name: "Union Station",               lines: ["A","B","D"],    lat: 34.0561, lng: -118.2365 },
  // Former Gold Line (now A Line)
  { name: "Chinatown",                    lines: ["A"],            lat: 34.0637, lng: -118.2358 },
  { name: "Lincoln/Cypress",              lines: ["A"],            lat: 34.0688, lng: -118.2258 },
  { name: "Heritage Square/Arroyo",       lines: ["A"],            lat: 34.0813, lng: -118.2149 },
  { name: "Southwest Museum",             lines: ["A"],            lat: 34.0942, lng: -118.2129 },
  { name: "Highland Park",                lines: ["A"],            lat: 34.1111, lng: -118.1960 },
  { name: "South Pasadena",               lines: ["A"],            lat: 34.1154, lng: -118.1576 },
  { name: "Fillmore",                     lines: ["A"],            lat: 34.1262, lng: -118.1488 },
  { name: "Del Mar",                      lines: ["A"],            lat: 34.1380, lng: -118.1484 },
  { name: "Memorial Park",                lines: ["A"],            lat: 34.1436, lng: -118.1485 },
  { name: "Lake",                         lines: ["A"],            lat: 34.1519, lng: -118.1318 },
  { name: "Allen",                        lines: ["A"],            lat: 34.1519, lng: -118.1132 },
  { name: "Sierra Madre Villa",           lines: ["A"],            lat: 34.1481, lng: -118.0811 },
  { name: "Arcadia",                      lines: ["A"],            lat: 34.1419, lng: -118.0530 },
  { name: "Monrovia",                     lines: ["A"],            lat: 34.1482, lng: -118.0019 },
  { name: "Duarte/City of Hope",          lines: ["A"],            lat: 34.1546, lng: -117.9752 },
  { name: "Irwindale",                    lines: ["A"],            lat: 34.1267, lng: -117.9441 },
  { name: "Azusa Downtown",               lines: ["A"],            lat: 34.1350, lng: -117.9091 },
  { name: "APU/Citrus College",           lines: ["A"],            lat: 34.1378, lng: -117.8862 },
  // Foothill Extension (Sept 2025)
  { name: "Glendora",                     lines: ["A"],            lat: 34.1380, lng: -117.8652 },
  { name: "San Dimas",                    lines: ["A"],            lat: 34.1098, lng: -117.8138 },
  { name: "La Verne/Fairplex",            lines: ["A"],            lat: 34.0985, lng: -117.7829 },
  { name: "Pomona North",                 lines: ["A"],            lat: 34.0758, lng: -117.7527 },
  // ── B Line (Red) — Union Station ↔ North Hollywood ──
  { name: "Civic Center/Grand Park",      lines: ["B","D"],        lat: 34.0558, lng: -118.2461 },
  { name: "Pershing Square",              lines: ["B","D"],        lat: 34.0494, lng: -118.2517 },
  { name: "Westlake/MacArthur Park",      lines: ["B","D"],        lat: 34.0560, lng: -118.2745 },
  { name: "Wilshire/Vermont",             lines: ["B","D"],        lat: 34.0628, lng: -118.2911 },
  { name: "Vermont/Beverly",              lines: ["B"],            lat: 34.0762, lng: -118.2913 },
  { name: "Vermont/Santa Monica",         lines: ["B"],            lat: 34.0909, lng: -118.2919 },
  { name: "Vermont/Sunset",               lines: ["B"],            lat: 34.0976, lng: -118.2919 },
  { name: "Hollywood/Western",            lines: ["B"],            lat: 34.1016, lng: -118.3069 },
  { name: "Hollywood/Vine",               lines: ["B"],            lat: 34.1017, lng: -118.3260 },
  { name: "Hollywood/Highland",           lines: ["B"],            lat: 34.1016, lng: -118.3385 },
  { name: "Universal City/Studio City",   lines: ["B"],            lat: 34.1382, lng: -118.3621 },
  { name: "North Hollywood",              lines: ["B","G"],        lat: 34.1684, lng: -118.3766 },
  // ── C Line (Green) — Norwalk ↔ LAX/Metro Transit Center ──
  { name: "Norwalk",                      lines: ["C"],            lat: 33.9144, lng: -118.1050 },
  { name: "Lakewood Blvd",               lines: ["C"],            lat: 33.9099, lng: -118.1329 },
  { name: "Long Beach Blvd",             lines: ["C"],            lat: 33.9099, lng: -118.2108 },
  { name: "Lynwood",                      lines: ["C"],            lat: 33.9200, lng: -118.2250 },
  { name: "Avalon",                       lines: ["C"],            lat: 33.9294, lng: -118.2443 },
  { name: "Harbor Freeway",              lines: ["C"],            lat: 33.9292, lng: -118.2575 },
  { name: "Vermont/Athens",              lines: ["C"],            lat: 33.9292, lng: -118.2881 },
  { name: "Hawthorne/Lennox",            lines: ["C"],            lat: 33.9214, lng: -118.3520 },
  { name: "Aviation/Imperial",           lines: ["C","K"],        lat: 33.9271, lng: -118.3793 },
  { name: "Aviation/Century",            lines: ["C","K"],        lat: 33.9375, lng: -118.3793 },
  { name: "LAX/Metro Transit Center",    lines: ["C","K"],        lat: 33.9492, lng: -118.3993 },
  // ── D Line (Purple) — Union Station ↔ Westwood/VA Hospital ──
  { name: "Wilshire/Normandie",          lines: ["D"],            lat: 34.0618, lng: -118.3012 },
  { name: "Wilshire/Western",            lines: ["D"],            lat: 34.0626, lng: -118.3089 },
  { name: "Wilshire/La Brea",            lines: ["D"],            lat: 34.0620, lng: -118.3443 },
  { name: "Wilshire/Fairfax",            lines: ["D"],            lat: 34.0622, lng: -118.3612 },
  { name: "Wilshire/La Cienega",         lines: ["D"],            lat: 34.0624, lng: -118.3784 },
  { name: "Wilshire/Rodeo",              lines: ["D"],            lat: 34.0606, lng: -118.3975 },
  { name: "Century City/Constellation",  lines: ["D"],            lat: 34.0555, lng: -118.4170 },
  { name: "Westwood/VA Hospital",        lines: ["D"],            lat: 34.0478, lng: -118.4406 },
  // ── E Line (Expo) — Downtown Santa Monica ↔ Atlantic ──
  { name: "Downtown Santa Monica",       lines: ["E"],            lat: 34.0115, lng: -118.4916 },
  { name: "17th St/SMC",                 lines: ["E"],            lat: 34.0151, lng: -118.4792 },
  { name: "26th St/Bergamot",            lines: ["E"],            lat: 34.0299, lng: -118.4665 },
  { name: "Expo/Bundy",                  lines: ["E"],            lat: 34.0266, lng: -118.4525 },
  { name: "Expo/Sepulveda",              lines: ["E"],            lat: 34.0340, lng: -118.4335 },
  { name: "Westwood/Rancho Park",        lines: ["E"],            lat: 34.0365, lng: -118.4225 },
  { name: "Palms",                       lines: ["E"],            lat: 34.0289, lng: -118.4047 },
  { name: "Culver City",                 lines: ["E"],            lat: 34.0283, lng: -118.3863 },
  { name: "La Cienega/Jefferson",        lines: ["E"],            lat: 34.0250, lng: -118.3729 },
  { name: "Expo/La Brea",                lines: ["E"],            lat: 34.0233, lng: -118.3519 },
  { name: "Expo/Crenshaw",               lines: ["E","K"],        lat: 34.0229, lng: -118.3382 },
  { name: "Farmdale",                    lines: ["E"],            lat: 34.0166, lng: -118.3259 },
  { name: "Expo/Western",                lines: ["E"],            lat: 34.0184, lng: -118.3087 },
  { name: "Expo/Vermont",                lines: ["E"],            lat: 34.0181, lng: -118.2914 },
  { name: "Expo Park/USC",               lines: ["E"],            lat: 34.0180, lng: -118.2857 },
  { name: "Jefferson/USC",               lines: ["E"],            lat: 34.0216, lng: -118.2789 },
  // East LA Extension
  { name: "Pico/Aliso",                  lines: ["E"],            lat: 34.0430, lng: -118.2237 },
  { name: "Mariachi Plaza/Boyle Heights",lines: ["E"],            lat: 34.0352, lng: -118.2176 },
  { name: "Soto",                        lines: ["E"],            lat: 34.0329, lng: -118.2116 },
  { name: "Indiana",                     lines: ["E"],            lat: 34.0323, lng: -118.2010 },
  { name: "Maravilla",                   lines: ["E"],            lat: 34.0282, lng: -118.1890 },
  { name: "East LA Civic Center",        lines: ["E"],            lat: 34.0236, lng: -118.1731 },
  { name: "Atlantic",                    lines: ["E"],            lat: 34.0205, lng: -118.1589 },
  // ── K Line (Crenshaw/LAX) — Redondo Beach ↔ Expo/Crenshaw ──
  { name: "Redondo Beach",               lines: ["K"],            lat: 33.8916, lng: -118.3793 },
  { name: "Douglas",                     lines: ["K"],            lat: 33.9073, lng: -118.2940 },
  { name: "El Segundo",                  lines: ["K"],            lat: 33.9164, lng: -118.3037 },
  { name: "Mariposa",                    lines: ["K"],            lat: 33.9189, lng: -118.3288 },
  // Aviation/Imperial, Aviation/Century, LAX/Metro Transit Center shared with C Line
  { name: "Westchester/Veterans",        lines: ["K"],            lat: 33.9590, lng: -118.3782 },
  { name: "Downtown Inglewood",          lines: ["K"],            lat: 33.9613, lng: -118.3531 },
  { name: "Fairview Heights",            lines: ["K"],            lat: 33.9723, lng: -118.3443 },
  { name: "Hyde Park",                   lines: ["K"],            lat: 33.9918, lng: -118.3312 },
  { name: "Crenshaw",                    lines: ["K"],            lat: 33.9950, lng: -118.3318 },
  { name: "Leimert Park",                lines: ["K"],            lat: 34.0082, lng: -118.3325 },
  { name: "Martin Luther King Jr",       lines: ["K"],            lat: 34.0110, lng: -118.3360 },
  // Expo/Crenshaw shared with E Line
  // ── G Line (Orange BRT) — North Hollywood ↔ Chatsworth ──
  { name: "Chatsworth",                  lines: ["G"],            lat: 34.2583, lng: -118.6010 },
  { name: "Nordhoff",                    lines: ["G"],            lat: 34.2342, lng: -118.5871 },
  { name: "Roscoe",                      lines: ["G"],            lat: 34.2194, lng: -118.5700 },
  { name: "De Soto",                     lines: ["G"],            lat: 34.2002, lng: -118.5595 },
  { name: "Pierce College",              lines: ["G"],            lat: 34.1874, lng: -118.5501 },
  { name: "Tampa",                       lines: ["G"],            lat: 34.1732, lng: -118.5340 },
  { name: "Reseda",                      lines: ["G"],            lat: 34.1725, lng: -118.5117 },
  { name: "Balboa",                      lines: ["G"],            lat: 34.1732, lng: -118.4970 },
  { name: "Woodley",                     lines: ["G"],            lat: 34.1672, lng: -118.4690 },
  { name: "Sepulveda",                   lines: ["G"],            lat: 34.1610, lng: -118.4487 },
  { name: "Van Nuys",                    lines: ["G"],            lat: 34.1486, lng: -118.4494 },
  { name: "Valley College",              lines: ["G"],            lat: 34.1646, lng: -118.4155 },
  { name: "Laurel Canyon",               lines: ["G"],            lat: 34.1665, lng: -118.3920 },
  { name: "Woodman",                     lines: ["G"],            lat: 34.1668, lng: -118.3841 },
];

// ── Line Routes (ordered station names for polyline drawing) ──
const lineRoutes = {
  A: ["Downtown Long Beach","5th Street","Anaheim Street","Pacific Coast Hwy","Willow Street","Wardlow","Del Amo","Artesia","Compton","Willowbrook/Rosa Parks","103rd St/Watts Towers","Firestone","Florence","Slauson","Vernon","Washington","San Pedro Street","Grand/LATTC","Pico","7th St/Metro Center","Grand Ave Arts/Bunker Hill","Historic Broadway","Little Tokyo/Arts District","Union Station","Chinatown","Lincoln/Cypress","Heritage Square/Arroyo","Southwest Museum","Highland Park","South Pasadena","Fillmore","Del Mar","Memorial Park","Lake","Allen","Sierra Madre Villa","Arcadia","Monrovia","Duarte/City of Hope","Irwindale","Azusa Downtown","APU/Citrus College","Glendora","San Dimas","La Verne/Fairplex","Pomona North"],
  B: ["Union Station","Civic Center/Grand Park","Pershing Square","7th St/Metro Center","Westlake/MacArthur Park","Wilshire/Vermont","Vermont/Beverly","Vermont/Santa Monica","Vermont/Sunset","Hollywood/Western","Hollywood/Vine","Hollywood/Highland","Universal City/Studio City","North Hollywood"],
  C: ["Norwalk","Lakewood Blvd","Long Beach Blvd","Lynwood","Avalon","Willowbrook/Rosa Parks","Harbor Freeway","Vermont/Athens","Hawthorne/Lennox","Aviation/Imperial","Aviation/Century","LAX/Metro Transit Center"],
  D: ["Union Station","Civic Center/Grand Park","Pershing Square","7th St/Metro Center","Westlake/MacArthur Park","Wilshire/Vermont","Wilshire/Normandie","Wilshire/Western","Wilshire/La Brea","Wilshire/Fairfax","Wilshire/La Cienega","Wilshire/Rodeo","Century City/Constellation","Westwood/VA Hospital"],
  E: ["Downtown Santa Monica","17th St/SMC","26th St/Bergamot","Expo/Bundy","Expo/Sepulveda","Westwood/Rancho Park","Palms","Culver City","La Cienega/Jefferson","Expo/La Brea","Expo/Crenshaw","Farmdale","Expo/Western","Expo/Vermont","Expo Park/USC","Jefferson/USC","Pico","7th St/Metro Center","Grand Ave Arts/Bunker Hill","Historic Broadway","Little Tokyo/Arts District","Pico/Aliso","Mariachi Plaza/Boyle Heights","Soto","Indiana","Maravilla","East LA Civic Center","Atlantic"],
  G: ["North Hollywood","Woodman","Laurel Canyon","Valley College","Van Nuys","Sepulveda","Woodley","Balboa","Reseda","Tampa","Pierce College","De Soto","Roscoe","Nordhoff","Chatsworth"],
  K: ["Redondo Beach","Douglas","El Segundo","Mariposa","Aviation/Imperial","Aviation/Century","LAX/Metro Transit Center","Westchester/Veterans","Downtown Inglewood","Fairview Heights","Hyde Park","Crenshaw","Leimert Park","Martin Luther King Jr","Expo/Crenshaw"],
};

let activeLinePolyline = null;
const stationByName = Object.fromEntries(metroStations.map(s => [s.name, s]));

function drawLineRoute(line) {
  if (activeLinePolyline) { map.removeLayer(activeLinePolyline); activeLinePolyline = null; }
  if (line === 'all' || !lineRoutes[line]) return;
  const coords = lineRoutes[line].map(n => stationByName[n]).filter(Boolean).map(s => [s.lat, s.lng]);
  if (coords.length < 2) return;
  activeLinePolyline = L.polyline(coords, {
    color: metroLines[line].color,
    weight: 5,
    opacity: 0.85,
    // BRT lines shown dashed
    ...(line === 'G' ? { dashArray: '10 6' } : {}),
  }).addTo(map);
}

// ── Ratings Storage ──
let stationRatings = JSON.parse(localStorage.getItem('metroStationRatings')) || {};
const _arrivalsCache = {};
let userRatedStations = new Set(); // station names the current user has already rated

function getStationRating(stationName) {
  const ratings = stationRatings[stationName] || [];
  if (ratings.length === 0) return { avg: 0, count: 0, safety: 0, cleanliness: 0, staff: null };
  
  // Calculate averages for Safety and Cleanliness (star ratings 1-5)
  const safetyRatings = ratings.filter(r => r.safety && r.safety > 0);
  const cleanlinessRatings = ratings.filter(r => r.cleanliness && r.cleanliness > 0);
  const staffRatings = ratings.filter(r => r.staff !== null && r.staff !== undefined);
  
  const safetyAvg = safetyRatings.length > 0 
    ? safetyRatings.reduce((sum, r) => sum + r.safety, 0) / safetyRatings.length 
    : 0;
  const cleanlinessAvg = cleanlinessRatings.length > 0
    ? cleanlinessRatings.reduce((sum, r) => sum + r.cleanliness, 0) / cleanlinessRatings.length
    : 0;
  
  // Overall rating: average of Safety and Cleanliness
  const overallAvg = (safetyAvg > 0 && cleanlinessAvg > 0) 
    ? (safetyAvg + cleanlinessAvg) / 2 
    : (safetyAvg > 0 ? safetyAvg : cleanlinessAvg);
  
  // Staff summary
  const staffYes = staffRatings.filter(r => r.staff === 'yes').length;
  const staffTotal = staffRatings.length;
  const staffLabel = staffTotal > 0 ? (staffYes >= staffTotal / 2 ? 'Yes' : 'No') : null;

  return {
    avg: Math.round(overallAvg).toString(),
    count: ratings.length,
    safety: safetyAvg > 0 ? Math.round(safetyAvg).toString() : 0,
    cleanliness: cleanlinessAvg > 0 ? Math.round(cleanlinessAvg).toString() : 0,
    staff: staffLabel
  };
}

async function saveRating(stationName, ratingData) {
  // Check authentication first
  if (!isAuthenticated) {
    const wantsToSignIn = promptSignIn('save your rating');
    if (!wantsToSignIn) {
      return false; // User chose not to sign in
    }
    return false; // Will redirect to sign in
  }
  
  // Try to save to backend first
  try {
    // Look up station coords from the local array for accurate seeding
    const stationMeta = metroStations.find(s => s.name === stationName);
    const fd = new FormData();
    fd.append('station_name', stationName);
    fd.append('safety', ratingData.safety);
    fd.append('cleanliness', ratingData.cleanliness);
    if (ratingData.staff) fd.append('staff_present', ratingData.staff);
    fd.append('description', ratingData.description || '');
    if (stationMeta) { fd.append('lat', stationMeta.lat); fd.append('lng', stationMeta.lng); }
    if (ratingData.mediaFile) fd.append('media', ratingData.mediaFile);

    const response = await fetch(DJANGO_URLS.submitRating, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      body: fd
    });

    const result = await response.json();

    if (result.status === 'success') {
      // Cache locally using server-authoritative values
      if (!stationRatings[stationName]) stationRatings[stationName] = [];
      const ratingToSave = {
        id: result.rating_id,
        safety: ratingData.safety,
        cleanliness: ratingData.cleanliness,
        staff: ratingData.staff,
        description: ratingData.description || '',
        timestamp: result.timestamp || Date.now(),
        username: result.username || currentUsername || '',
        avatar_url: result.avatar_url || currentAvatarUrl || ''
      };
      stationRatings[stationName].push(ratingToSave);
      localStorage.setItem('metroStationRatings', JSON.stringify(stationRatings));
      return true;
    } else if (result.already_rated) {
      userRatedStations.add(stationName);
      closeRatingModal();
      alert('You have already rated this station.');
      return false;
    } else if (result.requires_auth) {
      // Re-check auth status
      const authStatus = await checkAuthentication();
      if (!authStatus) {
        promptSignIn('save your rating');
        return false;
      }
    }
  } catch (error) {
    console.error('Failed to save rating to backend:', error);
    // Fallback to localStorage only if authenticated
    if (isAuthenticated) {
      if (!stationRatings[stationName]) stationRatings[stationName] = [];
      const ratingToSave = {
        safety: ratingData.safety,
        cleanliness: ratingData.cleanliness,
        staff: ratingData.staff,
        description: ratingData.description || '',
        photo: ratingData.photo || null,
        timestamp: Date.now(),
        username: currentUsername || '',
        avatar_url: currentAvatarUrl || ''
      };
      stationRatings[stationName].push(ratingToSave);
      localStorage.setItem('metroStationRatings', JSON.stringify(stationRatings));
      return true;
    }
  }

  return false;
}

function renderStars(rating, size = '14px') {
  const full = Math.floor(rating);
  let html = '';
  for (let i = 0; i < 5; i++) {
    if (i < full) {
      html += `<span class="star filled" style="font-size:${size}; color: var(--accent);">★</span>`;
    } else {
      html += `<span class="star" style="font-size:${size}; color: var(--text-muted);">★</span>`;
    }
  }
  return html;
}

// ── Map ──
const defaultLat = 34.0522, defaultLng = -118.2437;
let userLat = defaultLat, userLng = defaultLng;
let userLocationKnown = false;
let userMarker = null, stationMarkers = [], activeFilter = 'all';

const map = L.map('map', { center: [defaultLat, defaultLng], zoom: 12, zoomControl: false, attributionControl: false });

const darkTileUrl = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
const lightTileUrl = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
let tileLayer = L.tileLayer(currentTheme === 'light' ? lightTileUrl : darkTileUrl, { maxZoom: 19 }).addTo(map);

window.addEventListener('storage', function(e) {
  if (e.key === 'ratemetro-theme') {
    const newTheme = e.newValue || 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    map.removeLayer(tileLayer);
    tileLayer = L.tileLayer(newTheme === 'light' ? lightTileUrl : darkTileUrl, { maxZoom: 19 }).addTo(map);
  }
});

function getStationColor(s) { return metroLines[s.lines[0]]?.color || '#f5c518'; }

function buildPopupHTML(station, rating, userHasRated = false, arrivals = undefined) {
  const badges = station.lines.map(l => {
    const line = metroLines[l];
    return `<span class="popup-badge" style="background:${line.color};color:${line.text}">${l} Line</span>`;
  }).join('');
  const stationNameEscaped = station.name.replace(/'/g, "\'");
  let ratingHTML = '';
  const count = rating ? rating.count : 0;
  if (count > 0) {
    const avg = parseFloat(rating.avg) || 0;
    const safety = parseFloat(rating.safety) || 0;
    const cleanliness = parseFloat(rating.cleanliness) || 0;
    const staff = rating.staff;
    ratingHTML = `<div class="popup-rating">
      <div class="popup-rating-header">
        <div class="popup-rating-stars">${renderStars(Math.round(avg))}</div>
        <div class="popup-rating-value">${avg.toFixed(1)}/5 (${count})</div>
      </div>`;
    if (safety > 0) ratingHTML += `<div class="popup-rating-item">🛡️ Safety: <span class="rating-stars-inline">${renderStars(Math.round(safety), '11px')}</span> ${safety.toFixed(1)}/5</div>`;
    if (cleanliness > 0) ratingHTML += `<div class="popup-rating-item">🧹 Cleanliness: <span class="rating-stars-inline">${renderStars(Math.round(cleanliness), '11px')}</span> ${cleanliness.toFixed(1)}/5</div>`;
    if (staff) ratingHTML += `<div class="popup-rating-item">👮 Staff Present: ${staff}</div>`;
    ratingHTML += `</div>`;
  } else {
    ratingHTML = `<div class="popup-rating"><div class="popup-rating-value">No ratings yet</div></div>`;
  }

  // Arrivals section
  let arrivalsHTML = '';
  if (arrivals === undefined || arrivals === null) {
    arrivalsHTML = `<div class="popup-arrivals"><div class="popup-arrivals-loading">Loading schedule...</div></div>`;
  } else if (arrivals.length === 0) {
    arrivalsHTML = `<div class="popup-arrivals"><div class="popup-arrivals-loading">No upcoming trains</div></div>`;
  } else {
    const rows = arrivals.slice(0, 5).map(a => {
      const textColor = a.line === 'E' || a.line === 'G' ? '#000' : '#fff';
      const minLabel = a.minutes_away === 0 ? 'Now' : a.minutes_away + ' min';
      return `<div class="popup-arrival-row">
        <span class="popup-line-badge" style="background:${a.color};color:${textColor}">${a.line}</span>
        <span class="popup-arrival-dest">${a.headsign}</span>
        <span class="popup-arrival-time">${minLabel}</span>
      </div>`;
    }).join('');
    arrivalsHTML = `<div class="popup-arrivals"><div class="popup-arrivals-title">Upcoming Trains</div>${rows}</div>`;
  }

  const rateBtn = userHasRated
    ? `<div class="popup-rated-badge">✓ You rated this station</div>`
    : `<button class="popup-rating-btn" onclick="openRatingModal('${stationNameEscaped}')">Rate This Station</button>`;
  const viewRatingsBtn = count > 0
    ? `<a class="popup-rating-btn" href="/station-reviews/?station=${encodeURIComponent(station.name)}" style="margin-top:6px;display:block;text-align:center;text-decoration:none;" onclick="sessionStorage.setItem('returnToStation','${stationNameEscaped}')">View All Ratings (${count})</a>`
    : '';
  const stationImg = station.image || '{% static "ratemetroapp/images/default-station.svg" %}';
  return `<img class="popup-station-img" src="${stationImg}" alt="${station.name}"><div class="popup-title">${station.name}</div><div class="popup-badges">${badges}</div>${arrivalsHTML}${ratingHTML}${rateBtn}${viewRatingsBtn}`;
}

function createMarkers(filterLine = 'all') {
  stationMarkers.forEach(m => map.removeLayer(m));
  stationMarkers = [];
  const filtered = filterLine === 'all' ? metroStations : metroStations.filter(s => s.lines.includes(filterLine));
  filtered.forEach(station => {
    const color = getStationColor(station);
    const icon = L.divIcon({
      className: 'metro-marker',
      html: `<div class="metro-marker-inner" style="background:${color};"></div>`,
      iconSize: [14, 14], iconAnchor: [7, 7],
    });
    const rating = getStationRating(station.name);
    const marker = L.marker([station.lat, station.lng], { icon }).addTo(map);
    marker.bindPopup(buildPopupHTML(station, rating, false, null), { maxWidth: 260, minWidth: 180, autoPanPadding: [20, 20] });
    marker.bindTooltip(station.name, { direction: 'top', offset: [0, -8], opacity: 1, className: 'station-tooltip' });
    marker.stationData = station;
    // Fetch fresh ratings + arrivals from backend each time popup opens
    marker.on('popupopen', async function() {
      const marker = this;
      const encName = encodeURIComponent(station.name);

      // Check arrivals cache (60-second TTL)
      const cachedArr = _arrivalsCache[station.name];
      const now = Date.now();
      const useCache = cachedArr && (now - cachedArr._ts < 60000);

      const [ratingsResult, arrivalsResult] = await Promise.allSettled([
        fetch(DJANGO_URLS.stationRatings + '?station=' + encName).then(r => r.ok ? r.json() : null),
        useCache ? Promise.resolve(cachedArr) : fetch(DJANGO_URLS.stationArrivals + '?station=' + encName).then(r => r.ok ? r.json() : null),
      ]);

      let summary = null, userHasRated = false, arrivals = [];

      if (ratingsResult.status === 'fulfilled' && ratingsResult.value && ratingsResult.value.status === 'ok') {
        const data = ratingsResult.value;
        stationRatings[station.name] = data.ratings;
        localStorage.setItem('metroStationRatings', JSON.stringify(stationRatings));
        if (data.user_has_rated) userRatedStations.add(station.name);
        summary = data.summary;
        userHasRated = data.user_has_rated;
      }

      if (arrivalsResult.status === 'fulfilled' && arrivalsResult.value && arrivalsResult.value.status === 'ok') {
        arrivals = arrivalsResult.value.arrivals || [];
        if (!useCache) {
          _arrivalsCache[station.name] = arrivalsResult.value;
          _arrivalsCache[station.name]._ts = Date.now();
        }
      }

      if (marker.isPopupOpen()) {
        marker.getPopup().setContent(buildPopupHTML(station, summary || getStationRating(station.name), userHasRated, arrivals));
      }
    });
    stationMarkers.push(marker);
  });
}
createMarkers();

// ── Restore popup after returning from station reviews ──
const _returnToStation = sessionStorage.getItem('returnToStation');
if (_returnToStation) {
  sessionStorage.removeItem('returnToStation');
  setTimeout(() => {
    const marker = stationMarkers.find(m => m.stationData && m.stationData.name === _returnToStation);
    if (marker) {
      const ll = marker.getLatLng();
      map.setView([ll.lat, ll.lng], 16, { animate: false });
      marker.openPopup();
    }
  }, 50);
}

// ── Filters ──
function buildFilters() {
  const c = document.getElementById('lineFilters');
  let html = `<div class="line-chip all-chip active" data-line="all"><div class="chip-dot" style="background:var(--accent)"></div>All</div>`;
  Object.entries(metroLines).forEach(([key, line]) => {
    html += `<div class="line-chip" data-line="${key}"><div class="chip-dot" style="background:${line.color}"></div>${key}</div>`;
  });
  c.innerHTML = html;

  c.querySelectorAll('.line-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const line = chip.dataset.line;
      activeFilter = line;
      const chipBg = document.documentElement.getAttribute('data-theme') === 'light' ? 'rgba(0,0,0,0.04)' : 'rgba(255,255,255,0.05)';
      c.querySelectorAll('.line-chip').forEach(ch => { ch.classList.remove('active'); ch.style.borderColor = 'transparent'; ch.style.background = chipBg; });
      chip.classList.add('active');
      if (line !== 'all') {
        chip.style.borderColor = metroLines[line].color;
        chip.style.background = metroLines[line].color + '18';
      }
      document.getElementById('stationSearch').value = '';
      createMarkers(line);
      renderStationList();
      drawLineRoute(line);
      if (stationMarkers.length > 0) {
        map.fitBounds(new L.featureGroup(stationMarkers).getBounds().pad(0.1), { animate: true, duration: 0.5 });
      }
    });
  });
}
buildFilters();

// ── Station Train Times (real GTFS data) ──
function getStationTimesFromCache(station) {
  const cached = _arrivalsCache[station.name];
  if (!cached || !cached.arrivals || Date.now() - cached._ts > 60000) return null;
  return cached.arrivals;
}

function renderStationTimesHTML(arrivals) {
  if (!arrivals || arrivals.length === 0) return '';
  const rows = arrivals.slice(0, 3).map(a => {
    const textColor = a.line === 'E' || a.line === 'G' ? '#000' : '#fff';
    const minLabel = a.minutes_away === 0 ? 'Now' : a.minutes_away + ' min';
    return `<div class="station-time-row">
      <span class="popup-line-badge" style="background:${a.color};color:${textColor};width:14px;height:14px;font-size:8px">${a.line}</span>
      <span class="station-time-dir" style="color:${a.color};flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.headsign}</span>
      <span class="station-time-pill soon">${minLabel}</span>
    </div>`;
  }).join('');
  return `<div class="station-times">${rows}</div>`;
}

async function fetchStationTimesForList() {
  const items = document.querySelectorAll('#stationList .station-item');
  const fetches = [];
  items.forEach(item => {
    const name = item.dataset.name;
    if (!name) return;
    const cached = _arrivalsCache[name];
    if (cached && Date.now() - cached._ts < 60000) {
      const timesEl = item.querySelector('.station-times-live');
      if (timesEl) timesEl.innerHTML = renderStationTimesHTML(cached.arrivals);
      return;
    }
    fetches.push(
      fetch(DJANGO_URLS.stationArrivals + '?station=' + encodeURIComponent(name))
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (data && data.status === 'ok') {
            _arrivalsCache[name] = data;
            _arrivalsCache[name]._ts = Date.now();
            const timesEl = item.querySelector('.station-times-live');
            if (timesEl) timesEl.innerHTML = renderStationTimesHTML(data.arrivals);
          }
        })
        .catch(() => {})
    );
  });
  await Promise.allSettled(fetches);
}

// ── Station List ──
function renderStationList(searchQuery = '') {
  const listEl = document.getElementById('stationList');
  const countEl = document.getElementById('stationCount');
  const q = searchQuery.toLowerCase();
  let filtered = activeFilter === 'all' ? [...metroStations] : metroStations.filter(s => s.lines.includes(activeFilter));
  if (q) filtered = filtered.filter(s => s.name.toLowerCase().includes(q));
  if (userLocationKnown) {
    filtered.sort((a, b) => {
      const da = (a.lat - userLat) ** 2 + (a.lng - userLng) ** 2;
      const db = (b.lat - userLat) ** 2 + (b.lng - userLng) ** 2;
      return da - db;
    });
  } else {
    filtered.sort((a, b) => a.name.localeCompare(b.name));
  }
  countEl.textContent = `${filtered.length} station${filtered.length !== 1 ? 's' : ''}`;

  if (!filtered.length) { listEl.innerHTML = '<div class="no-results">No stations found</div>'; return; }

  listEl.innerHTML = filtered.map(station => {
    const badges = station.lines.map(l => `<span class="station-line-badge" style="background:${metroLines[l].color}22;color:${metroLines[l].color}">${l}</span>`).join('');
    const rating = getStationRating(station.name);
    const ratingDisplay = rating.count > 0
      ? `<div class="station-rating-display"><div class="station-rating-stars">${renderStars(parseFloat(rating.avg), '11px')}</div><div class="station-rating-count">${rating.avg}</div></div>`
      : '';
    const cachedArrivals = getStationTimesFromCache(station);
    const timesHtml = cachedArrivals ? renderStationTimesHTML(cachedArrivals) : '';
    return `<div class="station-item" data-lat="${station.lat}" data-lng="${station.lng}" data-name="${station.name}">
      <div class="station-color-bar" style="background:${getStationColor(station)}"></div>
      <div class="station-info"><div class="station-name">${station.name}</div><div class="station-line-label">${badges}</div>${ratingDisplay}<div class="station-times-live">${timesHtml}</div></div>
      <svg class="station-arrow" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </div>`;
  }).join('');

  listEl.querySelectorAll('.station-item').forEach(item => {
    item.addEventListener('click', (e) => {
      // Don't trigger if clicking on rating (allow separate click handler)
      if (e.target.closest('.station-rating-display')) return;
      
      const lat = +item.dataset.lat, lng = +item.dataset.lng;
      map.setView([lat, lng], 16, { animate: true, duration: 0.6 });
      stationMarkers.forEach(m => {
        const p = m.getLatLng();
        if (Math.abs(p.lat - lat) < 0.0001 && Math.abs(p.lng - lng) < 0.0001) m.openPopup();
      });
      closePanel();
    });
    
    // Add rating button to station items
    const stationName = item.dataset.name;
    const ratingDisplay = item.querySelector('.station-rating-display');
    if (ratingDisplay) {
      ratingDisplay.style.cursor = 'pointer';
      ratingDisplay.title = 'Click to rate';
      ratingDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        openRatingModal(stationName);
      });
    }
  });
  // Fetch real arrival times for visible stations
  fetchStationTimesForList();
}
renderStationList();

// ── Panel Toggle ──
const stationPill = document.getElementById('stationPill');
const stationPanel = document.getElementById('stationPanel');
const panelBackdrop = document.getElementById('panelBackdrop');
const stationSearch = document.getElementById('stationSearch');

function openPanel() {
  stationPill.classList.add('active'); stationPanel.classList.add('open'); panelBackdrop.classList.add('visible');
  if (!userLocationKnown && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude; userLng = pos.coords.longitude; userLocationKnown = true;
      renderStationList(stationSearch.value);
    }, () => {});
  }
}
function closePanel() { stationPill.classList.remove('active'); stationPanel.classList.remove('open'); panelBackdrop.classList.remove('visible'); }
stationPill.addEventListener('click', () => stationPanel.classList.contains('open') ? closePanel() : openPanel());
panelBackdrop.addEventListener('click', closePanel);
stationSearch.addEventListener('input', e => renderStationList(e.target.value));

// ── User Location ──
function updateCoords(lat, lng) {
  document.getElementById('coordsText').innerHTML =
    `<strong>${Math.abs(lat).toFixed(4)}°${lat >= 0 ? 'N' : 'S'}</strong> &nbsp; <strong>${Math.abs(lng).toFixed(4)}°${lng >= 0 ? 'E' : 'W'}</strong>`;
}
function setUserLocation(lat, lng) {
  userLat = lat; userLng = lng; userLocationKnown = true;
  renderStationList(document.getElementById('stationSearch').value);
  updateCoords(lat, lng);
  if (userMarker) map.removeLayer(userMarker);
  userMarker = L.marker([lat, lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="position:relative;display:flex;align-items:center;justify-content:center;"><div class="user-marker-ring"></div><div class="user-marker"></div></div>`,
      iconSize: [18, 18], iconAnchor: [9, 9],
    }), zIndexOffset: 1000
  }).addTo(map);
  map.setView([lat, lng], 14, { animate: true, duration: 1 });

  // Send location to Django backend
  sendLocationToServer(lat, lng);
}

function sendLocationToServer(lat, lng) {
  fetch(DJANGO_URLS.updateLocation, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify({
      latitude: lat,
      longitude: lng
    })
  }).then(response => {
    if (response.ok) {
      console.log('Location sent to server successfully');
    }
  }).catch(err => {
    console.log('Location update failed:', err);
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
function requestUserLocation(isUserGesture) {
  if (!navigator.geolocation) {
    if (isUserGesture) {
      showConfirmModal('Location Unavailable', 'Geolocation is not supported by your browser.', 'OK', '', false);
    }
    return;
  }

  const locateBtn = document.getElementById('locateBtn');
  if (locateBtn) locateBtn.classList.add('loading');

  navigator.geolocation.getCurrentPosition(
    function(position) {
      setUserLocation(position.coords.latitude, position.coords.longitude);
      if (locateBtn) locateBtn.classList.remove('loading');
      if (isUserGesture) {
        document.getElementById('coordsDisplay').classList.add('visible');
        document.getElementById('locateBtn').classList.add('active');
      }
      // User granted location — re-enable share location setting
      localStorage.setItem('ratemetro-share-location', 'true');
    },
    function(error) {
      if (locateBtn) locateBtn.classList.remove('loading');

      if (isUserGesture) {
        let msg = 'Could not get your location.';
        if (error.code === 1) {
          msg = 'Location access was denied. Please allow location access in your browser settings.';
        } else if (error.code === 2) {
          msg = 'Location is unavailable. Make sure location services are enabled on your device.';
        } else if (error.code === 3) {
          msg = 'Location request timed out. Please try again.';
        }
        if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
          msg += '\n\nNote: Location requires HTTPS. You are on HTTP which may block location access on Safari and some browsers.';
        }
        showConfirmModal('Location Error', msg, 'OK', '', false);
      }
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
  );
}

// Try to get location on load — skip if returning to a station popup or location sharing is disabled
if (!_returnToStation && localStorage.getItem('ratemetro-share-location') !== 'false') {
  requestUserLocation(false);
}

document.getElementById('locateBtn').addEventListener('click', () => {
  requestUserLocation(true);
});

// ── Hamburger Nav ──
const hamburgerNav = document.getElementById('hamburgerNav');

hamburgerNav.addEventListener('click', () => {
  if (chatHistoryPanel.classList.contains('open')) {
    closeChatHistoryPanel();
  } else {
    openChatHistoryPanel();
  }
});

// ── Compass ──
const needleEl = document.getElementById('compassNeedle');
if (window.DeviceOrientationEvent) window.addEventListener('deviceorientation', e => { if (e.alpha !== null) needleEl.style.transform = `rotate(${-e.alpha}deg)`; });
document.getElementById('compass').addEventListener('click', () => { map.setView([userLat, userLng], map.getZoom(), { animate: true }); needleEl.style.transform = 'rotate(0deg)'; });

// ── Gold ring intro animation ──
(function() {
  const bar = document.querySelector('.chat-bar');
  const svg = document.getElementById('chatBarRing');
  const rect = document.getElementById('chatBarRingRect');
  if (bar && svg && rect) {
    const w = bar.offsetWidth + 4;
    const h = bar.offsetHeight + 4;
    svg.setAttribute('width', w);
    svg.setAttribute('height', h);
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    rect.setAttribute('x', '1.5');
    rect.setAttribute('y', '1.5');
    rect.setAttribute('width', w - 3);
    rect.setAttribute('height', h - 3);
    const perimeter = 2 * (w - 3 + h - 3) - 8 * 28 + 2 * Math.PI * 28;
    rect.style.strokeDasharray = perimeter;
    rect.style.strokeDashoffset = perimeter;
  }
})();

// ── Chat ──
const chatInput = document.getElementById('chatInput');
const chatBackdrop = document.getElementById('chatBackdrop');
const sendBtn = document.getElementById('sendBtn');
const chatOverlay = document.getElementById('chatOverlay');

// Rotating questions for chat placeholder
const rotatingQuestions = [
  "Need help with directions?",
  "How can I help?",
  "Safest route to your destination?",
  "Ask about station safety...",
  "Looking for the nearest station?",
  "What are the train times?"
];

let currentQuestionIndex = 0;
function rotateChatPlaceholder() {
  // Only rotate if input is empty and not focused
  if (chatInput.value.trim() || document.activeElement === chatInput) return;
  
  // Fade out
  chatInput.classList.add('fading');
  
  setTimeout(() => {
    chatInput.placeholder = rotatingQuestions[currentQuestionIndex];
    currentQuestionIndex = (currentQuestionIndex + 1) % rotatingQuestions.length;
    
    // Fade in
    setTimeout(() => {
      chatInput.classList.remove('fading');
    }, 50);
  }, 400);
}

// Rotate every 5.5 seconds
rotateChatPlaceholder();
setInterval(rotateChatPlaceholder, 5500);

chatInput.addEventListener('input', () => sendBtn.classList.toggle('active', chatInput.value.trim().length > 0));

function getFreshLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve(userLocationKnown ? { lat: userLat, lng: userLng } : null);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        userLocationKnown = true;
        resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      },
      () => {
        // Fallback to last known location if geolocation fails
        resolve(userLocationKnown ? { lat: userLat, lng: userLng } : null);
      },
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 10000 }
    );
  });
}

async function getAIResponse(msg) {
  const session = getActiveSession();
  const history = session ? session.messages.slice(-10) : [];
  const payload = { message: msg, history: history };
  // Send conversation_id so the server can persist to DB
  if (session && session.conversation_id) {
    payload.conversation_id = session.conversation_id;
  }
  // Get fresh GPS location for every chat message
  const loc = await getFreshLocation();
  if (loc) {
    payload.lat = loc.lat;
    payload.lng = loc.lng;
  }
  try {
    const res = await fetch('/api/chat/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.status === 'ok') {
      // Store server conversation_id on the active session
      if (data.conversation_id && session) {
        session.conversation_id = data.conversation_id;
        saveSessions(chatSessions);
      }
      return data.reply;
    }
    return 'Sorry, I\'m having trouble right now. Please try again in a moment.';
  } catch (e) {
    return 'Sorry, I couldn\'t connect to the AI service. Please check your connection and try again.';
  }
}
// ── Chat Sessions ──
const CHAT_SESSIONS_KEY = 'metroSafeChatSessions';
function loadSessions() {
  try { const s = localStorage.getItem(CHAT_SESSIONS_KEY); return s ? JSON.parse(s) : null; } catch(e) { return null; }
}
function saveSessions(sessions) {
  try { localStorage.setItem(CHAT_SESSIONS_KEY, JSON.stringify(sessions)); } catch(e) {}
}

let chatSessions = loadSessions() || [];
let activeSessionId = null;
let chatSessionsLoaded = false;

function getActiveSession() { return chatSessions.find(s => s.id === activeSessionId) || null; }
function formatDate(d) { return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }

// Load chat sessions from the server for authenticated users
async function loadServerSessions() {
  if (!isAuthenticated) return;
  try {
    const res = await fetch('/api/chat/history/');
    const data = await res.json();
    if (data.status === 'ok' && data.conversations) {
      chatSessions = data.conversations.map(c => ({
        id: 'conv-' + c.id,
        conversation_id: c.id,
        title: c.title,
        date: c.date,
        preview: c.preview,
        messages: [],  // loaded on demand when opened
      }));
      chatSessionsLoaded = true;
      saveSessions(chatSessions);
      renderHistoryPanel();
    }
  } catch(e) { /* fall back to localStorage */ }
}

function appendMsgEl(text, type) {
  const m = document.createElement('div'); m.className = `chat-msg ${type}`;
  if (type === 'ai') m.innerHTML = `<div class="ai-label">Metro Safe AI</div>${text}`;
  else m.textContent = text;
  chatOverlay.appendChild(m);
}

async function openSession(id) {
  const session = chatSessions.find(s => s.id === id);
  if (!session) return;
  activeSessionId = id;
  chatOverlay.innerHTML = '';

  // If this is a server-backed session with no messages loaded yet, fetch them
  if (session.conversation_id && session.messages.length === 0) {
    try {
      const res = await fetch('/api/chat/' + session.conversation_id + '/');
      const data = await res.json();
      if (data.status === 'ok') {
        session.messages = data.messages;
        saveSessions(chatSessions);
      }
    } catch(e) { /* show whatever we have */ }
  }

  session.messages.forEach(msg => appendMsgEl(msg.text, msg.type));
  chatOverlay.classList.add('visible');
  chatBackdrop.classList.add('visible');
  chatOverlay.scrollTop = chatOverlay.scrollHeight;
}

function startNewSession() {
  activeSessionId = null;
  chatOverlay.innerHTML = '';
  chatOverlay.classList.remove('visible');
  chatBackdrop.classList.remove('visible');
}

function addMsg(text, type) {
  if (!activeSessionId) {
    const id = 'session-' + Date.now();
    chatSessions.unshift({ id, title: type === 'user' ? text : 'New Chat', date: formatDate(new Date()), messages: [] });
    activeSessionId = id;
  }
  const session = getActiveSession();
  if (session) { session.messages.push({ type, text }); saveSessions(chatSessions); }
  appendMsgEl(text, type);
  chatOverlay.classList.add('visible');
  chatBackdrop.classList.add('visible');
  chatOverlay.scrollTop = chatOverlay.scrollHeight;
}
function showTyping() {
  const t = document.createElement('div'); t.className = 'chat-msg ai'; t.id = 'typingMsg';
  t.innerHTML = `<div class="ai-label">Metro Safe AI</div><div class="typing-indicator"><span></span><span></span><span></span></div>`;
  chatOverlay.appendChild(t); chatOverlay.scrollTop = chatOverlay.scrollHeight;
}
async function sendMessage() {
  const text = chatInput.value.trim(); if (!text) return;
  addMsg(text, 'user'); chatInput.value = ''; sendBtn.classList.remove('active');
  showTyping();
  const reply = await getAIResponse(text);
  document.getElementById('typingMsg')?.remove();
  addMsg(reply, 'ai');
}
sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

document.getElementById('infoBtn').addEventListener('click', () => {
  if (!chatOverlay.classList.contains('visible') || chatOverlay.children.length === 0) {
    addMsg('Welcome to Metro Safe LA. I provide real-time safety info for all LA Metro stations — A through L lines. Ask about any station, report an incident, or get safety tips.', 'ai');
  } else {
    chatOverlay.classList.add('visible');
    chatBackdrop.classList.add('visible');
  }
});

// ── Chat History Panel ──
const chatHistoryPanel = document.getElementById('chatHistoryPanel');
const chatHistoryBackdrop = document.getElementById('chatHistoryBackdrop');
const chatHistoryList = document.getElementById('chatHistoryList');

function renderHistoryPanel() {
  chatHistoryList.innerHTML = '';
  if (!chatSessions.length) {
    chatHistoryList.innerHTML = '<div class="chat-history-empty">No chat history yet.<br>Start a conversation below.</div>';
    return;
  }
  const today = formatDate(new Date());
  const todaySessions = chatSessions.filter(s => s.date === today);
  const earlierSessions = chatSessions.filter(s => s.date !== today);
  function renderGroup(label, sessions) {
    if (!sessions.length) return;
    const lbl = document.createElement('div'); lbl.className = 'chat-history-section-label'; lbl.textContent = label;
    chatHistoryList.appendChild(lbl);
    sessions.forEach(session => {
      const item = document.createElement('div');
      item.className = 'chat-history-item' + (session.id === activeSessionId ? ' active' : '');
      const lastAI = [...session.messages].reverse().find(m => m.type === 'ai');
      const previewText = lastAI ? lastAI.text : (session.preview || '');
      item.innerHTML = `<div class="chat-history-item-title">${session.title}</div><div class="chat-history-item-preview">${previewText}</div>`;
      item.addEventListener('click', () => { closeChatHistoryPanel(); openSession(session.id); });
      chatHistoryList.appendChild(item);
    });
  }
  renderGroup('Today', todaySessions);
  renderGroup('Earlier', earlierSessions);
}

function openChatHistoryPanel() {
  hamburgerNav.classList.remove('open');
  renderHistoryPanel();
  updateNavProfile();
  chatHistoryPanel.classList.add('open');
  chatHistoryBackdrop.classList.add('visible');
}

function closeChatHistoryPanel() {
  chatHistoryPanel.classList.remove('open');
  chatHistoryBackdrop.classList.remove('visible');
  hamburgerNav.classList.remove('open');
  // Reset profile menu state for next open
  document.getElementById('navProfileMenu').classList.remove('open');
  document.getElementById('navProfile').classList.remove('open');
}

document.getElementById('chatHistoryClose').addEventListener('click', closeChatHistoryPanel);
document.getElementById('chatHistoryBackdrop').addEventListener('click', closeChatHistoryPanel);
document.getElementById('chatHistoryNew').addEventListener('click', () => { closeChatHistoryPanel(); startNewSession(); });

// ── Nav Profile (sidebar footer) ──
function updateNavProfile() {
  const nameEl = document.getElementById('navProfileName');
  const avatarImg = document.getElementById('navProfileAvatarImg');
  const avatarIcon = document.getElementById('navProfileAvatarIcon');
  const menuAuth = document.getElementById('navProfileMenuAuth');
  const menuGuest = document.getElementById('navProfileMenuGuest');

  if (isAuthenticated) {
    if (nameEl) nameEl.textContent = currentUsername || 'My Profile';
    const srcImg = document.getElementById('profileAvatarImg');
    if (avatarImg && srcImg && srcImg.src && srcImg.src !== window.location.href) {
      avatarImg.src = srcImg.src;
      avatarImg.style.display = 'block';
      if (avatarIcon) avatarIcon.style.display = 'none';
    } else {
      if (avatarImg) avatarImg.style.display = 'none';
      if (avatarIcon) avatarIcon.style.display = 'block';
    }
    if (menuAuth) menuAuth.style.display = 'block';
    if (menuGuest) menuGuest.style.display = 'none';
  } else {
    if (nameEl) nameEl.textContent = 'Sign In';
    if (avatarImg) avatarImg.style.display = 'none';
    if (avatarIcon) avatarIcon.style.display = 'block';
    if (menuAuth) menuAuth.style.display = 'none';
    if (menuGuest) menuGuest.style.display = 'block';
  }
}

const navProfileEl = document.getElementById('navProfile');
const navProfileMenu = document.getElementById('navProfileMenu');

navProfileEl.addEventListener('click', () => {
  const isOpen = navProfileMenu.classList.toggle('open');
  navProfileEl.classList.toggle('open', isOpen);
});

navProfileMenu.addEventListener('click', (e) => {
  const item = e.target.closest('[data-nav-action]');
  if (!item) return;
  const action = item.dataset.navAction;
  if (action === 'profile') window.location.href = DJANGO_URLS.profile;
  else if (action === 'ratings') window.location.href = DJANGO_URLS.myRatings;
  else if (action === 'feedback') window.location.href = DJANGO_URLS.feedback;
  else if (action === 'settings') window.location.href = DJANGO_URLS.settings;
  else if (action === 'signout') { closeChatHistoryPanel(); handleSignOut(); }
  else if (action === 'signin') window.location.href = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname);
});

// Load and display user profile image from server
function loadProfileImage() {
  if (!isAuthenticated) {
    updateProfileButtonVisibility();
    return;
  }
  
  const serverAvatarUrl = '{{ avatar_url|default:"" }}';
  const profileBtn = document.getElementById('profileBtn');
  const profileAvatarImg = document.getElementById('profileAvatarImg');
  const profileBtnIcon = document.getElementById('profileBtnIcon');
  
  if (serverAvatarUrl && profileAvatarImg) {
    profileAvatarImg.src = serverAvatarUrl;
    profileAvatarImg.style.display = 'block';
    if (profileBtnIcon) profileBtnIcon.style.display = 'none';
    if (profileBtn) profileBtn.classList.add('has-avatar');
  } else {
    if (profileAvatarImg) profileAvatarImg.style.display = 'none';
    if (profileBtnIcon) profileBtnIcon.style.display = 'block';
    if (profileBtn) profileBtn.classList.remove('has-avatar');
  }

  updateProfileButtonVisibility();
  updateChatHistoryUserInfo();
}

// Load profile image on page load
loadProfileImage();
updateNavProfile();

// Show/hide profile button content and dropdown based on authentication
function updateProfileButtonVisibility() {
  const profileBtn = document.getElementById('profileBtn');
  const profileAvatarImg = document.getElementById('profileAvatarImg');
  const profileBtnIcon = document.getElementById('profileBtnIcon');
  const profileDropdownAuth = document.getElementById('profileDropdownAuth');
  const profileDropdownGuest = document.getElementById('profileDropdownGuest');
  
  if (isAuthenticated) {
    // Show avatar if available, otherwise show default icon
    if (profileAvatarImg && profileAvatarImg.src && profileAvatarImg.src !== window.location.href) {
      profileAvatarImg.style.display = 'block';
      if (profileBtnIcon) profileBtnIcon.style.display = 'none';
    } else {
      if (profileAvatarImg) profileAvatarImg.style.display = 'none';
      if (profileBtnIcon) profileBtnIcon.style.display = 'block';
    }
    // Show authenticated menu
    if (profileDropdownAuth) profileDropdownAuth.style.display = 'block';
    if (profileDropdownGuest) profileDropdownGuest.style.display = 'none';
  } else {
    // Always show default icon when not authenticated
    if (profileAvatarImg) profileAvatarImg.style.display = 'none';
    if (profileBtnIcon) profileBtnIcon.style.display = 'block';
    // Show guest menu
    if (profileDropdownAuth) profileDropdownAuth.style.display = 'none';
    if (profileDropdownGuest) profileDropdownGuest.style.display = 'block';
  }
  updateChatHistoryUserInfo();
}

// Update profile button visibility on page load
updateProfileButtonVisibility();

// Sync the chat history panel user info section
function updateChatHistoryUserInfo() {
  const userInfo = document.getElementById('chatHistoryUserInfo');
  const avatarImg = document.getElementById('chatHistoryAvatarImg');
  const avatarIcon = document.getElementById('chatHistoryAvatarIcon');
  const userName = document.getElementById('chatHistoryUserName');
  if (!userInfo) return;

  if (isAuthenticated) {
    userInfo.href = DJANGO_URLS.profile;
    if (userName) userName.textContent = currentUsername || 'My Profile';
    const profileAvatarImg = document.getElementById('profileAvatarImg');
    if (avatarImg && profileAvatarImg && profileAvatarImg.src && profileAvatarImg.src !== window.location.href) {
      avatarImg.src = profileAvatarImg.src;
      avatarImg.style.display = 'block';
      if (avatarIcon) avatarIcon.style.display = 'none';
    } else {
      if (avatarImg) avatarImg.style.display = 'none';
      if (avatarIcon) avatarIcon.style.display = 'block';
    }
  } else {
    userInfo.href = DJANGO_URLS.signIn;
    if (userName) userName.textContent = 'Sign In';
    if (avatarImg) avatarImg.style.display = 'none';
    if (avatarIcon) avatarIcon.style.display = 'block';
  }
}
updateChatHistoryUserInfo();

// Load chat sessions from the database for authenticated users
loadServerSessions();

// Avatar is now loaded from server; no localStorage listener needed.

// Show sign-in prompt modal if user is not authenticated
window.addEventListener('DOMContentLoaded', function() {
  // Update profile button visibility based on initial auth state
  updateProfileButtonVisibility();
  
  // Check if user dismissed the prompt in this session
  const promptDismissed = sessionStorage.getItem('signinPromptDismissed');
  
  // Show prompt if user is not authenticated and hasn't dismissed it
  if (!isAuthenticated && !promptDismissed) {
    // Small delay to let page load first
    setTimeout(() => {
      showSignInPrompt();
    }, 500);
  }
});

// Profile dropdown
const profileBtn = document.getElementById('profileBtn');
const profileDropdown = document.getElementById('profileDropdown');

if (profileBtn && profileDropdown) {
  profileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    profileBtn.classList.toggle('active');
    profileDropdown.classList.toggle('active');
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
      profileBtn.classList.remove('active');
      profileDropdown.classList.remove('active');
    }
  });
  
  // Handle dropdown item clicks using event delegation
  profileDropdown.addEventListener('click', (e) => {
    const item = e.target.closest('.profile-dropdown-item');
    if (!item) return;
    
    const action = item.dataset.action;
    
    if (action === 'profile') {
      window.location.href = DJANGO_URLS.profile;
      return;
    } else if (action === 'ratings') {
      window.location.href = DJANGO_URLS.myRatings;
      return;
    } else if (action === 'settings') {
      window.location.href = DJANGO_URLS.settings;
      return;
    } else if (action === 'signout') {
      handleSignOut();
    } else if (action === 'signin') {
      window.location.href = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname);
      return;
    }
    
    profileBtn.classList.remove('active');
    profileDropdown.classList.remove('active');
  });
}

function dismissChat() {
  chatOverlay.classList.remove('visible');
  chatBackdrop.classList.remove('visible');
}
chatBackdrop.addEventListener('click', dismissChat);
map.on('click', () => {
  if (chatHistoryPanel.classList.contains('open')) closeChatHistoryPanel();
  if (chatOverlay.classList.contains('visible')) { setTimeout(dismissChat, 100); }
});
map.on('movestart', () => { document.getElementById('coordsDisplay').classList.remove('visible'); });
map.on('moveend', () => { if (!userMarker && document.getElementById('coordsDisplay').classList.contains('visible')) updateCoords(map.getCenter().lat, map.getCenter().lng); });

// ── Rating Modal ──
let currentRatingStation = null;
let ratingData = { safety: 0, cleanliness: 0, staff: null, description: '', photo: null, mediaFile: null };

function updateOverallRating() {
  const overallRatingDisplay = document.getElementById('overallRatingDisplay');
  if (!overallRatingDisplay) return;
  
  if (ratingData.safety > 0 && ratingData.cleanliness > 0) {
    const overall = Math.round((ratingData.safety + ratingData.cleanliness) / 2);
    overallRatingDisplay.innerHTML = '';
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.className = 'star';
      star.style.fontSize = '20px';
      star.style.color = i < overall ? 'var(--accent)' : 'var(--text-muted)';
      if (i < overall) star.classList.add('filled');
      star.textContent = '★';
      overallRatingDisplay.appendChild(star);
    }
  } else {
    overallRatingDisplay.innerHTML = '';
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.className = 'star';
      star.style.fontSize = '20px';
      star.style.color = 'var(--text-muted)';
      star.textContent = '★';
      overallRatingDisplay.appendChild(star);
    }
  }
}

function updateSubmitButton() {
  const ratingSubmit = document.getElementById('ratingSubmit');
  if (ratingSubmit) {
    // Enable if Safety and Cleanliness are rated (both > 0)
    ratingSubmit.disabled = !(ratingData.safety > 0 && ratingData.cleanliness > 0);
  }
}

function openRatingModal(stationName) {
  if (!isAuthenticated) {
    promptSignIn('rate this station');
    return;
  }

  const ratingModal = document.getElementById('ratingModal');
  const ratingModalTitle = document.getElementById('ratingModalTitle');

  if (!ratingModal || !ratingModalTitle) {
    console.error('Rating modal elements not found');
    return;
  }
  
  currentRatingStation = stationName;
  ratingModalTitle.textContent = `Rate ${stationName}`;
  ratingData = { safety: 0, cleanliness: 0, staff: null, description: '', photo: null, mediaFile: null };
  
  // Reset description and photo
  const descriptionInput = document.getElementById('ratingDescription');
  const photoInput = document.getElementById('ratingPhotoInput');
  const photoPreview = document.getElementById('ratingPhotoPreview');
  const photoImgEl = document.getElementById('ratingPhotoImg');
  const photoVideoEl = document.getElementById('ratingVideoEl');
  const photoDropZone = document.getElementById('ratingPhotoBtn');
  if (descriptionInput) descriptionInput.value = '';
  if (photoInput) photoInput.value = '';
  if (photoImgEl) { photoImgEl.src = ''; photoImgEl.style.display = 'none'; }
  if (photoVideoEl) { photoVideoEl.src = ''; photoVideoEl.style.display = 'none'; }
  if (photoPreview) photoPreview.classList.remove('has-media');
  if (photoDropZone) photoDropZone.style.display = '';
  
  // Reset Safety stars
  document.querySelectorAll('[data-category="safety"] .rating-star-btn').forEach((btn, i) => {
    btn.classList.remove('active');
    btn.onclick = function() {
      ratingData.safety = i + 1;
      document.querySelectorAll('[data-category="safety"] .rating-star-btn').forEach((b, idx) => {
        b.classList.toggle('active', idx < ratingData.safety);
      });
      updateOverallRating();
      updateSubmitButton();
    };
  });
  
  // Reset Cleanliness stars
  document.querySelectorAll('[data-category="cleanliness"] .rating-star-btn').forEach((btn, i) => {
    btn.classList.remove('active');
    btn.onclick = function() {
      ratingData.cleanliness = i + 1;
      document.querySelectorAll('[data-category="cleanliness"] .rating-star-btn').forEach((b, idx) => {
        b.classList.toggle('active', idx < ratingData.cleanliness);
      });
      updateOverallRating();
      updateSubmitButton();
    };
  });
  
  // Reset Staff thumbs
  document.querySelectorAll('[data-category="staff"] .rating-thumb-btn').forEach(btn => {
    btn.classList.remove('active');
    btn.onclick = function() {
      document.querySelectorAll('[data-category="staff"] .rating-thumb-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      ratingData.staff = this.dataset.value;
    };
  });
  
  updateOverallRating();
  updateSubmitButton();
  ratingModal.classList.add('active');
}

function closeRatingModal() {
  const ratingModal = document.getElementById('ratingModal');
  if (ratingModal) {
    ratingModal.classList.remove('active');
  }
  currentRatingStation = null;
  ratingData = { safety: 0, cleanliness: 0, staff: null, description: '', photo: null, mediaFile: null };
  // Reset photo upload UI
  const photoInput = document.getElementById('ratingPhotoInput');
  const photoPreview = document.getElementById('ratingPhotoPreview');
  const photoImg = document.getElementById('ratingPhotoImg');
  const photoVid = document.getElementById('ratingVideoEl');
  const photoBtn = document.getElementById('ratingPhotoBtn');
  if (photoInput) photoInput.value = '';
  if (photoImg) { photoImg.src = ''; photoImg.style.display = 'none'; }
  if (photoVid) { photoVid.src = ''; photoVid.style.display = 'none'; }
  if (photoPreview) photoPreview.classList.remove('has-media');
  if (photoBtn) photoBtn.style.display = '';
}

// Initialize rating modal event listeners (script is at end of body, so elements exist)
const ratingModal = document.getElementById('ratingModal');
const ratingModalClose = document.getElementById('ratingModalClose');
const ratingSubmit = document.getElementById('ratingSubmit');

if (ratingModalClose) {
  ratingModalClose.addEventListener('click', closeRatingModal);
}

if (ratingModal) {
  ratingModal.addEventListener('click', (e) => {
    if (e.target === ratingModal) closeRatingModal();
  });
}

// Photo / Video upload handling
const ratingPhotoBtn = document.getElementById('ratingPhotoBtn');
const ratingPhotoInput = document.getElementById('ratingPhotoInput');
const ratingPhotoPreview = document.getElementById('ratingPhotoPreview');
const ratingPhotoImg = document.getElementById('ratingPhotoImg');
const ratingVideoEl = document.getElementById('ratingVideoEl');
const ratingDescription = document.getElementById('ratingDescription');

const MAX_VIDEO_DURATION = 300; // 5 minutes
const MAX_VIDEO_BYTES = 150 * 1024 * 1024;
const MAX_PHOTO_BYTES = 10 * 1024 * 1024;

function showMediaPreview(file) {
  const isVideo = file.type.startsWith('video/');
  ratingData.mediaFile = file;
  ratingData.photo = null;
  if (ratingPhotoBtn) ratingPhotoBtn.style.display = 'none';
  if (ratingPhotoPreview) ratingPhotoPreview.classList.add('has-media');
  if (isVideo) {
    if (ratingPhotoImg) ratingPhotoImg.style.display = 'none';
    if (ratingVideoEl) {
      ratingVideoEl.src = URL.createObjectURL(file);
      ratingVideoEl.style.display = 'block';
    }
  } else {
    if (ratingVideoEl) { ratingVideoEl.style.display = 'none'; ratingVideoEl.src = ''; }
    if (ratingPhotoImg) { ratingPhotoImg.src = URL.createObjectURL(file); ratingPhotoImg.style.display = 'block'; }
  }
}

if (ratingPhotoBtn && ratingPhotoInput) {
  ratingPhotoBtn.addEventListener('click', () => ratingPhotoInput.click());

  ratingPhotoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const isVideo = file.type.startsWith('video/');
    const isImage = file.type.startsWith('image/');
    if (!isVideo && !isImage) { showMapToast('Only images and videos are allowed.', 'error'); ratingPhotoInput.value = ''; return; }
    if (isImage && file.size > MAX_PHOTO_BYTES) { showMapToast('Photo must be under 10 MB.', 'error'); ratingPhotoInput.value = ''; return; }
    if (isVideo && file.size > MAX_VIDEO_BYTES) { showMapToast('Video must be under 150 MB.', 'error'); ratingPhotoInput.value = ''; return; }
    if (isVideo) {
      const tempUrl = URL.createObjectURL(file);
      const tempVid = document.createElement('video');
      tempVid.preload = 'metadata';
      tempVid.src = tempUrl;
      tempVid.onloadedmetadata = () => {
        URL.revokeObjectURL(tempUrl);
        if (tempVid.duration > MAX_VIDEO_DURATION) {
          showMapToast('Video must be 5 minutes or less.', 'error');
          ratingPhotoInput.value = '';
          return;
        }
        showMediaPreview(file);
      };
      tempVid.onerror = () => { URL.revokeObjectURL(tempUrl); showMapToast('Could not read video file.', 'error'); ratingPhotoInput.value = ''; };
    } else {
      showMediaPreview(file);
    }
  });
}

if (ratingDescription) {
  ratingDescription.addEventListener('input', (e) => { ratingData.description = e.target.value; });
}

window.removeRatingPhoto = function() {
  ratingData.photo = null;
  ratingData.mediaFile = null;
  if (ratingPhotoInput) ratingPhotoInput.value = '';
  if (ratingPhotoImg) { ratingPhotoImg.src = ''; ratingPhotoImg.style.display = 'none'; }
  if (ratingVideoEl) { ratingVideoEl.src = ''; ratingVideoEl.style.display = 'none'; }
  if (ratingPhotoPreview) ratingPhotoPreview.classList.remove('has-media');
  if (ratingPhotoBtn) ratingPhotoBtn.style.display = '';
};

if (ratingSubmit) {
  ratingSubmit.addEventListener('click', async () => {
    if (!currentRatingStation || ratingData.safety === 0 || ratingData.cleanliness === 0) {
      showMapToast('Please rate Safety and Cleanliness', 'error');
      return;
    }
    
    // Check authentication before saving
    if (!isAuthenticated) {
      const authStatus = await checkAuthentication();
      if (!authStatus) {
        const wantsToSignIn = promptSignIn('submit your rating');
        if (wantsToSignIn) {
          return; // Will redirect to sign in
        }
        return; // User chose not to sign in
      }
    }
    
    // Get description
    if (ratingDescription) {
      ratingData.description = ratingDescription.value.trim();
    }
    
    // Save rating (will check auth again inside)
    const saved = await saveRating(currentRatingStation, ratingData);
    
    if (saved) {
      const ratedStation = currentRatingStation;
      closeRatingModal();
      // Refresh markers and list to show updated ratings
      createMarkers(activeFilter);
      const searchInput = document.getElementById('stationSearch');
      renderStationList(searchInput ? searchInput.value : '');
      showMapToast(`Rated ${ratedStation}`, 'success');
    } else {
      // Rating not saved - user may have been redirected to sign in
      // Don't close modal if they're coming back
      if (isAuthenticated) {
        showMapToast('Failed to save rating. Please try again.', 'error');
      }
    }
  });
}

</script>
</body>
</html>