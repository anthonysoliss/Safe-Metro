<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>My Ratings ‚Äî Metro Safe LA</title>
<script>
  (function(){var t=localStorage.getItem('ratemetro-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})();
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0d0d18;
    --surface: rgba(20, 20, 35, 0.88);
    --surface-light: rgba(28, 28, 48, 0.82);
    --accent: #f5c518;
    --accent-glow: rgba(245, 197, 24, 0.3);
    --danger: #ff3b30;
    --text-primary: #f0f0f5;
    --text-secondary: rgba(255, 255, 255, 0.55);
    --text-muted: rgba(255, 255, 255, 0.3);
    --border: rgba(255, 255, 255, 0.07);
  }

  [data-theme="light"] {
    --bg-dark: #f2f2f7;
    --surface: rgba(255, 255, 255, 0.95);
    --surface-light: rgba(240, 240, 245, 0.9);
    --accent: #d4a017;
    --accent-glow: rgba(212, 160, 23, 0.2);
    --danger: #ff3b30;
    --text-primary: #1c1c1e;
    --text-secondary: rgba(0, 0, 0, 0.55);
    --text-muted: rgba(0, 0, 0, 0.35);
    --border: rgba(0, 0, 0, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(245,197,24,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(245,197,24,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
  .nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(10,10,15,0.88);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    animation: slideDown 0.4s ease both;
  }
  .nav-back {
    width: 40px; height: 40px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
  }
  .nav-back:hover { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
  .nav-back svg { width: 16px; height: 16px; stroke: var(--text-secondary); fill: none; stroke-width: 2.5; }
  .nav-back:hover svg { stroke: var(--accent); }
  .nav-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
  .nav-count {
    margin-left: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-muted);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 5px 12px;
  }
  .nav-count span { color: var(--accent); font-weight: 600; }

  /* ‚îÄ‚îÄ Page ‚îÄ‚îÄ */
  .page {
    padding-top: 72px;
    padding-bottom: 40px;
    max-width: 560px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  /* ‚îÄ‚îÄ Summary Strip ‚îÄ‚îÄ */
  .summary-strip {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    padding: 16px;
    animation: slideDown 0.5s ease 0.1s both;
  }
  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 12px;
    text-align: center;
    backdrop-filter: blur(20px);
    transition: all 0.2s ease;
    cursor: default;
  }
  .summary-card:hover { border-color: rgba(245,197,24,0.2); background: var(--surface-light); }
  .summary-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 22px;
    font-weight: 500;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .summary-lbl {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  /* ‚îÄ‚îÄ Filter Bar ‚îÄ‚îÄ */
  .filter-bar {
    display: flex;
    gap: 8px;
    padding: 0 16px 12px;
    overflow-x: auto;
    scrollbar-width: none;
    animation: slideDown 0.5s ease 0.15s both;
  }
  .filter-bar::-webkit-scrollbar { display: none; }

  .filter-chip {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.4px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1.5px solid transparent;
    background: var(--surface);
    color: var(--text-secondary);
    user-select: none;
    text-transform: uppercase;
    backdrop-filter: blur(12px);
  }
  .filter-chip:hover { background: var(--surface-light); color: var(--text-primary); }
  .filter-chip.active {
    border-color: var(--accent);
    background: rgba(245,197,24,0.1);
    color: var(--accent);
  }
  .filter-chip .chip-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Sort Row ‚îÄ‚îÄ */
  .sort-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px 12px;
    animation: slideDown 0.5s ease 0.18s both;
  }
  .sort-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }
  .sort-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 10px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    -webkit-appearance: none;
    padding-right: 24px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.35)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }
  .sort-select:focus { border-color: rgba(245,197,24,0.4); }
  .sort-select option { background: #141423; }

  /* ‚îÄ‚îÄ Rating Cards ‚îÄ‚îÄ */
  .ratings-list { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }

  .rating-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    backdrop-filter: blur(20px);
    transition: all 0.2s ease;
    animation: cardIn 0.4s ease both;
    cursor: pointer;
  }
  .rating-card:hover {
    border-color: rgba(245,197,24,0.2);
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    transform: translateY(-1px);
  }

  .card-top {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px 10px;
    border-bottom: 1px solid var(--border);
  }
  .card-line-bar {
    width: 4px;
    border-radius: 2px;
    align-self: stretch;
    flex-shrink: 0;
    min-height: 38px;
  }
  .card-station { flex: 1; min-width: 0; }
  .card-station-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
  }
  .card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .card-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 500;
  }
  .card-line-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .card-overall {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
  }
  .card-overall-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 500;
    color: var(--accent);
    line-height: 1;
  }
  .card-overall-stars { display: flex; gap: 1px; }
  .card-overall-stars .star { font-size: 11px; color: var(--text-muted); }
  .card-overall-stars .star.filled { color: var(--accent); }

  .card-scores {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    padding: 12px 16px;
    gap: 8px;
  }
  .score-item { display: flex; flex-direction: column; gap: 5px; }
  .score-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .score-label .emoji { font-size: 11px; }
  .score-bar-wrap {
    height: 4px;
    background: rgba(255,255,255,0.06);
    border-radius: 2px;
    overflow: hidden;
  }
  .score-bar {
    height: 100%;
    border-radius: 2px;
    background: var(--accent);
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
  }
  .score-val {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    font-family: 'JetBrains Mono', monospace;
  }
  .score-staff-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
  }
  .score-staff-pill.yes { background: rgba(88,167,56,0.15); color: #58a738; border: 1px solid rgba(88,167,56,0.25); }
  .score-staff-pill.no { background: rgba(255,59,48,0.1); color: var(--danger); border: 1px solid rgba(255,59,48,0.2); }

  /* Description */
  .card-description {
    padding: 0 16px 12px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    border-top: 1px solid var(--border);
    padding-top: 10px;
  }

  /* Photo */
  .card-photo {
    padding: 0 16px 14px;
  }
  .card-photo img, .card-photo video {
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--border);
    display: block;
    max-height: 200px;
    object-fit: cover;
    cursor: pointer;
  }

  /* Lightbox */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.92);
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .lightbox.open { display: flex; }
  .lightbox-img {
    max-width: 100%;
    max-height: 90dvh;
    border-radius: 10px;
    object-fit: contain;
    box-shadow: 0 8px 48px rgba(0,0,0,0.6);
  }
  .lightbox-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.15);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    line-height: 36px;
    text-align: center;
    cursor: pointer;
    backdrop-filter: blur(8px);
  }

  /* Card actions */
  .card-actions {
    display: flex;
    border-top: 1px solid var(--border);
  }
  .card-action-btn {
    flex: 1;
    padding: 11px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    letter-spacing: 0.4px;
    text-transform: uppercase;
  }
  .card-action-btn:not(:last-child) { border-right: 1px solid var(--border); }
  .card-action-btn:hover { background: rgba(255,255,255,0.04); color: var(--text-primary); }
  .card-action-btn.delete:hover { background: rgba(255,59,48,0.07); color: var(--danger); }
  .card-action-btn svg { width: 13px; height: 13px; stroke: currentColor; fill: none; stroke-width: 2; }

  /* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
  .empty-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 32px;
    text-align: center;
    animation: slideUp 0.5s ease both;
  }
  .empty-icon-ring {
    width: 80px; height: 80px;
    border: 1.5px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    margin-bottom: 20px;
    background: var(--surface);
  }
  .empty-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
  .empty-sub { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .empty-cta {
    margin-top: 20px;
    padding: 10px 24px;
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 0.4px;
  }
  .empty-cta:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }

  /* ‚îÄ‚îÄ Delete confirm toast ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    z-index: 200;
    background: #1a1a2a;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    transition: transform 0.35s cubic-bezier(0.16,1,0.3,1);
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast-msg { font-size: 13px; font-weight: 600; color: var(--text-primary); }
  .toast-actions { display: flex; gap: 8px; }
  .toast-btn {
    padding: 6px 14px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .toast-btn.cancel { background: rgba(255,255,255,0.08); color: var(--text-secondary); }
  .toast-btn.cancel:hover { background: rgba(255,255,255,0.14); }
  .toast-btn.confirm { background: var(--danger); color: #fff; }
  .toast-btn.confirm:hover { box-shadow: 0 0 12px rgba(255,59,48,0.4); }

  /* Confirmation Modal */
  .confirm-modal {
    position: fixed; inset: 0; z-index: 4000;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .confirm-modal.active { opacity: 1; pointer-events: auto; }
  .confirm-modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    position: relative;
    transform: scale(0.95);
    transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  .confirm-modal.active .confirm-modal-content { transform: scale(1); }
  .confirm-modal-header {
    margin-bottom: 24px;
  }
  .confirm-modal-header h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .confirm-modal-header p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .confirm-modal-actions {
    display: flex;
    gap: 12px;
  }
  .confirm-modal-btn {
    flex: 1;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .confirm-modal-btn.cancel {
    background: var(--surface-light);
    color: var(--text-primary);
    border-color: var(--border);
  }
  .confirm-modal-btn.cancel:hover {
    border-color: var(--text-muted);
    background: rgba(255, 255, 255, 0.1);
  }
  .confirm-modal-btn.confirm {
    background: var(--accent);
    color: var(--bg-dark);
    border-color: var(--accent);
  }
  .confirm-modal-btn.confirm:hover {
    background: #f5d030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 197, 24, 0.3);
  }
  .confirm-modal-btn.danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }
  .confirm-modal-btn.danger:hover {
    background: #ff5252;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
  }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes slideDown { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes cardIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ Light Mode Overrides ‚îÄ‚îÄ */
  [data-theme="light"] body::before {
    background-image:
      linear-gradient(rgba(0,0,0,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,0,0,0.04) 1px, transparent 1px);
  }
  [data-theme="light"] .nav {
    background: rgba(242,242,247,0.92);
    border-bottom-color: rgba(0,0,0,0.08);
  }
  [data-theme="light"] .nav-back { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
  [data-theme="light"] .nav-back svg { stroke: rgba(0,0,0,0.5); }
  [data-theme="light"] .summary-card { background: var(--surface); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  [data-theme="light"] .summary-card:hover { border-color: rgba(212,160,23,0.25); background: var(--surface-light); }
  [data-theme="light"] .filter-chip { background: var(--surface); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  [data-theme="light"] .filter-chip:hover { background: var(--surface-light); }
  [data-theme="light"] .filter-chip.active { background: rgba(212,160,23,0.1); border-color: var(--accent); }
  [data-theme="light"] .sort-select {
    background-color: var(--surface);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='rgba(0,0,0,0.35)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  }
  [data-theme="light"] .sort-select option { background: #fff; color: #1c1c1e; }
  [data-theme="light"] .rating-card { background: var(--surface); box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  [data-theme="light"] .rating-card:hover { border-color: rgba(212,160,23,0.25); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
  [data-theme="light"] .score-bar-wrap { background: rgba(0,0,0,0.06); }
  [data-theme="light"] .card-action-btn:hover { background: rgba(0,0,0,0.04); }
  [data-theme="light"] .card-action-btn.delete:hover { background: rgba(255,59,48,0.06); }
  [data-theme="light"] .empty-cta { color: #fff; }
  [data-theme="light"] .toast { background: #fff; border-color: rgba(0,0,0,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
  [data-theme="light"] .toast-btn.cancel { background: rgba(0,0,0,0.06); color: var(--text-secondary); }
  [data-theme="light"] .toast-btn.cancel:hover { background: rgba(0,0,0,0.1); }
  [data-theme="light"] .confirm-modal { background: rgba(0,0,0,0.3); }
  [data-theme="light"] .confirm-modal-content { background: var(--surface); box-shadow: 0 24px 64px rgba(0,0,0,0.15); }
  [data-theme="light"] .confirm-modal-btn.cancel { background: rgba(0,0,0,0.05); color: var(--text-secondary); border-color: var(--border); }
  [data-theme="light"] .confirm-modal-btn.cancel:hover { background: rgba(0,0,0,0.08); }
  [data-theme="light"] .confirm-modal-btn.confirm { color: #fff; }
  [data-theme="light"] .confirm-modal-btn.danger { color: #fff; }
</style>
</head>
<body>

<!-- Nav -->
<nav class="nav">
  <a class="nav-back" href="/">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
  </a>
  <div class="nav-title">My Ratings</div>
  <div class="nav-count" id="navCount"><span>{{ ratings_count|default:0 }}</span> total</div>
</nav>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-msg">Delete this rating?</div>
  <div class="toast-actions">
    <button class="toast-btn cancel" onclick="cancelDelete()">Cancel</button>
    <button class="toast-btn confirm" onclick="confirmDelete()">Delete</button>
  </div>
</div>

<div class="page">
  <!-- Summary strip -->
  <div class="summary-strip">
    <div class="summary-card">
      <div class="summary-val" id="sumTotal">0</div>
      <div class="summary-lbl">Ratings</div>
    </div>
    <div class="summary-card">
      <div class="summary-val" id="sumSafety">‚Äî</div>
      <div class="summary-lbl">Avg Safety</div>
    </div>
    <div class="summary-card">
      <div class="summary-val" id="sumClean">‚Äî</div>
      <div class="summary-lbl">Avg Clean</div>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar" id="filterBar">
    <div class="filter-chip active" data-line="all">All Lines</div>
  </div>

  <!-- Sort row -->
  <div class="sort-row">
    <div class="sort-label" id="sortResultCount">Showing all</div>
    <select class="sort-select" id="sortSelect" onchange="applyFilters()">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="highest">Highest Rated</option>
      <option value="lowest">Lowest Rated</option>
    </select>
  </div>

  <!-- Cards -->
  <div class="ratings-list" id="ratingsList"></div>
</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-modal-content">
    <div class="confirm-modal-header">
      <h3 id="confirmModalTitle">Confirm Action</h3>
      <p id="confirmModalMessage">Are you sure you want to proceed?</p>
    </div>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirmModalCancel" onclick="closeConfirmModal()">
        Cancel
      </button>
      <button class="confirm-modal-btn confirm" id="confirmModalConfirm" onclick="executeConfirmAction()">
        Confirm
      </button>
    </div>
  </div>
</div>

<script>
// Django URLs injected for JavaScript
const DJANGO_URLS = {
  map: '{% url "ratemetroapp:map" %}',
  profile: '{% url "ratemetroapp:profile" %}',
  myRatings: '{% url "ratemetroapp:my_ratings" %}',
  settings: '{% url "ratemetroapp:settings" %}',
  signIn: '{% url "ratemetroapp:sign_in" %}',
  deleteRating: '{% url "ratemetroapp:api_delete_rating" %}',
};

// Helper function to get CSRF token
function getCSRFToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  if (token) return token.value;
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  return '';
}
const lineColors = {
  A:'#0072bc', B:'#e3242b', C:'#58a738', D:'#a05da5',
  E:'#fdb913', G:'#f58220', J:'#b5a07e', K:'#e96bb0', L:'#c4a73f'
};
const lineTextColors = {
  A:'#fff', B:'#fff', C:'#fff', D:'#fff',
  E:'#000', G:'#fff', J:'#fff', K:'#fff', L:'#fff'
};

// Load ratings from server (database) instead of localStorage
const serverRatings = {{ ratings_json|safe }};

// Convert server ratings to format expected by the UI
function processServerRatings(serverRatings) {
  return serverRatings.map(r => ({
    station: r.station,
    lines: r.lines || [],
    safety: r.safety,
    cleanliness: r.cleanliness,
    staff: r.staff || '',
    description: r.description || '',
    media: r.media || [],
    timestamp: r.timestamp,
    _id: `rating_${r.id}`, // Use database ID
  }));
}

// Use server ratings - no demo data
const allRatings = processServerRatings(serverRatings);

let activeLineFilter = 'all';
let pendingDeleteId = null;

// Guess line from station name (for real data that doesn't store line)
function guessLine(stationName) {
  // rough heuristic based on station list from main app
  const map = {
    'Union Station':'B','Civic Center':'B','Pershing Square':'B','7th St':'A',
    'Hollywood':'B','North Hollywood':'B','Westlake':'B','Vermont':'B',
    'Universal':'B','Wilshire':'D','Century City':'D','Westwood':'D',
    'Culver City':'E','Santa Monica':'E','Expo':'E','Palms':'E',
    'Pico':'A','Long Beach':'A','Compton':'A','Willowbrook':'A',
    'Redondo Beach':'C','Aviation':'C','Norwalk':'C',
    'Chinatown':'L','Pasadena':'L','Arcadia':'L','Azusa':'L',
    'Chatsworth':'G','Van Nuys':'G','Reseda':'G',
    'Leimert':'K','Hyde Park':'K','Inglewood':'K',
  };
  for (const [key, line] of Object.entries(map)) {
    if (stationName.includes(key)) return line;
  }
  return 'A';
}

function getOverall(r) {
  if (r.safety > 0 && r.cleanliness > 0) return Math.round((r.safety + r.cleanliness) / 2);
  return r.safety || r.cleanliness || 0;
}

function renderStars(n, size = '12px') {
  return Array.from({length:5}, (_,i) =>
    `<span class="star${i < n ? ' filled' : ''}" style="font-size:${size}">‚òÖ</span>`
  ).join('');
}

function formatDate(ts) {
  const d = new Date(ts);
  const now = new Date();
  const diff = (now - d) / 1000;
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  if (diff < 604800) return `${Math.floor(diff/86400)}d ago`;
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric', timeZone: 'America/Los_Angeles' });
}

function buildFilters() {
  const lines = new Set();
  allRatings.forEach(r => {
    const ls = r.lines || [];
    ls.forEach(l => lines.add(l));
  });
  const bar = document.getElementById('filterBar');
  bar.innerHTML = `<div class="filter-chip active" data-line="all">All Lines</div>`;
  [...lines].sort().forEach(line => {
    const color = lineColors[line] || '#f5c518';
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.dataset.line = line;
    chip.innerHTML = `<div class="chip-dot" style="background:${color}"></div>${line} Line`;
    bar.appendChild(chip);
  });
  bar.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      bar.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeLineFilter = chip.dataset.line;
      applyFilters();
    });
  });
}

function buildSummary(ratings) {
  const total = ratings.length;
  const safetyArr = ratings.filter(r => r.safety > 0).map(r => r.safety);
  const cleanArr = ratings.filter(r => r.cleanliness > 0).map(r => r.cleanliness);
  const safetyAvg = safetyArr.length ? (safetyArr.reduce((a,b)=>a+b,0)/safetyArr.length).toFixed(1) : '‚Äî';
  const cleanAvg = cleanArr.length ? (cleanArr.reduce((a,b)=>a+b,0)/cleanArr.length).toFixed(1) : '‚Äî';
  document.getElementById('sumTotal').textContent = total;
  document.getElementById('sumSafety').textContent = safetyAvg;
  document.getElementById('sumClean').textContent = cleanAvg;
  document.getElementById('navCount').innerHTML = `<span>${total}</span> total`;
}

function applyFilters() {
  const sort = document.getElementById('sortSelect').value;
  let filtered = [...allRatings];

  if (activeLineFilter !== 'all') {
    filtered = filtered.filter(r => {
      const ls = r.lines || [];
      return ls.includes(activeLineFilter);
    });
  }

  if (sort === 'newest') filtered.sort((a,b) => (b.timestamp||0)-(a.timestamp||0));
  else if (sort === 'oldest') filtered.sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
  else if (sort === 'highest') filtered.sort((a,b) => getOverall(b)-getOverall(a));
  else if (sort === 'lowest') filtered.sort((a,b) => getOverall(a)-getOverall(b));

  document.getElementById('sortResultCount').textContent =
    filtered.length === allRatings.length
      ? `Showing all ${filtered.length}`
      : `${filtered.length} of ${allRatings.length}`;

  renderCards(filtered);
  buildSummary(filtered);
}

function renderCards(ratings) {
  const list = document.getElementById('ratingsList');
  list.innerHTML = '';

  if (!ratings.length) {
    list.innerHTML = `<div class="empty-wrap">
      <div class="empty-icon-ring">‚≠ê</div>
      <div class="empty-title">No ratings yet</div>
      <div class="empty-sub">Head back to the map and rate a station<br>to see it here.</div>
      <button class="empty-cta" onclick="window.location.href = DJANGO_URLS.map">Open Map</button>
    </div>`;
    return;
  }

  ratings.forEach((r, idx) => {
    const overall = getOverall(r);
    const lines = r.lines || [];
    const primaryLine = lines.length > 0 ? lines[0] : 'A';
    const color = lineColors[primaryLine] || '#f5c518';
    const textColor = lineTextColors[primaryLine] || '#fff';
    const date = formatDate(r.timestamp || Date.now());
    const safetyPct = ((r.safety || 0) / 5 * 100);
    const cleanPct = ((r.cleanliness || 0) / 5 * 100);

    const staffHTML = r.staff
      ? `<span class="score-staff-pill ${r.staff}">${r.staff === 'yes' ? 'üëç Seen' : 'üëé None'}</span>`
      : `<span style="color:var(--text-muted);font-size:11px">‚Äî</span>`;

    const badgesHTML = lines.map(l =>
      `<span class="card-line-badge" style="background:${lineColors[l]}22;color:${lineColors[l]}">${l}</span>`
    ).join('');

    const descHTML = r.description
      ? `<div class="card-description">${r.description}</div>` : '';

    const photoHTML = (r.media && r.media.length)
      ? r.media.map(m => `<div class="card-photo">${m.type === 'video' ? `<video src="${m.url}" controls playsinline style="width:100%;border-radius:10px;max-height:200px;"></video>` : `<img src="${m.url}" alt="Station photo" loading="lazy" onclick="openLightbox(this.src)">`}</div>`).join('') : '';

    const card = document.createElement('div');
    card.className = 'rating-card';
    card.style.animationDelay = `${idx * 0.05}s`;
    card.dataset.id = r._id;
    card.innerHTML = `
      <div class="card-top">
        <div class="card-line-bar" style="background:${color}"></div>
        <div class="card-station">
          <div class="card-station-name">${r.station}</div>
          <div class="card-meta">
            <span class="card-date">${date}</span>
            ${badgesHTML}
          </div>
        </div>
        <div class="card-overall">
          <div class="card-overall-val">${overall}</div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:1px">
            ${renderStars(overall, '10px')}
            <span style="font-size:9px;color:var(--text-muted);font-weight:600">/ 5</span>
          </div>
        </div>
      </div>

      <div class="card-scores">
        <div class="score-item">
          <div class="score-label"><span class="emoji">üõ°Ô∏è</span> Safety</div>
          <div class="score-bar-wrap"><div class="score-bar" style="width:${safetyPct}%"></div></div>
          <div class="score-val">${r.safety || 0}/5</div>
        </div>
        <div class="score-item">
          <div class="score-label"><span class="emoji">üßπ</span> Clean</div>
          <div class="score-bar-wrap"><div class="score-bar" style="width:${cleanPct}%"></div></div>
          <div class="score-val">${r.cleanliness || 0}/5</div>
        </div>
        <div class="score-item">
          <div class="score-label"><span class="emoji">üëÆ</span> Staff</div>
          <div style="margin-top:4px">${staffHTML}</div>
        </div>
      </div>

      ${descHTML}${photoHTML}

      <div class="card-actions">
        <button class="card-action-btn" onclick="viewOnMap('${r.station.replace(/'/g,"\\'")}')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          View on Map
        </button>
        <button class="card-action-btn" onclick="shareRating(this, '${r.station.replace(/'/g,"\\'")}', ${overall})">
          <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Share
        </button>
        <button class="card-action-btn delete" onclick="deleteRating('${(r._id || '').replace(/'/g,"\\'")}', this)">
          <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          Delete
        </button>
      </div>
    `;
    list.appendChild(card);
  });

  // Animate bars after paint
  requestAnimationFrame(() => {
    list.querySelectorAll('.score-bar').forEach(bar => {
      const w = bar.style.width;
      bar.style.width = '0%';
      setTimeout(() => { bar.style.width = w; }, 80);
    });
  });
}

function viewOnMap(station) {
  // Redirect to map page - the station will need to be selected manually or we could add a URL parameter
  window.location.href = DJANGO_URLS.map;
}

async function shareRating(btn, station, overall) {
  const text = `I rated ${station} ${overall}/5 on Metro Safe LA ‚≠ê`;
  if (navigator.share) {
    try { await navigator.share({ title: 'Metro Safe LA', text }); } catch {}
  } else {
    await navigator.clipboard.writeText(text);
    const orig = btn.innerHTML;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
    setTimeout(() => { btn.innerHTML = orig; }, 2000);
  }
}

// Confirmation Modal Functions
let confirmCallback = null;

function showConfirmModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel', isDanger = false) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const titleEl = document.getElementById('confirmModalTitle');
    const messageEl = document.getElementById('confirmModalMessage');
    const confirmBtn = document.getElementById('confirmModalConfirm');
    const cancelBtn = document.getElementById('confirmModalCancel');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    confirmBtn.textContent = confirmText;
    cancelBtn.textContent = cancelText;
    
    // Set button style
    confirmBtn.classList.remove('danger');
    if (isDanger) {
      confirmBtn.classList.add('danger');
    }
    
    // Store resolve function
    confirmCallback = resolve;
    
    // Show modal
    modal.classList.add('active');
  });
}

function closeConfirmModal() {
  const modal = document.getElementById('confirmModal');
  modal.classList.remove('active');
  if (confirmCallback) {
    confirmCallback(false);
    confirmCallback = null;
  }
}

function executeConfirmAction() {
  const modal = document.getElementById('confirmModal');
  modal.classList.remove('active');
  if (confirmCallback) {
    confirmCallback(true);
    confirmCallback = null;
  }
}

let deleteCardEl = null;
async function deleteRating(id, btn) {
  // Extract rating ID from the _id format (rating_123)
  const ratingId = id.replace('rating_', '');
  
  if (!ratingId || !ratingId.match(/^\d+$/)) {
    await showConfirmModal('Error', 'Invalid rating ID', 'OK', '', false);
    return;
  }
  
  const confirmed = await showConfirmModal(
    'Delete Rating',
    'Are you sure you want to delete this rating? This action cannot be undone.',
    'Delete',
    'Cancel',
    true
  );
  
  if (!confirmed) {
    return;
  }
  
  try {
    const response = await fetch(DJANGO_URLS.deleteRating, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ rating_id: parseInt(ratingId) })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // Remove from display
      deleteCardEl = btn.closest('.rating-card');
      if (deleteCardEl) {
        deleteCardEl.style.opacity = '0';
        deleteCardEl.style.transform = 'scale(0.95)';
        deleteCardEl.style.transition = 'all 0.25s ease';
        setTimeout(() => {
          deleteCardEl.remove();
          // Remove from allRatings array
          const index = allRatings.findIndex(r => r._id === id);
          if (index > -1) {
            allRatings.splice(index, 1);
          }
          applyFilters();
        }, 250);
      }
    } else {
      await showConfirmModal('Error', 'Failed to delete rating: ' + (data.message || 'Please try again.'), 'OK', '', false);
    }
  } catch (error) {
    await showConfirmModal('Error', 'Failed to delete rating. Please try again.', 'OK', '', false);
    console.error('Delete error:', error);
  }
}
function cancelDelete() {
  pendingDeleteId = null;
  deleteCardEl = null;
  document.getElementById('toast').classList.remove('show');
}
function confirmDelete() {
  // This function is kept for compatibility but deleteRating now handles deletion directly
  cancelDelete();
}

// Init
buildFilters();
applyFilters();

// Lightbox
function openLightbox(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.getElementById('lightboxImg').src = '';
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });
</script>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <img class="lightbox-img" id="lightboxImg" src="" alt="Full photo">
</div>
</body>
</html>