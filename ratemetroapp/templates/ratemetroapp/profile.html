<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Profile ‚Äî Metro Safe LA</title>
<script>
  (function(){var t=localStorage.getItem('ratemetro-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})();
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0d0d18;
    --surface: rgba(20, 20, 35, 0.88);
    --surface-light: rgba(28, 28, 48, 0.82);
    --accent: #f5c518;
    --accent-glow: rgba(245, 197, 24, 0.3);
    --danger: #ff3b30;
    --text-primary: #f0f0f5;
    --text-secondary: rgba(255, 255, 255, 0.55);
    --text-muted: rgba(255, 255, 255, 0.3);
    --border: rgba(255, 255, 255, 0.07);
  }

  [data-theme="light"] {
    --bg-dark: #f2f2f7;
    --surface: rgba(255, 255, 255, 0.95);
    --surface-light: rgba(240, 240, 245, 0.9);
    --accent: #d4a017;
    --accent-glow: rgba(212, 160, 23, 0.2);
    --danger: #ff3b30;
    --text-primary: #1c1c1e;
    --text-secondary: rgba(0, 0, 0, 0.55);
    --text-muted: rgba(0, 0, 0, 0.35);
    --border: rgba(0, 0, 0, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  /* Background grid texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(245,197,24,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(245,197,24,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ Top Nav ‚îÄ‚îÄ */
  .nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    animation: slideDown 0.4s ease both;
  }

  .nav-back {
    width: 40px; height: 40px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
  }
  .nav-back:hover { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
  .nav-back svg { width: 16px; height: 16px; stroke: var(--text-secondary); fill: none; stroke-width: 2.5; }
  .nav-back:hover svg { stroke: var(--accent); }

  .nav-title {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--text-primary);
  }

  .nav-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-action-btn {
    padding: 7px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
  }
  .nav-action-btn:hover { border-color: var(--accent); color: var(--accent); }
  .nav-action-btn.primary {
    background: var(--accent);
    color: var(--bg-dark);
    border-color: var(--accent);
  }
  .nav-action-btn.primary:hover { box-shadow: 0 0 16px var(--accent-glow); transform: translateY(-1px); }

  /* ‚îÄ‚îÄ Page Layout ‚îÄ‚îÄ */
  .page {
    padding-top: 72px;
    padding-bottom: 40px;
    max-width: 560px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  /* ‚îÄ‚îÄ Hero Card ‚îÄ‚îÄ */
  .hero-card {
    margin: 20px 16px 0;
    background: var(--surface);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px 24px 24px;
    position: relative;
    overflow: hidden;
    animation: slideUp 0.5s ease 0.1s both;
  }

  .hero-card::before {
    content: '';
    position: absolute;
    top: -60px; right: -60px;
    width: 180px; height: 180px;
    background: radial-gradient(circle, rgba(245,197,24,0.08), transparent 70%);
    pointer-events: none;
  }

  .hero-top {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
  }

  .avatar-wrap {
    position: relative;
    flex-shrink: 0;
  }
  .avatar {
    width: 72px; height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(245,197,24,0.3), rgba(245,197,24,0.08));
    border: 2px solid rgba(245,197,24,0.4);
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
    box-shadow: 0 0 20px rgba(245,197,24,0.15);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .avatar:hover { box-shadow: 0 0 30px rgba(245,197,24,0.3); border-color: var(--accent); }
  .avatar-edit {
    position: absolute;
    bottom: 0; right: 0;
    width: 22px; height: 22px;
    background: var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  .avatar-edit svg { width: 11px; height: 11px; stroke: #0a0a0f; fill: none; stroke-width: 2.5; }

  .hero-info { flex: 1; min-width: 0; padding-top: 4px; }
  .hero-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }
  .hero-handle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: rgba(245,197,24,0.1);
    border: 1px solid rgba(245,197,24,0.25);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .hero-badge .badge-dot {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse-dot 2s ease infinite;
  }

  .hero-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .stat-cell {
    background: rgba(255,255,255,0.03);
    padding: 14px 12px;
    text-align: center;
    transition: background 0.2s;
    cursor: default;
  }
  .stat-cell:hover { background: rgba(255,255,255,0.06); }
  .stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 500;
    color: var(--accent);
    margin-bottom: 3px;
  }
  .stat-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  /* ‚îÄ‚îÄ Section Cards ‚îÄ‚îÄ */
  .section-card {
    margin: 12px 16px 0;
    background: var(--surface);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    animation: slideUp 0.5s ease both;
  }
  .section-card:nth-child(3) { animation-delay: 0.15s; }
  .section-card:nth-child(4) { animation-delay: 0.2s; }
  .section-card:nth-child(5) { animation-delay: 0.25s; }
  .section-card:nth-child(6) { animation-delay: 0.3s; }
  .section-card:nth-child(7) { animation-delay: 0.35s; }

  .section-header {
    padding: 14px 16px 10px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ Edit Form ‚îÄ‚îÄ */
  .form-field {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.15s;
    cursor: pointer;
  }
  .form-field:last-child { border-bottom: none; }
  .form-field:hover { background: rgba(255,255,255,0.03); }

  .field-icon {
    width: 34px; height: 34px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .field-icon svg { width: 16px; height: 16px; stroke: var(--text-muted); fill: none; stroke-width: 2; }

  .field-body { flex: 1; min-width: 0; }
  .field-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 0.4px;
    text-transform: uppercase;
    margin-bottom: 3px;
  }
  .field-input {
    width: 100%;
    background: none;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    caret-color: var(--accent);
    padding: 0;
  }
  .field-input::placeholder { color: var(--text-muted); font-weight: 400; }
  .field-chevron {
    width: 14px; height: 14px;
    stroke: var(--text-muted);
    fill: none;
    stroke-width: 2;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .form-field:hover .field-chevron { opacity: 1; }

  /* ‚îÄ‚îÄ My Ratings ‚îÄ‚îÄ */
  .rating-row {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.15s;
    cursor: pointer;
  }
  .rating-row:last-child { border-bottom: none; }
  .rating-row:hover { background: rgba(255,255,255,0.03); }

  .rating-color-bar {
    width: 4px;
    height: 36px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  .rating-station-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .rating-meta {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .rating-stars-row {
    display: flex;
    gap: 1px;
    align-items: center;
    flex-shrink: 0;
  }
  .rating-stars-row .star {
    font-size: 12px;
    color: var(--text-muted);
  }
  .rating-stars-row .star.filled { color: var(--accent); }

  .empty-state {
    padding: 32px 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
    line-height: 1.6;
  }
  .empty-state .empty-icon {
    font-size: 28px;
    margin-bottom: 8px;
    opacity: 0.5;
  }

  /* ‚îÄ‚îÄ Settings Rows ‚îÄ‚îÄ */
  .setting-row {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
  }
  .setting-row:last-child { border-bottom: none; }
  .setting-row:hover { background: rgba(255,255,255,0.03); }
  .setting-row.danger:hover { background: rgba(255,59,48,0.05); }
  .setting-row.danger .setting-label { color: var(--danger); }
  .setting-row.danger .field-icon svg { stroke: var(--danger); }

  .setting-label {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
  }
  .setting-value {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    margin-right: 4px;
  }

  /* Toggle */
  .toggle-wrap { flex-shrink: 0; }
  .toggle {
    width: 44px; height: 26px;
    background: rgba(255,255,255,0.1);
    border-radius: 13px;
    position: relative;
    cursor: pointer;
    transition: background 0.25s ease;
    border: none;
    outline: none;
  }
  .toggle.on { background: var(--accent); }
  .toggle::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 20px; height: 20px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.25s ease;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
  .toggle.on::after { transform: translateX(18px); }

  /* ‚îÄ‚îÄ Activity Chart ‚îÄ‚îÄ */
  .chart-wrap {
    padding: 16px;
  }
  .chart-label {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .activity-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 3px;
  }
  .activity-col {
    display: flex;
    flex-direction: column;
    gap: 3px;
    align-items: center;
  }
  .activity-cell {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 3px;
    background: rgba(245,197,24,0.06);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  .activity-cell:hover { transform: scale(1.3); z-index: 1; }
  .activity-cell.l1 { background: rgba(245,197,24,0.15); }
  .activity-cell.l2 { background: rgba(245,197,24,0.3); }
  .activity-cell.l3 { background: rgba(245,197,24,0.55); }
  .activity-cell.l4 { background: rgba(245,197,24,0.8); }
  .chart-months {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 3px;
    margin-top: 6px;
  }
  .chart-month {
    font-size: 9px;
    color: var(--text-muted);
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0;
  }

  /* ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ */
  .achievements-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding: 16px;
  }
  .achievement {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  .achievement:hover { transform: scale(1.05); }
  .achievement-icon {
    width: 52px; height: 52px;
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    transition: all 0.2s ease;
  }
  .achievement.earned .achievement-icon {
    background: rgba(245,197,24,0.1);
    border-color: rgba(245,197,24,0.25);
    box-shadow: 0 0 16px rgba(245,197,24,0.1);
  }
  .achievement:hover .achievement-icon { border-color: rgba(245,197,24,0.4); }
  .achievement.locked { opacity: 0.35; }
  .achievement-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 0.2px;
    line-height: 1.3;
  }
  .achievement.earned .achievement-label { color: var(--text-secondary); }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes slideDown { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* Edit mode */
  .editing .field-input { border-bottom: 1px solid rgba(245,197,24,0.3); padding-bottom: 2px; }
  .editing .field-input:focus { border-bottom-color: var(--accent); }

  @media (max-width: 480px) {
    .achievements-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .achievement-icon { width: 44px; height: 44px; font-size: 18px; border-radius: 12px; }
  }

  /* Confirmation Modal */
  .confirm-modal {
    position: fixed; inset: 0; z-index: 4000;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .confirm-modal.active { opacity: 1; pointer-events: auto; }
  .confirm-modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    position: relative;
    transform: scale(0.95);
    transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }
  .confirm-modal.active .confirm-modal-content { transform: scale(1); }
  .confirm-modal-header {
    margin-bottom: 24px;
  }
  .confirm-modal-header h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .confirm-modal-header p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .confirm-modal-actions {
    display: flex;
    gap: 12px;
  }
  .confirm-modal-btn {
    flex: 1;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .confirm-modal-btn.cancel {
    background: var(--surface-light);
    color: var(--text-primary);
    border-color: var(--border);
  }
  .confirm-modal-btn.cancel:hover {
    border-color: var(--text-muted);
    background: rgba(255, 255, 255, 0.1);
  }
  .confirm-modal-btn.confirm {
    background: var(--accent);
    color: var(--bg-dark);
    border-color: var(--accent);
  }
  .confirm-modal-btn.confirm:hover {
    background: #f5d030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 197, 24, 0.3);
  }
  .confirm-modal-btn.danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }
  .confirm-modal-btn.danger:hover {
    background: #ff5252;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
  }

  /* ‚îÄ‚îÄ Light Mode Overrides ‚îÄ‚îÄ */
  [data-theme="light"] body::before {
    background-image:
      linear-gradient(rgba(0,0,0,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,0,0,0.04) 1px, transparent 1px);
  }
  [data-theme="light"] .nav {
    background: rgba(242,242,247,0.92);
    border-bottom-color: rgba(0,0,0,0.08);
  }
  [data-theme="light"] .nav-back { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
  [data-theme="light"] .nav-back svg { stroke: rgba(0,0,0,0.5); }
  [data-theme="light"] .nav-action-btn { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); color: var(--text-secondary); }
  [data-theme="light"] .nav-action-btn:hover { border-color: var(--accent); color: var(--accent); }
  [data-theme="light"] .nav-action-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  [data-theme="light"] .hero-card { background: var(--surface); box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  [data-theme="light"] .hero-card::before { background: radial-gradient(circle, rgba(212,160,23,0.06), transparent 70%); }
  [data-theme="light"] .avatar { background: linear-gradient(135deg, rgba(212,160,23,0.12), rgba(212,160,23,0.04)); border-color: rgba(212,160,23,0.25); }
  [data-theme="light"] .stat-cell { background: rgba(0,0,0,0.025); }
  [data-theme="light"] .stat-cell:hover { background: rgba(0,0,0,0.05); }
  [data-theme="light"] .section-card { background: var(--surface); box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  [data-theme="light"] .form-field:hover { background: rgba(0,0,0,0.03); }
  [data-theme="light"] .field-icon { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
  [data-theme="light"] .field-icon svg { stroke: var(--text-muted); }
  [data-theme="light"] .field-chevron { stroke: var(--text-muted); }
  [data-theme="light"] .setting-row svg { stroke: var(--text-secondary); }
  [data-theme="light"] .setting-row.danger svg { stroke: var(--danger); }
  [data-theme="light"] .edit-input { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.1); color: var(--text-primary); }
  [data-theme="light"] .edit-input:focus { border-color: var(--accent); background: rgba(212,160,23,0.04); }
  [data-theme="light"] .rating-row:hover { background: rgba(0,0,0,0.03); }
  [data-theme="light"] .setting-row:hover { background: rgba(0,0,0,0.03); }
  [data-theme="light"] .setting-row.danger:hover { background: rgba(255,59,48,0.04); }
  [data-theme="light"] .toggle { background: rgba(0,0,0,0.15); }
  [data-theme="light"] .toggle.on { background: var(--accent); }
  [data-theme="light"] .toggle::after { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  [data-theme="light"] .activity-cell { background: rgba(212,160,23,0.08); }
  [data-theme="light"] .activity-cell.l1 { background: rgba(212,160,23,0.18); }
  [data-theme="light"] .activity-cell.l2 { background: rgba(212,160,23,0.35); }
  [data-theme="light"] .activity-cell.l3 { background: rgba(212,160,23,0.55); }
  [data-theme="light"] .activity-cell.l4 { background: rgba(212,160,23,0.8); }
  [data-theme="light"] .achievement-icon { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.08); }
  [data-theme="light"] .achievement.earned .achievement-icon { background: rgba(212,160,23,0.1); border-color: rgba(212,160,23,0.2); }
  [data-theme="light"] .confirm-modal-overlay { background: rgba(0,0,0,0.3); }
  [data-theme="light"] .confirm-modal-content { background: var(--surface); box-shadow: 0 24px 64px rgba(0,0,0,0.15); border-color: var(--border); }
  [data-theme="light"] .confirm-modal-btn.secondary { background: rgba(0,0,0,0.05); color: var(--text-secondary); border-color: var(--border); }
  [data-theme="light"] .confirm-modal-btn.confirm { color: #fff; }
  [data-theme="light"] .confirm-modal-btn.danger { color: #fff; }
  [data-theme="light"] .toast { background: rgba(0,0,0,0.8); color: #fff; }
</style>
</head>
<body>

<!-- Nav -->
<nav class="nav">
  <a class="nav-back" href="#" id="navBackBtn">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
  </a>
  <div class="nav-title">My Profile</div>
  <div class="nav-right">
    <button class="nav-action-btn" id="editToggleBtn" onclick="toggleEdit()">Edit</button>
    <button class="nav-action-btn primary" id="saveBtn" onclick="saveProfile()" style="display:none">Save</button>
  </div>
</nav>

<div class="page">

  <!-- Hero Card -->
  <div class="hero-card">
    <div class="hero-top">
      <div class="avatar-wrap">
        <div class="avatar" id="avatarEl">TS</div>
        <div class="avatar-edit" id="avatarEditBtn" style="display:none;">
          <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="handleAvatarChange(event)">
      </div>
      <div class="hero-info">
        <div class="hero-name" id="displayName">{{ full_name|default:user.username }}</div>
        <div class="hero-handle" id="displayHandle">@{{ user.username }}</div>
        <div class="hero-badge"><div class="badge-dot"></div>Active Contributor</div>
      </div>
    </div>
    <div class="hero-stats">
      <div class="stat-cell">
        <div class="stat-value" id="statRatings">{{ ratings_count|default:0 }}</div>
        <div class="stat-label">Ratings</div>
      </div>
      <div class="stat-cell">
        <div class="stat-value" id="statStations">{{ stations_count|default:0 }}</div>
        <div class="stat-label">Stations</div>
      </div>
      <div class="stat-cell">
        <div class="stat-value" id="statStreak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>
  </div>

  <!-- Edit Profile -->
  <div class="section-card" id="editCard">
    <div class="section-header">Personal Info</div>

    <div class="form-field">
      <div class="field-icon">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a6 6 0 0 1 12 0v1"/></svg>
      </div>
      <div class="field-body">
        <div class="field-label">Full Name</div>
        <input class="field-input" id="inputName" type="text" value="{{ full_name|default:user.username }}" readonly placeholder="Your name" />
      </div>
      <svg class="field-chevron" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </div>

    <div class="form-field">
      <div class="field-icon">
        <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      </div>
      <div class="field-body">
        <div class="field-label">Email</div>
        <input class="field-input" id="inputEmail" type="email" value="{{ email|default:'' }}" readonly placeholder="your@email.com" />
      </div>
      <svg class="field-chevron" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </div>

    <div class="form-field">
      <div class="field-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="field-body">
        <div class="field-label">Username</div>
        <input class="field-input" id="inputUsername" type="text" value="{{ user.username }}" readonly placeholder="@username" />
      </div>
      <svg class="field-chevron" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </div>

    <div class="form-field">
      <div class="field-icon">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      </div>
      <div class="field-body">
        <div class="field-label">Home Station</div>
        <input class="field-input" id="inputStation" type="text" value="{% if user_profile.home_station %}{{ user_profile.home_station.name }}{% endif %}" readonly placeholder="Pick a station" />
      </div>
      <svg class="field-chevron" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18"/></svg>
    </div>
  </div>

  <!-- Activity Chart -->
  <div class="section-card">
    <div class="section-header">Rating Activity</div>
    <div class="chart-wrap">
      <div class="chart-label">Past 12 Months</div>
      <div class="activity-grid" id="activityGrid"></div>
      <div class="chart-months" id="chartMonths"></div>
    </div>
  </div>

  <!-- Achievements -->
  <div class="section-card">
    <div class="section-header">Achievements</div>
    <div class="achievements-grid">
      <div class="achievement {% if achievements.first_star %}earned{% else %}locked{% endif %}" title="First rating submitted">
        <div class="achievement-icon">‚≠ê</div>
        <div class="achievement-label">First Star</div>
      </div>
      <div class="achievement {% if achievements.explorer %}earned{% else %}locked{% endif %}" title="Rated 10 stations">
        <div class="achievement-icon">üó∫Ô∏è</div>
        <div class="achievement-label">Explorer</div>
      </div>
      <div class="achievement {% if achievements.on_fire %}earned{% else %}locked{% endif %}" title="5-day rating streak">
        <div class="achievement-icon">üî•</div>
        <div class="achievement-label">On Fire</div>
      </div>
      <div class="achievement {% if achievements.champion %}earned{% else %}locked{% endif %}" title="Rate 25 stations">
        <div class="achievement-icon">üèÜ</div>
        <div class="achievement-label">Champion</div>
      </div>
      <div class="achievement {% if achievements.line_rider %}earned{% else %}locked{% endif %}" title="Rate all A Line stations">
        <div class="achievement-icon">üöÜ</div>
        <div class="achievement-label">Line Rider</div>
      </div>
      <div class="achievement {% if achievements.photog %}earned{% else %}locked{% endif %}" title="Submit 3 photos">
        <div class="achievement-icon">üì∏</div>
        <div class="achievement-label">Photog</div>
      </div>
      <div class="achievement {% if achievements.regular %}earned{% else %}locked{% endif %}" title="Rate same station 5 times">
        <div class="achievement-icon">üìç</div>
        <div class="achievement-label">Regular</div>
      </div>
      <div class="achievement {% if achievements.diamond %}earned{% else %}locked{% endif %}" title="30-day streak">
        <div class="achievement-icon">üíé</div>
        <div class="achievement-label">Diamond</div>
      </div>
    </div>
  </div>

  <!-- My Ratings -->
  <div class="section-card">
    <div class="section-header">Recent Ratings</div>
    <div id="myRatingsList">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Settings -->
  <div class="section-card">
    <div class="section-header">Preferences</div>

    <div class="setting-row" onclick="toggleSetting(this)">
      <div class="field-icon">
        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <span class="setting-label">Anonymous Ratings</span>
      <button class="toggle" onclick="event.stopPropagation(); this.classList.toggle('on')"></button>
    </div>

  </div>

  <!-- Account -->
  <div class="section-card">
    <div class="section-header">Account</div>
    <div class="setting-row" id="signOutBtn" data-action="signout">
      <div class="field-icon" style="border-color: rgba(255,59,48,0.2); background: rgba(255,59,48,0.06);">
        <svg viewBox="0 0 24 24" style="stroke: var(--danger)"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </div>
      <span class="setting-label" style="color: var(--danger);">Sign Out</span>
      <svg class="field-chevron" viewBox="0 0 24 24" style="opacity:1; stroke: rgba(255,59,48,0.4)"><polyline points="9 6 15 12 9 18"/></svg>
    </div>
  </div>

  <!-- Delete Account -->
  <div class="section-card" style="margin-bottom: 0;">
    <div class="section-header">Delete Account</div>
    <div class="setting-row danger" id="deleteAccountBtn" data-action="deleteaccount">
      <div class="field-icon" style="border-color: rgba(255,59,48,0.2); background: rgba(255,59,48,0.06);">
        <svg viewBox="0 0 24 24" style="stroke: var(--danger)"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </div>
      <span class="setting-label" style="color: var(--danger);">Delete Account</span>
      <svg class="field-chevron" viewBox="0 0 24 24" style="opacity:1; stroke: rgba(255,59,48,0.4)"><polyline points="9 6 15 12 9 18"/></svg>
    </div>
  </div>

</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-modal-content">
    <div class="confirm-modal-header">
      <h3 id="confirmModalTitle">Confirm Action</h3>
      <p id="confirmModalMessage">Are you sure you want to proceed?</p>
    </div>
    <div class="confirm-modal-actions">
      <button class="confirm-modal-btn cancel" id="confirmModalCancel" type="button">
        Cancel
      </button>
      <button class="confirm-modal-btn confirm" id="confirmModalConfirm" type="button">
        Confirm
      </button>
    </div>
  </div>
</div>

<script>
// Django URLs injected for JavaScript
const DJANGO_URLS = {
  map: '{% url "ratemetroapp:map" %}',
  profile: '{% url "ratemetroapp:profile" %}',
  myRatings: '{% url "ratemetroapp:my_ratings" %}',
  settings: '{% url "ratemetroapp:settings" %}',
  signIn: '{% url "ratemetroapp:sign_in" %}',
  checkAuth: '{% url "ratemetroapp:check_auth" %}',
  logout: '{% url "ratemetroapp:api_logout" %}',
  deleteAccount: '{% url "ratemetroapp:api_delete_account" %}',
  updateProfile: '{% url "ratemetroapp:api_update_profile" %}',
};

// Helper function to get CSRF token
function getCSRFToken() {
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  if (token) return token.value;
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  return '';
}

// Authentication state
let isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
let currentUsername = '{{ user.username|default:"" }}';

// Check authentication status
async function checkAuthentication() {
  try {
    const response = await fetch(DJANGO_URLS.checkAuth);
    const data = await response.json();
    isAuthenticated = data.is_authenticated;
    currentUsername = data.username || '';
    return isAuthenticated;
  } catch (error) {
    console.error('Auth check failed:', error);
    return false;
  }
}

// Confirmation Modal Functions
let confirmCallback = null;

function showConfirmModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel', isDanger = false) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const titleEl = document.getElementById('confirmModalTitle');
    const messageEl = document.getElementById('confirmModalMessage');
    const confirmBtn = document.getElementById('confirmModalConfirm');
    const cancelBtn = document.getElementById('confirmModalCancel');
    
    if (!modal || !titleEl || !messageEl || !confirmBtn || !cancelBtn) {
      console.error('Modal elements not found');
      resolve(false);
      return;
    }
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    confirmBtn.textContent = confirmText;
    
    // Show/hide cancel button based on cancelText
    if (cancelText && cancelText.trim() !== '') {
      cancelBtn.textContent = cancelText;
      cancelBtn.style.display = 'flex';
    } else {
      cancelBtn.style.display = 'none';
    }
    
    // Set button style
    confirmBtn.classList.remove('danger');
    if (isDanger) {
      confirmBtn.classList.add('danger');
    }
    
    // Store resolve function
    confirmCallback = resolve;
    
    // Show modal
    modal.classList.add('active');
  });
}

function closeConfirmModal() {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.classList.remove('active');
  }
  if (confirmCallback) {
    confirmCallback(false);
    confirmCallback = null;
  }
}

function executeConfirmAction() {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.classList.remove('active');
  }
  if (confirmCallback) {
    confirmCallback(true);
    confirmCallback = null;
  }
}

// Modal functions will be made globally accessible after all handlers are defined

// Add backdrop click to close modal (run immediately ‚Äî DOM is already loaded since script is at end of body)
(function() {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeConfirmModal();
      }
    });
  }
  
  const confirmBtn = document.getElementById('confirmModalConfirm');
  const cancelBtn = document.getElementById('confirmModalCancel');
  
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      executeConfirmAction();
    });
  }
  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeConfirmModal();
    });
  }
})();

// Prompt user to sign in
async function promptSignIn(action = 'save your data') {
  const confirmed = await showConfirmModal(
    'Sign In Required',
    `You need to sign in to ${action}. Would you like to sign in now?`,
    'Sign In',
    'Cancel'
  );
  
  if (confirmed) {
    window.location.href = DJANGO_URLS.signIn + '?next=' + encodeURIComponent(window.location.pathname);
    return true;
  }
  return false;
}
// ‚îÄ‚îÄ Activity Grid ‚îÄ‚îÄ
const months = ['F','M','A','M','J','J','A','S','O','N','D','J'];
const monthsFull = ['Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan'];
const gridEl = document.getElementById('activityGrid');
const monthsEl = document.getElementById('chartMonths');

// Load activity data from server
const activityData = {{ activity_json|safe }};

months.forEach((m, mi) => {
  const col = document.createElement('div');
  col.className = 'activity-col';
  
  // Get activity count for this month
  const monthCount = activityData[mi] || 0;
  
  // Calculate level based on count (0-4 levels)
  const maxLevel = Math.min(4, Math.floor(monthCount / 2)); // Scale: 0-2=level1, 3-4=level2, etc.
  
  for (let w = 0; w < 4; w++) {
    const cell = document.createElement('div');
    // Distribute activity across weeks (simple distribution)
    let lvl = 0;
    if (monthCount > 0) {
      const weekCount = Math.floor(monthCount / 4);
      const remainder = monthCount % 4;
      if (w < remainder) {
        lvl = Math.min(4, weekCount + 1);
      } else {
        lvl = Math.min(4, weekCount);
      }
    }
    
    cell.className = `activity-cell${lvl > 0 ? ' l' + lvl : ''}`;
    cell.title = `${monthsFull[mi]} ‚Äî ${monthCount > 0 ? monthCount + ' rating' + (monthCount !== 1 ? 's' : '') : 'No activity'}`;
    col.appendChild(cell);
  }
  gridEl.appendChild(col);

  const lbl = document.createElement('div');
  lbl.className = 'chart-month';
  lbl.textContent = m;
  monthsEl.appendChild(lbl);
});

// ‚îÄ‚îÄ Ratings List ‚îÄ‚îÄ
const lineColors = {
  A:'#0072bc', B:'#e3242b', C:'#58a738', D:'#a05da5',
  E:'#fdb913', G:'#f58220', J:'#b5a07e', K:'#e96bb0', L:'#c4a73f'
};

// Load ratings from server (database) instead of localStorage
const serverRatings = {{ ratings_json|safe }};
const listEl = document.getElementById('myRatingsList');

// Use server ratings, sorted by timestamp (already sorted by server)
const displayRatings = serverRatings.slice(0, 5);

function renderStars(n) {
  return Array.from({length:5}, (_,i) =>
    `<span class="star${i < n ? ' filled' : ''}">‚òÖ</span>`
  ).join('');
}

if (displayRatings.length === 0) {
  listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">‚≠ê</div>No ratings yet.<br>Start rating stations to see them here.</div>`;
} else {
  displayRatings.forEach((r, i) => {
    const overall = (r.safety > 0 && r.cleanliness > 0) ? Math.round((r.safety + r.cleanliness) / 2) : (r.safety || r.cleanliness || 0);
    const date = new Date(r.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const lineKey = r.line || 'A';
    const color = lineColors[lineKey] || '#f5c518';
    const row = document.createElement('div');
    row.className = 'rating-row';
    row.innerHTML = `
      <div class="rating-color-bar" style="background:${color}"></div>
      <div style="flex:1;min-width:0">
        <div class="rating-station-name">${r.station}</div>
        <div class="rating-meta">${date} ¬∑ ${r.staff ? (r.staff === 'yes' ? 'üëÆ Staff seen' : 'No staff') : ''}</div>
      </div>
      <div class="rating-stars-row">${renderStars(overall)}</div>
    `;
    listEl.appendChild(row);
  });

  // Stats are already set by server template variables, no need to update here
}

// ‚îÄ‚îÄ Edit Mode ‚îÄ‚îÄ
let editing = false;
let hasUnsavedChanges = false;
let originalValues = {};
let originalAvatar = null;
let newAvatarData = null;
let newAvatarFile = null;
const editInputs = ['inputName','inputEmail','inputUsername','inputStation'];

// Store original values when entering edit mode
function storeOriginalValues() {
  originalValues = {};
  editInputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) originalValues[id] = el.value;
  });
  // Store original avatar state
  const avatarEl = document.getElementById('avatarEl');
  originalAvatar = {
    isImage: avatarIsImage,
    imageUrl: avatarEl.style.backgroundImage || '',
    text: avatarEl.textContent || ''
  };
  newAvatarData = null;
  newAvatarFile = null;
}

// Check if values have changed
function checkForChanges() {
  hasUnsavedChanges = false;
  editInputs.forEach(id => {
    const el = document.getElementById(id);
    if (el && originalValues[id] !== undefined && el.value !== originalValues[id]) {
      hasUnsavedChanges = true;
    }
  });
  // Check avatar changes
  if (newAvatarData !== null || newAvatarFile !== null) {
    hasUnsavedChanges = true;
  }
  return hasUnsavedChanges;
}

async function toggleEdit() {
  const btn = document.getElementById('editToggleBtn');
  const saveBtn = document.getElementById('saveBtn');
  const card = document.getElementById('editCard');

  if (editing) {
    // Exiting edit mode - check for unsaved changes
    if (checkForChanges()) {
      const confirmed = await showConfirmModal(
        'Unsaved Changes',
        'You have unsaved changes. Are you sure you want to cancel?',
        'Discard Changes',
        'Keep Editing'
      );
      if (!confirmed) {
        return; // User wants to stay in edit mode
      }
    }
    // Cancel edit mode - restore original values
    editing = false;
    editInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.setAttribute('readonly', true);
        // Restore original values
        if (originalValues[id] !== undefined) {
          el.value = originalValues[id];
        }
      }
    });
    // Restore original avatar
    if (originalAvatar) {
      const avatarEl = document.getElementById('avatarEl');
      avatarIsImage = originalAvatar.isImage;
      if (originalAvatar.isImage && originalAvatar.imageUrl) {
        avatarEl.style.backgroundImage = originalAvatar.imageUrl;
        avatarEl.style.backgroundSize = 'cover';
        avatarEl.style.backgroundPosition = 'center';
        avatarEl.textContent = '';
      } else {
        avatarEl.style.backgroundImage = '';
        avatarEl.textContent = originalAvatar.text;
      }
      newAvatarData = null;
      newAvatarFile = null;
    }
    // Hide avatar edit button
    document.getElementById('avatarEditBtn').style.display = 'none';
    document.getElementById('avatarEl').style.cursor = 'default';
    btn.textContent = 'Edit';
    saveBtn.style.display = 'none';
    card.classList.remove('editing');
    hasUnsavedChanges = false;
  } else {
    // Entering edit mode
    editing = true;
    storeOriginalValues();
    editInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.removeAttribute('readonly');
        if (id === 'inputName') el.focus();
        // Track changes
        el.addEventListener('input', checkForChanges);
      }
    });
    // Show avatar edit button and make avatar clickable
    document.getElementById('avatarEditBtn').style.display = 'flex';
    document.getElementById('avatarEl').style.cursor = 'pointer';
    btn.textContent = 'Cancel';
    saveBtn.style.display = 'block';
    card.classList.add('editing');
  }
}

async function saveProfile() {
  // Check authentication
  if (!isAuthenticated) {
    const authStatus = await checkAuthentication();
    if (!authStatus) {
      const wantsToSignIn = await promptSignIn('save your profile');
      if (wantsToSignIn) {
        return;
      }
      return;
    }
  }
  
  const name = document.getElementById('inputName').value.trim();
  const username = document.getElementById('inputUsername').value.trim();
  const email = document.getElementById('inputEmail').value.trim();
  const station = document.getElementById('inputStation').value.trim();
  
  // Build FormData for multipart upload (supports file + text)
  const formData = new FormData();
  formData.append('name', name);
  formData.append('username', username);
  formData.append('email', email);
  formData.append('station', station);
  
  // If avatar was changed, attach the actual file
  if (newAvatarFile) {
    formData.append('avatar', newAvatarFile);
  }
  
  try {
    const response = await fetch(DJANGO_URLS.updateProfile, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken()
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // Update displayed name
      if (name) {
        document.getElementById('displayName').textContent = data.full_name || name;
        if (!avatarIsImage) {
          const initials = name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
          document.getElementById('avatarEl').textContent = initials;
        }
      }
      
      // Update displayed username
      if (data.username) {
        const displayUsername = data.username.startsWith('@') ? data.username : '@' + data.username;
        document.getElementById('displayHandle').textContent = displayUsername;
      }
      
      // Update avatar from server URL
      if (data.avatar_url) {
        const avatarEl = document.getElementById('avatarEl');
        avatarIsImage = true;
        avatarEl.textContent = '';
        avatarEl.style.backgroundImage = `url(${data.avatar_url})`;
        avatarEl.style.backgroundSize = 'cover';
        avatarEl.style.backgroundPosition = 'center';
      }
      
      // Update original state
      const avatarEl = document.getElementById('avatarEl');
      originalAvatar = {
        isImage: avatarIsImage,
        imageUrl: avatarEl.style.backgroundImage,
        text: avatarEl.textContent
      };
      newAvatarData = null;
      newAvatarFile = null;
      
      hasUnsavedChanges = false;
      toggleEdit();
    } else {
      await showConfirmModal('Error', data.message || 'Failed to save profile.', 'OK', '', false);
    }
  } catch (error) {
    console.error('Save profile error:', error);
    await showConfirmModal('Error', 'An error occurred while saving your profile.', 'OK', '', false);
  }
}

// Warn before leaving page with unsaved changes
window.addEventListener('beforeunload', function(e) {
  if (hasUnsavedChanges && editing) {
    e.preventDefault();
    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// Back button and navigation handlers will be set up in DOMContentLoaded

// ‚îÄ‚îÄ Avatar ‚îÄ‚îÄ
let avatarIsImage = false;

// Load avatar from server on page load
(function() {
  const serverAvatarUrl = '{{ avatar_url|default:"" }}';
  if (serverAvatarUrl) {
    const avatarEl = document.getElementById('avatarEl');
    avatarIsImage = true;
    avatarEl.textContent = '';
    avatarEl.style.backgroundImage = `url(${serverAvatarUrl})`;
    avatarEl.style.backgroundSize = 'cover';
    avatarEl.style.backgroundPosition = 'center';
  }
})();

// Setup avatar edit button click handler
const avatarEditBtn = document.getElementById('avatarEditBtn');
const avatarEl = document.getElementById('avatarEl');
const avatarInput = document.getElementById('avatarInput');

if (avatarEditBtn && avatarInput) {
  avatarEditBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    if (editing) {
      avatarInput.click();
    }
  });
  
  avatarEl.addEventListener('click', function(e) {
    if (editing) {
      avatarInput.click();
    }
  });
}

function handleAvatarChange(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Check file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    showConfirmModal('File Too Large', 'Image size must be less than 5MB', 'OK', '', false);
    return;
  }
  
  // Store the actual file for upload
  newAvatarFile = file;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    avatarIsImage = true;
    newAvatarData = ev.target.result; // For preview only
    const av = document.getElementById('avatarEl');
    av.textContent = '';
    av.style.backgroundImage = `url(${ev.target.result})`;
    av.style.backgroundSize = 'cover';
    av.style.backgroundPosition = 'center';
    
    checkForChanges();
  };
  reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ Handlers ‚îÄ‚îÄ
// Define handleSignOut function
async function handleSignOut() {
  try {
    const confirmed = await showConfirmModal(
      'Sign Out',
      'Are you sure you want to sign out?',
      'Sign Out',
      'Cancel'
    );
    
    if (!confirmed) {
      return;
    }
    
    const response = await fetch(DJANGO_URLS.logout, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      const theme = localStorage.getItem('ratemetro-theme');
      const themePref = localStorage.getItem('ratemetro-theme-pref');
      localStorage.clear();
      if (theme) localStorage.setItem('ratemetro-theme', theme);
      if (themePref) localStorage.setItem('ratemetro-theme-pref', themePref);
      sessionStorage.clear();
      
      window.location.href = DJANGO_URLS.signIn;
    } else {
      await showConfirmModal('Error', 'Failed to sign out. Please try again.', 'OK', '', false);
    }
  } catch (error) {
    console.error('Sign out error:', error);
    const theme = localStorage.getItem('ratemetro-theme');
    const themePref = localStorage.getItem('ratemetro-theme-pref');
    localStorage.clear();
    if (theme) localStorage.setItem('ratemetro-theme', theme);
    if (themePref) localStorage.setItem('ratemetro-theme-pref', themePref);
    sessionStorage.clear();
    window.location.href = DJANGO_URLS.signIn;
  }
}

async function handleDeleteAccount() {
  try {
    const confirmed = await showConfirmModal(
      'Delete Account',
      'Are you sure you want to delete your account? This action cannot be undone and will permanently delete all your data.',
      'Delete Account',
      'Cancel',
      true
    );
    
    if (!confirmed) {
      return;
    }
    
    // Double confirmation
    const confirmed2 = await showConfirmModal(
      'Final Confirmation',
      'This will permanently delete your account and all your ratings. Are you absolutely sure?',
      'Yes, Delete Forever',
      'Cancel',
      true
    );
    
    if (!confirmed2) {
      return;
    }
    
    const response = await fetch(DJANGO_URLS.deleteAccount, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      const theme = localStorage.getItem('ratemetro-theme');
      const themePref = localStorage.getItem('ratemetro-theme-pref');
      localStorage.clear();
      if (theme) localStorage.setItem('ratemetro-theme', theme);
      if (themePref) localStorage.setItem('ratemetro-theme-pref', themePref);
      sessionStorage.clear();
      
      await showConfirmModal('Account Deleted', 'Your account has been deleted successfully.', 'OK', '', false);
      // Redirect to sign-in page after a delay
      setTimeout(() => {
        window.location.href = DJANGO_URLS.signIn;
      }, 1500);
    } else {
      await showConfirmModal('Error', 'Failed to delete account: ' + (data.message || 'Please try again.'), 'OK', '', false);
    }
  } catch (error) {
    console.error('Delete account error:', error);
    await showConfirmModal('Error', 'An error occurred while deleting your account. Please try again.', 'OK', '', false);
  }
}

// Make all functions globally accessible BEFORE DOMContentLoaded
// This ensures they're available when event listeners are set up
window.handleSignOut = handleSignOut;
window.handleDeleteAccount = handleDeleteAccount;
window.showConfirmModal = showConfirmModal;
window.closeConfirmModal = closeConfirmModal;
window.executeConfirmAction = executeConfirmAction;

// Set up all event listeners (run immediately ‚Äî DOM is already loaded since script is at end of body)
(function() {
  // Back button
  const navBackBtn = document.getElementById('navBackBtn');
  if (navBackBtn) {
    navBackBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (hasUnsavedChanges && editing) {
        const confirmed = await showConfirmModal(
          'Unsaved Changes',
          'You have unsaved changes. Are you sure you want to go back without saving?',
          'Discard Changes',
          'Stay on Page'
        );
        if (confirmed) {
          hasUnsavedChanges = false;
          window.location.href = DJANGO_URLS.map;
        }
      } else {
        window.location.href = DJANGO_URLS.map;
      }
    });
  }

  // Sign out button
  const signOutBtn = document.getElementById('signOutBtn');
  if (signOutBtn) {
    signOutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      handleSignOut();
    });
  }
  
  // Delete account button
  const deleteAccountBtn = document.getElementById('deleteAccountBtn');
  if (deleteAccountBtn) {
    deleteAccountBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      handleDeleteAccount();
    });
  }
})();

// Also intercept browser back button
window.addEventListener('popstate', async function(e) {
  if (hasUnsavedChanges && editing) {
    const confirmed = await showConfirmModal(
      'Unsaved Changes',
      'You have unsaved changes. Are you sure you want to leave without saving?',
      'Leave Page',
      'Stay on Page'
    );
    if (confirmed) {
      hasUnsavedChanges = false;
      window.history.back();
    } else {
      // Push state again to prevent navigation
      window.history.pushState(null, null, window.location.href);
    }
  }
});

function toggleSetting(row) { /* row click does nothing, toggle handles itself */ }
</script>
</body>
</html>