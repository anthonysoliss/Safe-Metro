<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Station Reviews ‚Äî Metro Safe LA</title>
<script>
  (function(){var t=localStorage.getItem('ratemetro-theme')||'dark';document.documentElement.setAttribute('data-theme',t);})();
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0d0d18;
    --surface: rgba(20, 20, 35, 0.88);
    --surface-light: rgba(28, 28, 48, 0.82);
    --accent: #f5c518;
    --accent-glow: rgba(245, 197, 24, 0.3);
    --danger: #ff3b30;
    --text-primary: #f0f0f5;
    --text-secondary: rgba(255, 255, 255, 0.55);
    --text-muted: rgba(255, 255, 255, 0.3);
    --border: rgba(255, 255, 255, 0.07);
  }

  [data-theme="light"] {
    --bg-dark: #f2f2f7;
    --surface: rgba(255, 255, 255, 0.95);
    --surface-light: rgba(240, 240, 245, 0.9);
    --accent: #d4a017;
    --accent-glow: rgba(212, 160, 23, 0.2);
    --danger: #ff3b30;
    --text-primary: #1c1c1e;
    --text-secondary: rgba(0, 0, 0, 0.55);
    --text-muted: rgba(0, 0, 0, 0.35);
    --border: rgba(0, 0, 0, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(245,197,24,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(245,197,24,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .page-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-dark);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 56px;
    display: flex;
    align-items: center;
    gap: 14px;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }

  .back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: var(--accent);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    padding: 6px 0;
    flex-shrink: 0;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }

  .back-btn svg {
    width: 18px; height: 18px;
    stroke: var(--accent);
    fill: none;
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
    flex-shrink: 0;
  }

  .header-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .header-count {
    font-size: 13px;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
  .page-content {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 20px 16px 40px;
  }

  /* ‚îÄ‚îÄ Summary card ‚îÄ‚îÄ */
  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  .summary-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 72px;
  }

  .summary-score-num {
    font-size: 42px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
  }

  .summary-score-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  .summary-divider {
    width: 1px;
    height: 56px;
    background: var(--border);
    flex-shrink: 0;
  }

  .summary-stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }

  .summary-stat {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-secondary);
  }

  .summary-stat-label { min-width: 90px; }
  .summary-stat-stars { display: flex; gap: 2px; }

  /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
  .filter-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
  }

  .filter-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .filter-select {
    padding: 7px 10px;
    background: var(--surface-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }

  .filter-select:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Rating cards ‚îÄ‚îÄ */
  .rating-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.4s ease forwards;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .card-user {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0d0d18;
    font-weight: 700;
    font-size: 16px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .card-avatar img {
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .card-user-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-date {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .card-stars { display: flex; gap: 2px; }

  .star { font-size: 14px; }
  .star.filled { color: var(--accent); }
  .star.empty { color: var(--text-muted); }

  .card-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .card-detail {
    font-size: 12px;
    color: var(--text-secondary);
    background: rgba(255,255,255,0.04);
    border-radius: 6px;
    padding: 4px 8px;
  }

  [data-theme="light"] .card-detail { background: rgba(0,0,0,0.04); }

  .card-description {
    margin-top: 10px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .card-photo {
    margin-top: 10px;
    border-radius: 8px;
    overflow: hidden;
  }

  .card-photo img, .card-photo video {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    display: block;
  }

  /* ‚îÄ‚îÄ States ‚îÄ‚îÄ */
  .loading-state, .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
    font-size: 15px;
  }

  .loading-spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
  .empty-sub { font-size: 13px; }

  /* ‚îÄ‚îÄ Mobile tweaks ‚îÄ‚îÄ */
  @media (max-width: 480px) {
    .page-header { padding: 0 14px; }
    .header-title { font-size: 14px; }
    .page-content { padding: 16px 12px 40px; }
    .summary-card { padding: 16px; gap: 12px; }
    .summary-score-num { font-size: 36px; }
  }
</style>
</head>
<body>

<header class="page-header">
  <button class="back-btn" id="backBtn" onclick="goBack()">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Map
  </button>
  <div class="header-title" id="headerTitle">Station Reviews</div>
  <div class="header-count" id="headerCount"></div>
</header>

<div class="page-content">
  <!-- Summary -->
  <div class="summary-card" id="summaryCard" style="display:none;">
    <div class="summary-score">
      <div class="summary-score-num" id="summaryAvg">‚Äî</div>
      <div class="summary-score-label">Overall</div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stats">
      <div class="summary-stat">
        <span class="summary-stat-label">üõ°Ô∏è Safety</span>
        <span class="summary-stat-stars" id="summarySafetyStars"></span>
        <span id="summarySafetyVal"></span>
      </div>
      <div class="summary-stat">
        <span class="summary-stat-label">üßπ Cleanliness</span>
        <span class="summary-stat-stars" id="summaryCleanStars"></span>
        <span id="summaryCleanVal"></span>
      </div>
      <div class="summary-stat" id="summaryStaffRow" style="display:none;">
        <span class="summary-stat-label">üëÆ Staff present</span>
        <span id="summaryStaffVal"></span>
      </div>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar" id="filterBar" style="display:none;">
    <span class="filter-label">Sort by</span>
    <select class="filter-select" id="sortSelect">
      <option value="newest">Newest first</option>
      <option value="oldest">Oldest first</option>
      <option value="highest">Highest rated</option>
      <option value="lowest">Lowest rated</option>
    </select>
  </div>

  <!-- Cards container -->
  <div id="cardsContainer">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      Loading reviews‚Ä¶
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const stationName = params.get('station') || '';
let allRatings = [];

// Set page title
document.getElementById('headerTitle').textContent = stationName || 'Station Reviews';
document.title = stationName ? `${stationName} Reviews ‚Äî Metro Safe LA` : 'Station Reviews ‚Äî Metro Safe LA';

function goBack() {
  if (document.referrer && document.referrer.includes(window.location.host)) {
    history.back();
  } else {
    window.location.href = '/';
  }
}

function renderStars(rating) {
  const full = Math.floor(rating);
  let html = '';
  for (let i = 0; i < 5; i++) {
    html += `<span class="star ${i < full ? 'filled' : 'empty'}">‚òÖ</span>`;
  }
  return html;
}

function renderCards(ratings) {
  const container = document.getElementById('cardsContainer');
  if (ratings.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚≠ê</div>
        <div class="empty-title">No reviews yet</div>
        <div class="empty-sub">Be the first to rate this station.</div>
      </div>`;
    return;
  }

  container.innerHTML = '';
  ratings.forEach((r, i) => {
    const date = new Date(r.timestamp);
    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'America/Los_Angeles' });
    const overall = r.safety > 0 && r.cleanliness > 0
      ? Math.round((r.safety + r.cleanliness) / 2)
      : (r.safety || r.cleanliness || 0);
    const displayName = r.username || 'Anonymous';
    const initial = displayName.charAt(0).toUpperCase();
    const avatarHtml = r.avatar_url
      ? `<img src="${r.avatar_url}" alt="${displayName}" onerror="this.style.display='none';this.parentElement.textContent='${initial}'">`
      : initial;

    const card = document.createElement('div');
    card.className = 'rating-card';
    card.style.animationDelay = `${i * 0.04}s`;
    card.innerHTML = `
      <div class="card-header">
        <div class="card-user">
          <div class="card-avatar">${avatarHtml}</div>
          <div>
            <div class="card-user-name">${displayName}</div>
            <div class="card-date">${dateStr}</div>
          </div>
        </div>
        <div class="card-stars">${renderStars(overall)}</div>
      </div>
      <div class="card-details">
        <span class="card-detail">üõ°Ô∏è Safety: ${r.safety}/5</span>
        <span class="card-detail">üßπ Clean: ${r.cleanliness}/5</span>
        ${r.staff ? `<span class="card-detail">üëÆ Staff: ${r.staff === 'yes' ? 'üëç Yes' : 'üëé No'}</span>` : ''}
      </div>
      ${r.description ? `<div class="card-description">${r.description}</div>` : ''}
      ${(r.media && r.media.length) ? r.media.map(m => `<div class="card-photo">${m.type === 'video' ? `<video src="${m.url}" controls playsinline></video>` : `<img src="${m.url}" alt="Photo">`}</div>`).join('') : ''}
    `;
    container.appendChild(card);
  });
}

function sortRatings(ratings, mode) {
  const copy = [...ratings];
  if (mode === 'newest') copy.sort((a, b) => b.timestamp - a.timestamp);
  else if (mode === 'oldest') copy.sort((a, b) => a.timestamp - b.timestamp);
  else if (mode === 'highest') copy.sort((a, b) => {
    const avgA = (a.safety + a.cleanliness) / 2;
    const avgB = (b.safety + b.cleanliness) / 2;
    return avgB - avgA;
  });
  else if (mode === 'lowest') copy.sort((a, b) => {
    const avgA = (a.safety + a.cleanliness) / 2;
    const avgB = (b.safety + b.cleanliness) / 2;
    return avgA - avgB;
  });
  return copy;
}

document.getElementById('sortSelect').addEventListener('change', function() {
  renderCards(sortRatings(allRatings, this.value));
});

async function loadReviews() {
  if (!stationName) {
    document.getElementById('cardsContainer').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üöá</div>
        <div class="empty-title">No station selected</div>
        <div class="empty-sub">Go back to the map and tap a station marker.</div>
      </div>`;
    return;
  }

  try {
    const res = await fetch(`/api/station-ratings/?station=${encodeURIComponent(stationName)}`);
    const data = await res.json();

    allRatings = data.ratings || [];
    const summary = data.summary || {};
    const count = summary.count || 0;

    // Header count
    document.getElementById('headerCount').textContent = count > 0 ? `${count} review${count !== 1 ? 's' : ''}` : '';

    // Summary card
    if (count > 0) {
      document.getElementById('summaryAvg').textContent = summary.avg || '‚Äî';
      document.getElementById('summarySafetyStars').innerHTML = renderStars(summary.safety || 0);
      document.getElementById('summarySafetyVal').textContent = summary.safety || '‚Äî';
      document.getElementById('summaryCleanStars').innerHTML = renderStars(summary.cleanliness || 0);
      document.getElementById('summaryCleanVal').textContent = summary.cleanliness || '‚Äî';
      if (summary.staff) {
        document.getElementById('summaryStaffVal').textContent = summary.staff;
        document.getElementById('summaryStaffRow').style.display = 'flex';
      }
      document.getElementById('summaryCard').style.display = 'flex';
      document.getElementById('filterBar').style.display = 'flex';
    }

    // Default sort: newest first
    renderCards(sortRatings(allRatings, 'newest'));

  } catch (e) {
    document.getElementById('cardsContainer').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚ö†Ô∏è</div>
        <div class="empty-title">Failed to load reviews</div>
        <div class="empty-sub">Check your connection and try again.</div>
      </div>`;
  }
}

loadReviews();
</script>
</body>
</html>
